This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: _legacy_v0_code/**, **/*.local
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  (dashboard)/
    analytics/
      page.tsx
    assets/
      page.tsx
    audience/
      [id]/
        page.tsx
      page.tsx
    campaigns/
      page.tsx
    dashboard/
      [id]/
        page.tsx
    settings/
      page.tsx
    layout.tsx
    page.tsx
  actions/
    ai-models.ts
    assets.ts
    campaigns.ts
    settings.ts
    subscriber-history.ts
    versions.ts
  api/
    analytics/
      route.ts
    copilot/
      route.ts
    debug/
      models/
        route.ts
    send/
      route.ts
    track/
      click/
        route.ts
      open/
        route.ts
      route.ts
    webhooks/
      subscribe/
        route.ts
  editor/
    layout.tsx
    page.tsx
  modular-editor/
    page.tsx
  globals.css
  layout.tsx
components/
  audience/
    subscriber-history-timeline.tsx
    tag-group-view.tsx
  campaign/
    analytics-section.tsx
    audience-card.tsx
    broadcast-confirm-dialog.tsx
    campaign-header.tsx
    campaign-launch-checks.tsx
    email-preview-card.tsx
    launchpad-card.tsx
    preflight-check-card.tsx
    send-test-card.tsx
    sender-identity-card.tsx
  campaigns/
    create-campaign-dialog.tsx
    new-round-modal.tsx
  dashboard/
    action-footer.tsx
    contender-card.tsx
    round-card.tsx
    tournament-dashboard.tsx
    tournament-header.tsx
  editor/
    asset-loader.tsx
    asset-picker-modal.tsx
    block-manager.tsx
    campaign-picker.tsx
    code-pane.tsx
    copilot-pane.tsx
    email-editor.tsx
    history-sheet.tsx
    modular-email-editor.tsx
    preview-pane.tsx
  ui/
    accordion.tsx
    alert-dialog.tsx
    alert.tsx
    aspect-ratio.tsx
    avatar.tsx
    badge.tsx
    breadcrumb.tsx
    button-group.tsx
    button.tsx
    calendar.tsx
    card.tsx
    carousel.tsx
    chart.tsx
    checkbox.tsx
    collapsible.tsx
    command.tsx
    context-menu.tsx
    dialog.tsx
    drawer.tsx
    dropdown-menu.tsx
    empty.tsx
    field.tsx
    form.tsx
    hover-card.tsx
    input-group.tsx
    input-otp.tsx
    input.tsx
    item.tsx
    kbd.tsx
    label.tsx
    menubar.tsx
    navigation-menu.tsx
    pagination.tsx
    popover.tsx
    progress.tsx
    radio-group.tsx
    resizable.tsx
    scroll-area.tsx
    select.tsx
    separator.tsx
    sheet.tsx
    sidebar.tsx
    skeleton.tsx
    slider.tsx
    sonner.tsx
    spinner.tsx
    switch.tsx
    table.tsx
    tabs.tsx
    textarea.tsx
    toast.tsx
    toaster.tsx
    toggle-group.tsx
    toggle.tsx
    tooltip.tsx
    use-mobile.tsx
    use-toast.ts
  app-sidebar.tsx
  campaigns-table.tsx
  dashboard-header.tsx
  metrics-cards.tsx
  quick-actions.tsx
  website-tracker.tsx
hooks/
  use-mobile.ts
  use-toast.ts
lib/
  supabase/
    client.ts
    schema.sql
    server.ts
  render-template.ts
  types.ts
  utils.ts
scripts/
  bulk-fix.js
  check-bucket.js
  check-bucket.ts
  check-campaign.js
  check-columns.js
  check-rpc.js
  check-schema.js
  debug-assets.js
  fix-campaign.js
  scan-campaigns.js
supabase/
  migrations/
    20260126_create_subscriber_events.sql
    20260127235000_create_app_settings.sql
    20260128004000_create_campaign_versions.sql
.gitignore
.repomixignore
all_campaigns.json
campaign_record.json
campaign_updated.json
next.config.mjs
package.json
postcss.config.mjs
recent_files.json
repomix.config.json
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/(dashboard)/audience/[id]/page.tsx">
import { createClient } from "@/lib/supabase/server"
import { SubscriberHistoryTimeline } from "@/components/audience/subscriber-history-timeline"
import { notFound } from "next/navigation"

export default async function SubscriberProfilePage({ params }: { params: { id: string } }) {
    const supabase = await createClient()
    const { data: subscriber } = await supabase
        .from("subscribers")
        .select("*")
        .eq("id", params.id)
        .single()

    if (!subscriber) notFound()

    return (
        <div className="p-6 max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Left Col: Profile Info */}
            <div className="lg:col-span-1 space-y-6">
                <div>
                    <h1 className="text-2xl font-bold">{subscriber.first_name} {subscriber.last_name}</h1>
                    <p className="text-muted-foreground">{subscriber.email}</p>
                </div>

                <div className="p-4 rounded-lg bg-card border border-border space-y-2">
                    <p className="text-sm"><span className="text-muted-foreground">Location:</span> {subscriber.location_city}, {subscriber.location_country}</p>
                    <p className="text-sm"><span className="text-muted-foreground">Status:</span> <span className="capitalize text-emerald-400">{subscriber.status}</span></p>
                </div>
            </div>

            {/* Right Col: The Timeline */}
            <div className="lg:col-span-2">
                <SubscriberHistoryTimeline subscriberId={subscriber.id} />
            </div>
        </div>
    )
}
</file>

<file path="app/(dashboard)/settings/page.tsx">
"use client"

import { useEffect, useState } from "react"
import { Save, Brain, CheckCircle2, Loader2 } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { useToast } from "@/hooks/use-toast"
import { getCompanyContext, saveCompanyContext } from "@/app/actions/settings"

export default function SettingsPage() {
    const [context, setContext] = useState("")
    const [loading, setLoading] = useState(true)
    const [saving, setSaving] = useState(false)
    const { toast } = useToast()

    useEffect(() => {
        getCompanyContext().then((data) => {
            setContext(data)
            setLoading(false)
        })
    }, [])

    const handleSave = async () => {
        setSaving(true)
        try {
            await saveCompanyContext(context)
            toast({
                title: "Brain Updated",
                description: "Your AI copilot has been updated with the new context.",
            })
        } catch (error) {
            toast({
                title: "Error",
                description: "Failed to save settings.",
                variant: "destructive",
            })
        } finally {
            setSaving(false)
        }
    }

    if (loading) {
        return <div className="p-8 flex items-center gap-2 text-muted-foreground"><Loader2 className="animate-spin" /> Loading brain...</div>
    }

    return (
        <div className="p-6 max-w-4xl mx-auto space-y-6">
            <div>
                <h1 className="text-2xl font-bold tracking-tight">Settings</h1>
                <p className="text-muted-foreground">Manage your global application configuration.</p>
            </div>

            <Card className="border-amber-500/20 bg-gradient-to-b from-amber-500/5 to-transparent">
                <CardHeader>
                    <div className="flex items-center gap-2">
                        <Brain className="h-5 w-5 text-amber-500" />
                        <CardTitle>AI Company Context</CardTitle>
                    </div>
                    <CardDescription>
                        This is the "System Brain" for your AI Copilot. Anything you write here will be injected
                        into every request, ensuring the AI knows your product, tone, and rules.
                    </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                    <Textarea
                        value={context}
                        onChange={(e) => setContext(e.target.value)}
                        className="min-h-[300px] font-mono text-sm bg-background/50 leading-relaxed"
                        placeholder="e.g. DreamPlay Pianos is a brand focused on..."
                    />

                    <div className="flex justify-end">
                        <Button onClick={handleSave} disabled={saving} className="gap-2 bg-amber-500 text-black hover:bg-amber-400">
                            {saving ? <Loader2 className="h-4 w-4 animate-spin" /> : <Save className="h-4 w-4" />}
                            {saving ? "Saving..." : "Save Context"}
                        </Button>
                    </div>
                </CardContent>
            </Card>
        </div>
    )
}
</file>

<file path="app/(dashboard)/layout.tsx">
import { AppSidebar } from "@/components/app-sidebar"
import { DashboardHeader } from "@/components/dashboard-header"

export default function DashboardLayout({
    children,
}: {
    children: React.ReactNode
}) {
    return (
        <div className="min-h-screen bg-background">
            <AppSidebar />
            <main className="pl-64">
                <DashboardHeader />
                {children}
            </main>
        </div>
    )
}
</file>

<file path="app/(dashboard)/page.tsx">
"use client"
import { useEffect, useState } from "react"
import { MetricsCards } from "@/components/metrics-cards"
import { QuickActions } from "@/components/quick-actions"
import { CampaignsTable } from "@/components/campaigns-table"
import { createClient } from "@/lib/supabase/client"
import { Campaign } from "@/lib/types"

export default function HomePage() {
    const [campaigns, setCampaigns] = useState<Campaign[]>([])
    const [loading, setLoading] = useState(true)
    const supabase = createClient()

    const fetchCampaigns = async () => {
        setLoading(true)
        const { data, error } = await supabase
            .from("campaigns")
            .select("*")
            .order("created_at", { ascending: false })

        if (data) setCampaigns(data)
        if (error) console.error("Error fetching campaigns:", error)

        setLoading(false)
    }

    useEffect(() => {
        fetchCampaigns()
    }, [supabase])

    return (
        <div className="space-y-8 p-6">
            {/* Metrics Section */}
            <section>
                <h2 className="mb-4 text-sm font-medium uppercase tracking-wider text-muted-foreground">Overview</h2>
                <MetricsCards />
            </section>

            {/* Quick Actions */}
            <section>
                <h2 className="mb-4 text-sm font-medium uppercase tracking-wider text-muted-foreground">Quick Actions</h2>
                <QuickActions />
            </section>

            {/* Recent Campaigns */}
            <section>
                <CampaignsTable campaigns={campaigns} loading={loading} onRefresh={fetchCampaigns} />
            </section>
        </div>
    )
}
</file>

<file path="app/actions/ai-models.ts">
"use server"

import Anthropic from "@anthropic-ai/sdk";

export async function getAnthropicModels() {
    if (!process.env.ANTHROPIC_API_KEY) return []

    try {
        const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
        const list = await anthropic.models.list();

        // Return just the IDs, sorted to put newer ones first (typically higher numbers/dates)
        return list.data
            .map(m => m.id)
            .filter(id => id.includes("claude")) // Ensure we only get Claude models
            .sort((a, b) => b.localeCompare(a));
    } catch (e) {
        console.error("Failed to fetch Anthropic models:", e);
        return [];
    }
}
</file>

<file path="app/actions/assets.ts">
"use server"

import { createClient } from "@supabase/supabase-js"

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_KEY!

export async function deleteAsset(fileName: string) {
    const supabase = createClient(supabaseUrl, supabaseServiceKey)

    const { error } = await supabase.storage.from("email-assets").remove([fileName])

    if (error) {
        console.error("Error deleting asset:", error)
        return { success: false, error: error.message }
    }

    return { success: true }
}
</file>

<file path="app/actions/settings.ts">
"use server"

import { createClient } from "@/lib/supabase/server"
import { revalidatePath } from "next/cache"

export async function getCompanyContext() {
    const supabase = await createClient()

    const { data } = await supabase
        .from("app_settings")
        .select("value")
        .eq("key", "company_context")
        .single()

    return data?.value || ""
}

export async function saveCompanyContext(newContext: string) {
    const supabase = await createClient()

    const { error } = await supabase
        .from("app_settings")
        .upsert({
            key: "company_context",
            value: newContext,
            updated_at: new Date().toISOString()
        })

    if (error) {
        throw new Error(error.message)
    }

    revalidatePath("/settings")
    return { success: true }
}
</file>

<file path="app/actions/subscriber-history.ts">
"use server"

import { createClient } from "@/lib/supabase/server"

export async function getSubscriberHistory(subscriberId: string) {
    const supabase = await createClient()

    const { data, error } = await supabase
        .from('subscriber_events')
        .select(`
            *,
            campaigns ( name )
        `)
        .eq('subscriber_id', subscriberId)
        .order('created_at', { ascending: false })

    if (error) {
        console.error("Error fetching history:", error)
        return []
    }

    return data
}
</file>

<file path="app/actions/versions.ts">
"use server"

import { createClient } from "@/lib/supabase/server"

export async function saveVersion(campaignId: string, html: string, prompt: string) {
    const supabase = await createClient()
    await supabase.from('campaign_versions').insert({
        campaign_id: campaignId,
        html_content: html,
        prompt: prompt
    })
}

export async function getVersions(campaignId: string) {
    const supabase = await createClient()
    const { data } = await supabase
        .from('campaign_versions')
        .select('*')
        .order('created_at', { ascending: false })
    return data
}
</file>

<file path="app/api/analytics/route.ts">
import { createClient } from '@supabase/supabase-js'
import { NextResponse } from 'next/server'

// Initialize Supabase with Service Key to bypass RLS for admin stats
const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
)

export async function GET() {
    try {
        // 1. Fetch campaigns from database
        const { data: campaigns, error: campaignsError } = await supabase
            .from('campaigns')
            .select('*')
            .order('sent_at', { ascending: false }) // Newest first
            .limit(30) // Last 30 campaigns

        if (campaignsError) throw campaignsError

        // 2. Fetch subscribers count
        const { count: subscribersCount, error: subscribersError } = await supabase
            .from('subscribers')
            .select('*', { count: 'exact', head: true })

        if (subscribersError) throw subscribersError

        // 3. Calculate Totals for the "KPI Cards"
        const totals = campaigns.reduce((acc, camp) => ({
            revenue: acc.revenue + (camp.revenue_attributed || 0),
            sent: acc.sent + (camp.total_recipients || 0),
            opens: acc.opens + (camp.total_opens || 0),
            clicks: acc.clicks + (camp.total_clicks || 0),
        }), { revenue: 0, sent: 0, opens: 0, clicks: 0 })

        // 4. Format Data for the "Line Chart" (Group by Day)
        // This transforms the raw list into { day: 'Mon', opens: 120 } format
        const chartData = campaigns.slice().reverse().map(c => ({
            day: new Date(c.sent_at || c.created_at).toLocaleDateString('en-US', { weekday: 'short' }),
            opens: c.total_opens || 0,
            clicks: c.total_clicks || 0
        }))

        return NextResponse.json({
            kpi: {
                revenue: totals.revenue,
                subscribers: subscribersCount || 0,
                openRate: totals.sent > 0 ? (totals.opens / totals.sent) * 100 : 0,
                clickRate: totals.sent > 0 ? (totals.clicks / totals.sent) * 100 : 0
            },
            chart: chartData,
            recent: campaigns.slice(0, 5) // Top 5 recent (un-reversed)
        })

    } catch (error) {
        console.error("Analytics Error:", error)
        return NextResponse.json({ error: 'Failed to fetch stats' }, { status: 500 })
    }
}
</file>

<file path="app/api/debug/models/route.ts">
import { NextResponse } from "next/server";

export async function GET() {
    const results: any = {
        google: [],
        anthropic: [],
        errors: []
    };

    // 1. Ping Google (Gemini)
    try {
        const googleKey = process.env.GEMINI_API_KEY;
        if (googleKey) {
            // Google exposes a REST endpoint to list models
            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models?key=${googleKey}`
            );
            const data = await response.json();
            // Filter only for "generateContent" models (chat models)
            results.google = data.models
                ?.filter((m: any) => m.supportedGenerationMethods.includes("generateContent"))
                .map((m: any) => m.name.replace("models/", "")) // Clean up the name
                .sort();
        } else {
            results.errors.push("Missing GEMINI_API_KEY");
        }
    } catch (e: any) {
        results.errors.push(`Google Error: ${e.message}`);
    }

    // 2. Ping Anthropic (Claude)
    try {
        const anthropicKey = process.env.ANTHROPIC_API_KEY;
        if (anthropicKey) {
            const response = await fetch("https://api.anthropic.com/v1/models", {
                headers: {
                    "x-api-key": anthropicKey,
                    "anthropic-version": "2023-06-01"
                }
            });
            const data = await response.json();
            results.anthropic = data.data?.map((m: any) => m.id).sort();
        } else {
            results.errors.push("Missing ANTHROPIC_API_KEY");
        }
    } catch (e: any) {
        results.errors.push(`Anthropic Error: ${e.message}`);
    }

    return NextResponse.json(results);
}
</file>

<file path="app/api/track/click/route.ts">
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
);

export async function GET(request: Request) {
    const { searchParams } = new URL(request.url);
    const url = searchParams.get("u");
    const campaignId = searchParams.get("c");
    const subscriberId = searchParams.get("s");

    if (!url) return new NextResponse("Missing URL", { status: 400 });

    if (campaignId && subscriberId) {
        // Log the click event (fire and forget)
        supabase.from("subscriber_events").insert({
            type: "click",
            campaign_id: campaignId,
            subscriber_id: subscriberId,
            url: url
        }).then(({ error }) => {
            if (error) console.error("Failed to log click:", error);
        });

        // Increment campaign click count (if the RPC exists)
        supabase.rpc('increment_clicks', { row_id: campaignId });
    }

    // Prepare the destination URL
    let destination: URL;
    try {
        destination = new URL(url);

        // Pass the tracking IDs to the destination so your website knows who they are
        // Only append if it's a relative path to your domain or your domain itself
        const allowedDomains = ["dreamplaypianos.com", "localhost"];
        const isAllowedDomain = allowedDomains.some(domain => destination.hostname.includes(domain));

        if (isAllowedDomain) {
            if (subscriberId) destination.searchParams.set("sid", subscriberId);
            if (campaignId) destination.searchParams.set("cid", campaignId);
        }
    } catch (e) {
        // Fallback for relative URLs or malformed URLs
        return NextResponse.redirect(url);
    }

    return NextResponse.redirect(destination.toString());
}
</file>

<file path="app/api/track/open/route.ts">
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
);

export async function GET(request: Request) {
    const { searchParams } = new URL(request.url);
    const campaignId = searchParams.get("c");
    const subscriberId = searchParams.get("s");

    if (campaignId && subscriberId) {
        // Log the open event (fire and forget)
        supabase.from("subscriber_events").insert({
            type: "open",
            campaign_id: campaignId,
            subscriber_id: subscriberId,
        }).then(({ error }) => {
            if (error) console.error("Failed to log open:", error);
        });

        // Increment campaign open count (if the RPC exists)
        supabase.rpc('increment_opens', { row_id: campaignId });
    }

    // Return a 1x1 transparent GIF
    const pixel = Buffer.from(
        "R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
        "base64"
    );

    return new NextResponse(pixel, {
        headers: {
            "Content-Type": "image/gif",
            "Cache-Control": "no-store, no-cache, must-revalidate, proxy-revalidate",
            "Pragma": "no-cache",
            "Expires": "0",
        },
    });
}
</file>

<file path="app/api/track/route.ts">
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
);

// 1. Smart CORS (Allow your website to talk to this API)
const allowedOrigins = ["https://dreamplaypianos.com", "https://www.dreamplaypianos.com"];

function getCorsHeaders(request: Request) {
    const origin = request.headers.get("origin") || "";
    const allow = allowedOrigins.includes(origin) ? origin : allowedOrigins[0];
    return {
        "Access-Control-Allow-Origin": allow,
        "Access-Control-Allow-Methods": "POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type",
    };
}

export async function OPTIONS(request: Request) {
    return NextResponse.json({}, { headers: getCorsHeaders(request) });
}

export async function POST(request: Request) {
    try {
        const { subscriber_id, campaign_id, type, url, duration, ip } = await request.json();

        // 2. Validate
        if (!subscriber_id) return NextResponse.json({ error: "No ID" }, { status: 400 });

        // 3. Log the Event
        await supabase.from("subscriber_events").insert({
            subscriber_id,
            campaign_id, // Optional (null for organic website visits)
            type, // 'open', 'click', 'page_view', 'session_end'
            url,
            ip_address: ip,
            metadata: duration ? { duration_seconds: duration } : {}
        });

        return NextResponse.json({ success: true }, { headers: getCorsHeaders(request) });

    } catch (error) {
        return NextResponse.json({ error: "Track failed" }, { status: 500 });
    }
}
</file>

<file path="app/editor/layout.tsx">
import type React from "react"

export default function EditorLayout({
    children,
}: {
    children: React.ReactNode
}) {
    // This layout renders only children without the main sidebar
    // to give the editor full screen real estate
    return <>{children}</>
}
</file>

<file path="app/globals.css">
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

/* Unified theme with gold/amber accents */
:root {
  --background: oklch(0.13 0.01 260);
  --foreground: oklch(0.95 0 0);
  --card: oklch(0.18 0.01 260);
  --card-foreground: oklch(0.95 0 0);
  --popover: oklch(0.18 0.01 260);
  --popover-foreground: oklch(0.95 0 0);
  --primary: oklch(0.85 0.15 85);
  --primary-foreground: oklch(0.15 0.02 260);
  --secondary: oklch(0.25 0.01 260);
  --secondary-foreground: oklch(0.95 0 0);
  --muted: oklch(0.22 0.01 260);
  --muted-foreground: oklch(0.65 0 0);
  --accent: oklch(0.85 0.15 85);
  --accent-foreground: oklch(0.15 0.02 260);
  --destructive: oklch(0.55 0.2 25);
  --destructive-foreground: oklch(0.95 0 0);
  --border: oklch(0.28 0.01 260);
  --input: oklch(0.22 0.01 260);
  --ring: oklch(0.85 0.15 85);
  --chart-1: oklch(0.85 0.15 85);
  --chart-2: oklch(0.65 0.15 160);
  --chart-3: oklch(0.55 0.15 250);
  --chart-4: oklch(0.7 0.15 30);
  --chart-5: oklch(0.6 0.15 300);
  --radius: 0.5rem;
  --sidebar: oklch(0.12 0.01 260);
  --sidebar-foreground: oklch(0.95 0 0);
  --sidebar-primary: oklch(0.85 0.15 85);
  --sidebar-primary-foreground: oklch(0.15 0.02 260);
  --sidebar-accent: oklch(0.22 0.01 260);
  --sidebar-accent-foreground: oklch(0.95 0 0);
  --sidebar-border: oklch(0.25 0.01 260);
  --sidebar-ring: oklch(0.85 0.15 85);
  /* Dashboard-specific colors */
  --winner: oklch(0.85 0.15 85);
  --live: oklch(0.65 0.2 150);
  --pending: oklch(0.4 0 0);
}

.dark {
  --background: oklch(0.13 0.01 260);
  --foreground: oklch(0.95 0 0);
  --card: oklch(0.18 0.01 260);
  --card-foreground: oklch(0.95 0 0);
  --popover: oklch(0.18 0.01 260);
  --popover-foreground: oklch(0.95 0 0);
  --primary: oklch(0.85 0.15 85);
  --primary-foreground: oklch(0.15 0.02 260);
  --secondary: oklch(0.25 0.01 260);
  --secondary-foreground: oklch(0.95 0 0);
  --muted: oklch(0.22 0.01 260);
  --muted-foreground: oklch(0.65 0 0);
  --accent: oklch(0.85 0.15 85);
  --accent-foreground: oklch(0.15 0.02 260);
  --destructive: oklch(0.55 0.2 25);
  --destructive-foreground: oklch(0.95 0 0);
  --border: oklch(0.28 0.01 260);
  --input: oklch(0.22 0.01 260);
  --ring: oklch(0.85 0.15 85);
  --chart-1: oklch(0.85 0.15 85);
  --chart-2: oklch(0.65 0.15 160);
  --chart-3: oklch(0.55 0.15 250);
  --chart-4: oklch(0.7 0.15 30);
  --chart-5: oklch(0.6 0.15 300);
  --sidebar: oklch(0.12 0.01 260);
  --sidebar-foreground: oklch(0.95 0 0);
  --sidebar-primary: oklch(0.85 0.15 85);
  --sidebar-primary-foreground: oklch(0.15 0.02 260);
  --sidebar-accent: oklch(0.22 0.01 260);
  --sidebar-accent-foreground: oklch(0.95 0 0);
  --sidebar-border: oklch(0.25 0.01 260);
  --sidebar-ring: oklch(0.85 0.15 85);
  /* Dashboard-specific colors */
  --winner: oklch(0.85 0.15 85);
  --live: oklch(0.65 0.2 150);
  --pending: oklch(0.4 0 0);
}

@theme inline {
  --font-sans: "Geist", "Geist Fallback";
  --font-mono: "Geist Mono", "Geist Mono Fallback";
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--card);
  --color-card-foreground: var(--card-foreground);
  --color-popover: var(--popover);
  --color-popover-foreground: var(--popover-foreground);
  --color-primary: var(--primary);
  --color-primary-foreground: var(--primary-foreground);
  --color-secondary: var(--secondary);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-muted: var(--muted);
  --color-muted-foreground: var(--muted-foreground);
  --color-accent: var(--accent);
  --color-accent-foreground: var(--accent-foreground);
  --color-destructive: var(--destructive);
  --color-destructive-foreground: var(--destructive-foreground);
  --color-border: var(--border);
  --color-input: var(--input);
  --color-ring: var(--ring);
  --color-chart-1: var(--chart-1);
  --color-chart-2: var(--chart-2);
  --color-chart-3: var(--chart-3);
  --color-chart-4: var(--chart-4);
  --color-chart-5: var(--chart-5);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-ring: var(--sidebar-ring);
  /* Dashboard-specific color mappings */
  --color-winner: var(--winner);
  --color-live: var(--live);
  --color-pending: var(--pending);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* Pulsating animation for live badge */
@keyframes pulse-live {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.animate-pulse-live {
  animation: pulse-live 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}
</file>

<file path="components/audience/subscriber-history-timeline.tsx">
"use client"

import { useEffect, useState } from "react"
import { formatDistanceToNow } from "date-fns"
import {
    Mail,
    MousePointer2,
    Eye,
    Globe,
    Clock,
    MoreHorizontal,
    ArrowUpRight
} from "lucide-react"
import { getSubscriberHistory } from "@/app/actions/subscriber-history"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { ScrollArea } from "@/components/ui/scroll-area"

interface TimelineEvent {
    id: string
    type: 'sent' | 'open' | 'click' | 'page_view' | 'session_end'
    created_at: string
    url?: string
    ip_address?: string
    metadata?: { duration_seconds?: number }
    campaigns?: { name: string }
}

export function SubscriberHistoryTimeline({ subscriberId }: { subscriberId: string }) {
    const [events, setEvents] = useState<TimelineEvent[]>([])
    const [loading, setLoading] = useState(true)

    useEffect(() => {
        getSubscriberHistory(subscriberId).then((data) => {
            setEvents(data as any)
            setLoading(false)
        })
    }, [subscriberId])

    const getIcon = (type: string) => {
        switch (type) {
            case 'sent': return <Mail className="w-4 h-4 text-zinc-400" />
            case 'open': return <Eye className="w-4 h-4 text-amber-400" />
            case 'click': return <MousePointer2 className="w-4 h-4 text-emerald-400" />
            case 'page_view': return <Globe className="w-4 h-4 text-blue-400" />
            case 'session_end': return <Clock className="w-4 h-4 text-purple-400" />
            default: return <MoreHorizontal className="w-4 h-4 text-zinc-500" />
        }
    }

    const formatDuration = (seconds?: number) => {
        if (!seconds) return ""
        if (seconds < 60) return `${seconds}s`
        return `${Math.floor(seconds / 60)}m ${seconds % 60}s`
    }

    if (loading) return <div className="p-8 text-center text-muted-foreground">Loading history...</div>

    return (
        <Card className="h-full border-border bg-card">
            <CardHeader className="pb-4 border-b border-border/50">
                <CardTitle className="text-lg font-medium flex items-center gap-2">
                    <Clock className="w-5 h-5 text-primary" />
                    Activity Timeline
                </CardTitle>
            </CardHeader>
            <ScrollArea className="h-[600px] p-0">
                <div className="p-6">
                    <div className="relative border-l border-border space-y-8">
                        {events.length === 0 ? (
                            <p className="pl-6 text-sm text-muted-foreground">No activity recorded yet.</p>
                        ) : (
                            events.map((event, index) => (
                                <div key={event.id} className="ml-4 relative">
                                    {/* Timeline Dot */}
                                    <div className="absolute -left-[25px] top-1 h-4 w-4 rounded-full bg-card border border-border flex items-center justify-center z-10">
                                        {/* Inner colored dot based on type */}
                                        <div className={`h-2 w-2 rounded-full ${event.type === 'open' ? 'bg-amber-500' :
                                                event.type === 'click' ? 'bg-emerald-500' :
                                                    event.type === 'page_view' ? 'bg-blue-500' :
                                                        'bg-zinc-600'
                                            }`} />
                                    </div>

                                    {/* Content */}
                                    <div className="flex flex-col gap-1">
                                        <div className="flex items-center gap-2">
                                            <span className="p-1 rounded-md bg-muted/50 border border-border/50">
                                                {getIcon(event.type)}
                                            </span>
                                            <span className="text-sm font-medium text-foreground">
                                                {event.type === 'sent' && "Received Email"}
                                                {event.type === 'open' && "Opened Email"}
                                                {event.type === 'click' && "Clicked Link"}
                                                {event.type === 'page_view' && "Visited Website"}
                                                {event.type === 'session_end' && "Session Ended"}
                                            </span>
                                            <span className="text-xs text-muted-foreground ml-auto">
                                                {formatDistanceToNow(new Date(event.created_at), { addSuffix: true })}
                                            </span>
                                        </div>

                                        {/* Details Box */}
                                        <div className="mt-1 p-3 rounded-lg bg-muted/30 border border-border/50 text-sm">

                                            {/* Campaign Context */}
                                            {event.campaigns?.name && (
                                                <div className="mb-1 text-xs text-muted-foreground uppercase tracking-wider">
                                                    Campaign: {event.campaigns.name}
                                                </div>
                                            )}

                                            {/* Action Context */}
                                            {event.url && (
                                                <a href={event.url} target="_blank" className="flex items-center gap-1 text-blue-400 hover:underline break-all">
                                                    {new URL(event.url).pathname}
                                                    <ArrowUpRight className="w-3 h-3" />
                                                </a>
                                            )}

                                            {/* Metadata (Duration / IP) */}
                                            <div className="mt-2 flex gap-2">
                                                {event.metadata?.duration_seconds && (
                                                    <Badge variant="secondary" className="text-[10px] h-5 bg-purple-500/10 text-purple-400 border-purple-500/20">
                                                        Time on site: {formatDuration(event.metadata.duration_seconds)}
                                                    </Badge>
                                                )}
                                                {event.ip_address && (
                                                    <Badge variant="outline" className="text-[10px] h-5 text-zinc-500">
                                                        IP: {event.ip_address}
                                                    </Badge>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </ScrollArea>
        </Card>
    )
}
</file>

<file path="components/audience/tag-group-view.tsx">
"use client"

import { useMemo } from "react"
import { Subscriber } from "@/lib/types"
import { Card, CardContent, CardFooter, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Send, Users, Tag } from "lucide-react"
import { createCampaignForTag } from "@/app/actions/campaigns"
import { useRouter } from "next/navigation"
import { useToast } from "@/hooks/use-toast"

interface TagGroupViewProps {
    subscribers: Subscriber[]
}

const tagColors: Record<string, string> = {
    Admin: "bg-red-500/20 text-red-400 border-red-500/30",
    Piano: "bg-blue-500/20 text-blue-400 border-blue-500/30",
    Student: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30",
    Theory: "bg-purple-500/20 text-purple-400 border-purple-500/30",
    VIP: "bg-amber-500/20 text-amber-400 border-amber-500/30",
    Beginner: "bg-cyan-500/20 text-cyan-400 border-cyan-500/30",
    Advanced: "bg-orange-500/20 text-orange-400 border-orange-500/30",
}

export function TagGroupView({ subscribers }: TagGroupViewProps) {
    const router = useRouter()
    const { toast } = useToast()

    const groupedSubscribers = useMemo(() => {
        const groups: Record<string, Subscriber[]> = {}

        // Initialize with known tags if we want to show empty ones, 
        // but for now let's just show tags that actually have subscribers
        // plus maybe an "Untagged" group if needed? User didn't specify "Untagged".

        subscribers.forEach(sub => {
            if (sub.tags && sub.tags.length > 0) {
                sub.tags.forEach(tag => {
                    if (!groups[tag]) {
                        groups[tag] = []
                    }
                    groups[tag].push(sub)
                })
            }
        })

        return groups
    }, [subscribers])

    const handleSendToTag = async (tagName: string) => {
        try {
            const result = await createCampaignForTag(tagName)

            if (result.error) {
                throw new Error(result.error)
            }

            toast({
                title: "Campaign Draft Created",
                description: `Draft campaign for ${tagName} created. Redirecting...`,
            })

            if (result.data?.id) {
                router.push(`/editor?id=${result.data.id}`)
            }
        } catch (error: any) {
            toast({
                title: "Error creating campaign",
                description: error.message,
                variant: "destructive",
            })
        }
    }

    const tagNames = Object.keys(groupedSubscribers).sort()

    if (tagNames.length === 0) {
        return (
            <div className="text-center py-20 bg-card rounded-lg border border-border border-dashed">
                <Tag className="h-10 w-10 text-muted-foreground mx-auto mb-4 opacity-50" />
                <h3 className="text-lg font-medium text-foreground">No Tags Found</h3>
                <p className="text-muted-foreground mt-2 max-w-sm mx-auto">
                    Add tags to your subscribers to see them grouped here.
                </p>
            </div>
        )
    }

    return (
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {tagNames.map(tagName => {
                const groupSubs = groupedSubscribers[tagName]
                const count = groupSubs.length
                const previewSubs = groupSubs.slice(0, 5) // First 5

                return (
                    <Card key={tagName} className="bg-card border-border flex flex-col">
                        <CardHeader className="pb-3">
                            <div className="flex justify-between items-start">
                                <CardTitle className="text-lg font-bold flex items-center gap-2">
                                    <Badge
                                        variant="outline"
                                        className={`text-base px-3 py-1 ${tagColors[tagName] || "bg-muted text-muted-foreground"}`}
                                    >
                                        {tagName}
                                    </Badge>
                                </CardTitle>
                                <span className="text-sm font-medium text-muted-foreground bg-muted px-2 py-1 rounded-md flex items-center gap-1">
                                    <Users className="h-3 w-3" />
                                    {count}
                                </span>
                            </div>
                        </CardHeader>
                        <CardContent className="flex-1">
                            <div className="space-y-3">
                                <p className="text-xs text-muted-foreground uppercase font-semibold tracking-wider">
                                    Includes
                                </p>
                                <div className="space-y-1">
                                    {previewSubs.map(sub => (
                                        <div key={sub.id} className="text-sm text-foreground flex items-center gap-2">
                                            <div className="w-1.5 h-1.5 rounded-full bg-primary/50" />
                                            <span className="truncate">
                                                {sub.first_name} {sub.last_name || sub.email}
                                            </span>
                                        </div>
                                    ))}
                                    {count > 5 && (
                                        <div className="text-xs text-muted-foreground pl-3.5 italic">
                                            ...and {count - 5} others
                                        </div>
                                    )}
                                </div>
                            </div>
                        </CardContent>
                        <CardFooter className="pt-2 border-t border-border/50 mt-auto">
                            <Button
                                className="w-full gap-2 bg-amber-500 text-zinc-900 hover:bg-amber-400"
                                onClick={() => handleSendToTag(tagName)}
                            >
                                <Send className="h-4 w-4" />
                                Send Email to {tagName}
                            </Button>
                        </CardFooter>
                    </Card>
                )
            })}
        </div>
    )
}
</file>

<file path="components/campaign/analytics-section.tsx">
"use client"

import { BarChart3, MousePointerClick, Mail, Eye } from "lucide-react"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { CampaignStatus } from "@/lib/types"

interface AnalyticsSectionProps {
    status: CampaignStatus
}

const mockStats = {
    sent: 1240,
    delivered: 1218,
    openRate: 42.3,
    clickRate: 12.8,
}

export function AnalyticsSection({ status }: AnalyticsSectionProps) {
    const isActive = status === "completed" || status === "active"

    return (
        <Card className={`border-border bg-card ${!isActive ? "opacity-50" : ""}`}>
            <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-base font-medium text-foreground">
                    <BarChart3 className="h-5 w-5 text-[#D4AF37]" />
                    Post-Campaign Analytics
                </CardTitle>
                <CardDescription className="text-muted-foreground">
                    {isActive
                        ? "Real-time performance metrics for this campaign."
                        : "Analytics will appear here after the campaign is sent."}
                </CardDescription>
            </CardHeader>

            <CardContent>
                <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
                    {/* Sent */}
                    <div className="rounded-lg border border-border bg-background p-4">
                        <div className="flex items-center gap-2">
                            <Mail className="h-4 w-4 text-muted-foreground" />
                            <span className="text-sm text-muted-foreground">Sent</span>
                        </div>
                        <p className="mt-2 text-2xl font-bold text-foreground">
                            {isActive ? mockStats.sent.toLocaleString() : "—"}
                        </p>
                    </div>

                    {/* Delivered */}
                    <div className="rounded-lg border border-border bg-background p-4">
                        <div className="flex items-center gap-2">
                            <Mail className="h-4 w-4 text-muted-foreground" />
                            <span className="text-sm text-muted-foreground">Delivered</span>
                        </div>
                        <p className="mt-2 text-2xl font-bold text-foreground">
                            {isActive ? mockStats.delivered.toLocaleString() : "—"}
                        </p>
                    </div>

                    {/* Open Rate */}
                    <div className="rounded-lg border border-border bg-background p-4">
                        <div className="flex items-center gap-2">
                            <Eye className="h-4 w-4 text-muted-foreground" />
                            <span className="text-sm text-muted-foreground">Open Rate</span>
                        </div>
                        <p className="mt-2 text-2xl font-bold text-foreground">{isActive ? `${mockStats.openRate}%` : "—"}</p>
                    </div>

                    {/* Click Rate */}
                    <div className="rounded-lg border border-border bg-background p-4">
                        <div className="flex items-center gap-2">
                            <MousePointerClick className="h-4 w-4 text-muted-foreground" />
                            <span className="text-sm text-muted-foreground">Click Rate</span>
                        </div>
                        <p className="mt-2 text-2xl font-bold text-foreground">{isActive ? `${mockStats.clickRate}%` : "—"}</p>
                    </div>
                </div>
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/campaign/preflight-check-card.tsx">
import { ShieldCheck, CheckCircle2, AlertCircle, XCircle } from "lucide-react"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"

interface CheckItem {
    label: string
    status: "pass" | "warning" | "fail"
    detail?: string
}

interface PreflightCheckCardProps {
    subjectLine: string | null
    htmlContent: string | null
    variableValues: Record<string, any> | null
}

export function PreflightCheckCard({ subjectLine, htmlContent, variableValues }: PreflightCheckCardProps) {
    // Extract Mustache variables from HTML content
    const extractVariables = (html: string): string[] => {
        const regex = /\{\{(\w+)\}\}/g
        const matches = new Set<string>()
        let match
        while ((match = regex.exec(html)) !== null) {
            matches.add(match[1])
        }
        return Array.from(matches)
    }

    const safeHtml = htmlContent || ""
    const safeSubject = subjectLine || ""
    const safeVariables = variableValues || {}

    const detectedVariables = extractVariables(safeHtml)
    const hasUnsubscribeLink =
        safeHtml.toLowerCase().includes("unsubscribe") || safeHtml.includes("{{unsubscribe_url}}")

    // Build checklist items
    const checks: CheckItem[] = [
        {
            label: "Subject Line",
            status: safeSubject && safeSubject.trim().length > 0 ? "pass" : "fail",
            detail: safeSubject ? "Present" : "Missing",
        },
        {
            label: "Unsubscribe Link",
            status: hasUnsubscribeLink ? "pass" : "warning",
            detail: hasUnsubscribeLink ? "Detected" : "Not found",
        },
        {
            label: "Variables",
            status: detectedVariables.length > 0 ? "pass" : "pass",
            detail:
                detectedVariables.length > 0
                    ? `${detectedVariables.length} found (${detectedVariables.map((v) => `{{${v}}}`).join(", ")})`
                    : "None detected",
        },
    ]

    // Check if all variables have values
    const missingValues = detectedVariables.filter((v) => !safeVariables[v] || String(safeVariables[v]).trim() === "")
    if (missingValues.length > 0) {
        checks.push({
            label: "Variable Values",
            status: "warning",
            detail: `Missing: ${missingValues.map((v) => `{{${v}}}`).join(", ")}`,
        })
    }

    const getStatusIcon = (status: CheckItem["status"]) => {
        switch (status) {
            case "pass":
                return <CheckCircle2 className="h-4 w-4 text-emerald-500" />
            case "warning":
                return <AlertCircle className="h-4 w-4 text-amber-500" />
            case "fail":
                return <XCircle className="h-4 w-4 text-red-500" />
        }
    }

    const allPassed = checks.every((c) => c.status === "pass")
    const hasFailures = checks.some((c) => c.status === "fail")

    return (
        <Card className="border-border bg-card">
            <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-base font-medium text-foreground">
                    <ShieldCheck className="h-5 w-5 text-[#D4AF37]" />
                    Pre-Flight Check
                    {allPassed && (
                        <span className="ml-auto rounded-full bg-emerald-500/10 px-2 py-0.5 text-xs font-medium text-emerald-500">
                            All Clear
                        </span>
                    )}
                    {hasFailures && (
                        <span className="ml-auto rounded-full bg-red-500/10 px-2 py-0.5 text-xs font-medium text-red-500">
                            Issues Found
                        </span>
                    )}
                </CardTitle>
                <CardDescription className="text-muted-foreground">System check to ensure nothing is broken.</CardDescription>
            </CardHeader>
            <CardContent>
                <ul className="space-y-3">
                    {checks.map((check, index) => (
                        <li key={index} className="flex items-start gap-3">
                            <span className="mt-0.5">{getStatusIcon(check.status)}</span>
                            <div className="flex flex-col">
                                <span className="text-sm font-medium text-foreground">{check.label}</span>
                                {check.detail && <span className="text-xs text-muted-foreground">{check.detail}</span>}
                            </div>
                        </li>
                    ))}
                </ul>
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/campaign/send-test-card.tsx">
"use client"

import { useState } from "react"
import { Send, CheckCircle2, Loader2 } from "lucide-react"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Button } from "@/components/ui/button"

interface SendTestCardProps {
    onSendTest: (email: string) => Promise<void>
}

export function SendTestCard({ onSendTest }: SendTestCardProps) {
    const [email, setEmail] = useState("")
    const [isSending, setIsSending] = useState(false)
    const [isSent, setIsSent] = useState(false)

    const handleSendTest = async () => {
        if (!email) return

        setIsSending(true)
        try {
            await onSendTest(email)
            setIsSent(true)
            setTimeout(() => {
                setIsSent(false)
                setEmail("")
            }, 3000)
        } finally {
            setIsSending(false)
        }
    }

    return (
        <Card className="border-border bg-card">
            <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-base font-medium text-foreground">
                    <Send className="h-5 w-5 text-[#D4AF37]" />
                    Send Test Email
                </CardTitle>
                <CardDescription className="text-muted-foreground">
                    Verify the HTML renders correctly before broadcast.
                </CardDescription>
            </CardHeader>
            <CardContent>
                <div className="flex gap-3">
                    <Input
                        type="email"
                        placeholder="Enter test email..."
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="flex-1 border-border bg-background text-foreground placeholder:text-muted-foreground focus-visible:ring-[#D4AF37]"
                    />
                    <Button
                        variant="secondary"
                        onClick={handleSendTest}
                        disabled={!email || isSending || isSent}
                        className="gap-2 bg-secondary text-secondary-foreground hover:bg-secondary/80"
                    >
                        {isSending ? (
                            <>
                                <Loader2 className="h-4 w-4 animate-spin" />
                                Sending
                            </>
                        ) : isSent ? (
                            <>
                                <CheckCircle2 className="h-4 w-4 text-emerald-500" />
                                Sent!
                            </>
                        ) : (
                            "Send Test"
                        )}
                    </Button>
                </div>
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/campaigns/create-campaign-dialog.tsx">
"use client"

import { useState } from "react"
import { useRouter } from "next/navigation"
import { Plus } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import { useToast } from "@/hooks/use-toast"
import { createCampaign } from "@/app/actions/campaigns"

export function CreateCampaignDialog() {
    const [open, setOpen] = useState(false)
    const [name, setName] = useState("")
    const [loading, setLoading] = useState(false)
    const router = useRouter()
    const { toast } = useToast()

    const handleCreate = async () => {
        if (!name.trim()) return

        setLoading(true)
        try {
            const formData = new FormData()
            formData.append("name", name)

            const result = await createCampaign(null, formData)

            if (result.error) {
                throw new Error(result.error)
            }

            toast({
                title: "Campaign created",
                description: `"${name}" has been created successfully.`,
            })

            // Redirect to editor
            if (result.data?.id) {
                setOpen(false)
                setName("")
                router.push(`/editor?id=${result.data.id}`)
            }
        } catch (error: any) {
            console.error("Error creating campaign:", error)
            toast({
                title: "Error",
                description: error.message || "Failed to create campaign",
                variant: "destructive",
            })
        } finally {
            setLoading(false)
        }
    }

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button className="bg-primary text-primary-foreground hover:bg-primary/90">
                    <Plus className="mr-2 h-4 w-4" />
                    New Campaign
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[425px]">
                <DialogHeader>
                    <DialogTitle>Create New Campaign</DialogTitle>
                    <DialogDescription>
                        Give your campaign a name to get started. You can change this later.
                    </DialogDescription>
                </DialogHeader>
                <div className="grid gap-4 py-4">
                    <div className="grid gap-2">
                        <Label htmlFor="name">Campaign Name</Label>
                        <Input
                            id="name"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            placeholder="e.g., Monthly Newsletter"
                            autoFocus
                            onKeyDown={(e) => {
                                if (e.key === "Enter" && !loading && name.trim()) {
                                    handleCreate()
                                }
                            }}
                        />
                    </div>
                </div>
                <DialogFooter>
                    <Button variant="outline" onClick={() => setOpen(false)}>
                        Cancel
                    </Button>
                    <Button onClick={handleCreate} disabled={!name.trim() || loading}>
                        {loading ? "Creating..." : "Create Campaign"}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/campaigns/new-round-modal.tsx">
"use client"

import { useState } from "react"
import { X, Crown, Swords, ChevronDown, AlertCircle } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"
import { Slider } from "@/components/ui/slider"
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu"

interface NewRoundModalProps {
    isOpen: boolean
    onClose: () => void
    onLaunch: (batchSize: number, champion: string, challenger: string) => void
    roundNumber?: number
    totalList?: number
    alreadyEmailed?: number
    defaultChampion?: { name: string; subject: string }
    versions?: { name: string; subject: string }[]
}

export function NewRoundModal({
    isOpen,
    onClose,
    onLaunch,
    roundNumber = 3,
    totalList = 10000,
    alreadyEmailed = 5500,
    defaultChampion = { name: "Version A", subject: "Big Sale" },
    versions = [
        { name: "Version A", subject: "Big Sale" },
        { name: "Version B", subject: "Flash Deals Today" },
        { name: "Version C", subject: "Your Exclusive Offer" },
        { name: "Version D", subject: "Limited Time Offer" },
        { name: "Version E", subject: "Exclusive Deal" },
    ],
}: NewRoundModalProps) {
    const availableNow = totalList - alreadyEmailed
    const [batchSize, setBatchSize] = useState(1000)
    const [selectedChampion, setSelectedChampion] = useState<string>(defaultChampion.name)
    const [selectedChallenger, setSelectedChallenger] = useState<string | null>(null)

    const splitSize = Math.floor(batchSize / 2)
    const remainingAfterRound = availableNow - batchSize

    const isSameVersion = selectedChallenger !== null && selectedChampion === selectedChallenger

    if (!isOpen) return null

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div className="w-full max-w-2xl rounded-xl border border-border bg-card shadow-2xl">
                {/* Header */}
                <div className="flex items-center justify-between border-b border-border px-6 py-4">
                    <div className="flex items-center gap-3">
                        <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-500/20">
                            <Swords className="h-5 w-5 text-amber-400" />
                        </div>
                        <div>
                            <h2 className="text-xl font-semibold text-foreground">Configure Round {roundNumber}</h2>
                            <p className="text-sm text-muted-foreground">Set up your next battle</p>
                        </div>
                    </div>
                    <button
                        onClick={onClose}
                        className="rounded-lg p-2 text-muted-foreground transition-colors hover:bg-muted hover:text-foreground"
                    >
                        <X className="h-5 w-5" />
                    </button>
                </div>

                {/* Audience Stats */}
                <div className="border-b border-border px-6 py-4">
                    <div className="mb-3 flex items-center justify-between text-sm">
                        <span className="text-muted-foreground">Audience Progress</span>
                        <span className="font-medium text-foreground">
                            {((alreadyEmailed / totalList) * 100).toFixed(0)}% contacted
                        </span>
                    </div>

                    <div className="mb-4 h-3 overflow-hidden rounded-full bg-muted">
                        <div
                            className="h-full bg-gradient-to-r from-amber-500 to-amber-400 transition-all"
                            style={{ width: `${(alreadyEmailed / totalList) * 100}%` }}
                        />
                    </div>

                    <div className="grid grid-cols-3 gap-4">
                        <div className="rounded-lg bg-muted/50 p-3 text-center">
                            <p className="text-xs text-muted-foreground">Total List</p>
                            <p className="text-lg font-semibold text-foreground">{totalList.toLocaleString()}</p>
                        </div>
                        <div className="rounded-lg bg-muted/50 p-3 text-center">
                            <p className="text-xs text-muted-foreground">Already Emailed</p>
                            <p className="text-lg font-semibold text-foreground">{alreadyEmailed.toLocaleString()}</p>
                        </div>
                        <div className="rounded-lg border border-emerald-500/30 bg-emerald-500/10 p-3 text-center">
                            <p className="text-xs text-emerald-400">Available Now</p>
                            <p className="text-lg font-semibold text-emerald-400">{availableNow.toLocaleString()}</p>
                        </div>
                    </div>
                </div>

                {/* Section A: Audience Slider */}
                <div className="border-b border-border px-6 py-5">
                    <h3 className="mb-4 text-sm font-medium text-foreground">Batch Size for This Round</h3>

                    <Slider
                        value={[batchSize]}
                        onValueChange={([value]) => setBatchSize(value)}
                        max={availableNow}
                        min={100}
                        step={100}
                        className="mb-4"
                    />

                    <div className="rounded-lg border border-amber-500/30 bg-amber-500/10 p-4">
                        <div className="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <p className="text-xs text-amber-400/80">Sending to</p>
                                <p className="text-xl font-bold text-amber-400">{batchSize.toLocaleString()}</p>
                                <p className="text-xs text-amber-400/80">subscribers</p>
                            </div>
                            <div>
                                <p className="text-xs text-amber-400/80">Split</p>
                                <p className="text-xl font-bold text-amber-400">{splitSize.toLocaleString()}</p>
                                <p className="text-xs text-amber-400/80">per version</p>
                            </div>
                            <div>
                                <p className="text-xs text-amber-400/80">Remaining</p>
                                <p className="text-xl font-bold text-amber-400">{remainingAfterRound.toLocaleString()}</p>
                                <p className="text-xs text-amber-400/80">after round</p>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Section B: The Matchup */}
                <div className="px-6 py-5">
                    <h3 className="mb-4 text-sm font-medium text-foreground">The Matchup</h3>

                    <div className="grid grid-cols-2 gap-4">
                        <Card className="relative overflow-hidden border-amber-500/30 bg-gradient-to-br from-amber-500/10 to-transparent p-4">
                            <div className="mb-3 flex items-center gap-2">
                                <Crown className="h-5 w-5 text-amber-400" />
                                <span className="text-xs font-medium uppercase tracking-wider text-amber-400">Champion (Default)</span>
                            </div>

                            <DropdownMenu>
                                <DropdownMenuTrigger asChild>
                                    <button className="flex w-full items-center justify-between rounded-lg border border-amber-500/30 bg-background px-4 py-3 text-left transition-colors hover:border-amber-500/50 hover:bg-muted">
                                        <span className="font-medium text-foreground">{selectedChampion}</span>
                                        <ChevronDown className="h-4 w-4 text-muted-foreground" />
                                    </button>
                                </DropdownMenuTrigger>
                                <DropdownMenuContent align="start" className="w-56">
                                    {versions.map((version) => (
                                        <DropdownMenuItem
                                            key={version.name}
                                            onClick={() => setSelectedChampion(version.name)}
                                            className="flex flex-col items-start gap-1"
                                        >
                                            <span className="font-medium">
                                                {version.name}
                                                {version.name === defaultChampion.name && (
                                                    <span className="ml-2 text-xs text-amber-400">(Previous Winner)</span>
                                                )}
                                            </span>
                                            <span className="text-xs text-muted-foreground">Subject: "{version.subject}"</span>
                                        </DropdownMenuItem>
                                    ))}
                                </DropdownMenuContent>
                            </DropdownMenu>

                            <p className="mt-3 text-sm text-muted-foreground">
                                Subject: "{versions.find((v) => v.name === selectedChampion)?.subject}"
                            </p>
                        </Card>

                        {/* Challenger Card (Selectable) */}
                        <Card className="border-border bg-muted/30 p-4">
                            <div className="mb-3 flex items-center gap-2">
                                <Swords className="h-5 w-5 text-muted-foreground" />
                                <span className="text-xs font-medium uppercase tracking-wider text-muted-foreground">Challenger</span>
                            </div>

                            <DropdownMenu>
                                <DropdownMenuTrigger asChild>
                                    <button className="flex w-full items-center justify-between rounded-lg border border-border bg-background px-4 py-3 text-left transition-colors hover:border-amber-500/50 hover:bg-muted">
                                        {selectedChallenger ? (
                                            <span className="font-medium text-foreground">{selectedChallenger}</span>
                                        ) : (
                                            <span className="text-muted-foreground">Select Version...</span>
                                        )}
                                        <ChevronDown className="h-4 w-4 text-muted-foreground" />
                                    </button>
                                </DropdownMenuTrigger>
                                <DropdownMenuContent align="start" className="w-56">
                                    {versions.map((version) => (
                                        <DropdownMenuItem
                                            key={version.name}
                                            onClick={() => setSelectedChallenger(version.name)}
                                            className="flex flex-col items-start gap-1"
                                        >
                                            <span className="font-medium">{version.name}</span>
                                            <span className="text-xs text-muted-foreground">Subject: "{version.subject}"</span>
                                        </DropdownMenuItem>
                                    ))}
                                </DropdownMenuContent>
                            </DropdownMenu>

                            {selectedChallenger && (
                                <p className="mt-3 text-sm text-muted-foreground">
                                    Subject: "{versions.find((v) => v.name === selectedChallenger)?.subject}"
                                </p>
                            )}
                        </Card>
                    </div>

                    {/* VS Badge */}
                    <div className="relative -my-2 flex justify-center">
                        <div className="absolute top-1/2 -translate-y-1/2 rounded-full border border-border bg-card px-3 py-1 text-xs font-bold text-muted-foreground">
                            VS
                        </div>
                    </div>

                    {isSameVersion && (
                        <div className="mt-4 flex items-center gap-2 rounded-lg border border-red-500/30 bg-red-500/10 px-4 py-3">
                            <AlertCircle className="h-4 w-4 text-red-400" />
                            <span className="text-sm text-red-400">Cannot test a version against itself.</span>
                        </div>
                    )}
                </div>

                {/* Footer */}
                <div className="flex items-center justify-end gap-3 border-t border-border px-6 py-4">
                    <Button variant="ghost" onClick={onClose}>
                        Cancel
                    </Button>
                    <Button
                        onClick={() =>
                            selectedChallenger && !isSameVersion && onLaunch(batchSize, selectedChampion, selectedChallenger)
                        }
                        disabled={!selectedChallenger || isSameVersion}
                        className="bg-gradient-to-r from-amber-500 to-amber-400 font-semibold text-black hover:from-amber-400 hover:to-amber-300 disabled:opacity-50"
                    >
                        <Swords className="mr-2 h-4 w-4" />
                        Fight!
                    </Button>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="components/dashboard/action-footer.tsx">
"use client"

import { Button } from "@/components/ui/button"
import { Play, Pause } from "lucide-react"

interface ActionFooterProps {
    onLaunchNextRound?: () => void
}

export function ActionFooter({ onLaunchNextRound }: ActionFooterProps) {
    return (
        <footer className="fixed bottom-0 left-0 right-0 border-t border-border bg-card/95 backdrop-blur-sm">
            <div className="container mx-auto px-4 py-4 max-w-4xl">
                <div className="flex flex-col sm:flex-row gap-3 sm:justify-end">
                    <Button variant="destructive" className="gap-2 order-2 sm:order-1">
                        <Pause className="h-4 w-4" />
                        Pause Tournament
                    </Button>
                    <Button
                        className="gap-2 order-1 sm:order-2 bg-primary text-primary-foreground hover:bg-primary/90"
                        onClick={onLaunchNextRound}
                    >
                        <Play className="h-4 w-4" />
                        Launch Next Round
                    </Button>
                </div>
            </div>
        </footer>
    )
}
</file>

<file path="components/dashboard/contender-card.tsx">
"use client"

import { Crown, Mail, MousePointer, TrendingUp, Gavel, CheckCircle } from "lucide-react"
import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import type { Round } from "./tournament-dashboard"

interface Contender {
    id: string
    name: string
    subject: string
    openRate: number
    clickRate: number
    isWinner: boolean
}

interface ContenderCardProps {
    contender: Contender
    role: "Champion" | "Challenger"
    isLive: boolean
    roundStatus: Round["status"]
    onSelectWinner: () => void
}

export function ContenderCard({ contender, role, isLive, roundStatus, onSelectWinner }: ContenderCardProps) {
    const isWinner = contender.isWinner
    const isCompleted = roundStatus === "completed" || roundStatus === "completed-manual"
    const isPending = roundStatus === "pending"

    const showOverrideButton = !isPending && (isLive || (isCompleted && !isWinner))
    const showWinnerDeclared = isCompleted && isWinner
    const buttonLabel = isLive ? "Select as Winner" : "Override Winner"

    return (
        <div
            className={cn(
                "relative p-4 rounded-lg border transition-all",
                isWinner ? "border-winner/50 bg-winner/5" : "border-border bg-muted/30",
                isLive && "border-live/30",
            )}
        >
            {isWinner && (
                <div className="absolute -top-2 -right-2">
                    <div className="p-1.5 rounded-full bg-winner text-primary-foreground">
                        <Crown className="h-3.5 w-3.5" />
                    </div>
                </div>
            )}
            <div className="space-y-3">
                <div className="flex items-center gap-2">
                    <div
                        className={cn(
                            "h-10 w-10 rounded-lg flex items-center justify-center font-bold text-sm",
                            role === "Champion" ? "bg-primary/20 text-primary" : "bg-accent/20 text-accent",
                        )}
                    >
                        {contender.id}
                    </div>
                    <div>
                        <p className="text-xs text-muted-foreground uppercase tracking-wide">{role}</p>
                        <p className="font-medium text-foreground">{contender.name}</p>
                    </div>
                </div>
                <div className="flex items-start gap-2 p-2 rounded-md bg-background/50">
                    <Mail className="h-4 w-4 text-muted-foreground mt-0.5 shrink-0" />
                    <p className="text-sm text-foreground leading-tight">"{contender.subject}"</p>
                </div>
                <div className="grid grid-cols-2 gap-3">
                    <div className="space-y-1">
                        <div className="flex items-center gap-1.5 text-xs text-muted-foreground">
                            <TrendingUp className="h-3 w-3" />
                            Open Rate
                        </div>
                        <p
                            className={cn(
                                "text-lg font-semibold",
                                isWinner ? "text-winner" : "text-foreground",
                                isLive && "text-live",
                            )}
                        >
                            {contender.openRate}%{isLive && <span className="text-xs font-normal text-live ml-1">Rising...</span>}
                        </p>
                    </div>
                    <div className="space-y-1">
                        <div className="flex items-center gap-1.5 text-xs text-muted-foreground">
                            <MousePointer className="h-3 w-3" />
                            Click Rate
                        </div>
                        <p className="text-lg font-semibold text-foreground">{contender.clickRate}%</p>
                    </div>
                </div>

                <div className="pt-3 border-t border-border/50">
                    {showWinnerDeclared ? (
                        <div className="flex items-center justify-center gap-2 py-2 text-winner text-sm font-medium">
                            <CheckCircle className="h-4 w-4" />
                            Winner Declared
                        </div>
                    ) : showOverrideButton ? (
                        <Button
                            variant="ghost"
                            className="w-full border border-dashed border-zinc-700 text-zinc-500 hover:border-yellow-500 hover:text-yellow-400 hover:bg-yellow-500/5"
                            onClick={onSelectWinner}
                        >
                            <Gavel className="h-4 w-4 mr-2" />
                            {buttonLabel}
                        </Button>
                    ) : null}
                </div>
            </div>
        </div>
    )
}
</file>

<file path="components/dashboard/round-card.tsx">
import { Card, CardContent, CardHeader } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { ContenderCard } from "./contender-card"
import { Lock, Swords } from "lucide-react"
import { cn } from "@/lib/utils"
import type { Round } from "./tournament-dashboard"

interface RoundCardProps {
    round: Round
    onSelectWinner: (roundId: number, winner: "champion" | "challenger") => void
}

export function RoundCard({ round, onSelectWinner }: RoundCardProps) {
    const isPending = round.status === "pending"
    const isLive = round.status === "live"
    const isCompleted = round.status === "completed" || round.status === "completed-manual"
    const isManual = round.status === "completed-manual"

    return (
        <Card
            className={cn(
                "transition-all duration-300",
                isPending && "opacity-60 bg-muted/30",
                isLive && "ring-2 ring-live/50 bg-card",
            )}
        >
            <CardHeader className="pb-3">
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <span className="font-semibold text-foreground">Round {round.id}</span>
                        {isLive && (
                            <Badge className="bg-live text-live-foreground gap-1.5 text-xs">
                                <span className="h-1.5 w-1.5 rounded-full bg-current animate-pulse-live" />
                                LIVE
                            </Badge>
                        )}
                        {isCompleted && (
                            <Badge variant="secondary" className="text-xs">
                                {isManual ? "Completed (Manual)" : "Completed"}
                            </Badge>
                        )}
                        {isPending && (
                            <Badge variant="outline" className="text-xs gap-1 text-muted-foreground border-muted-foreground/30">
                                <Lock className="h-3 w-3" />
                                Pending
                            </Badge>
                        )}
                    </div>
                    <span className="text-sm text-muted-foreground">{round.sentDate}</span>
                </div>
            </CardHeader>
            <CardContent>
                {isPending ? (
                    <div className="flex items-center justify-center py-8 text-muted-foreground">
                        <Lock className="h-5 w-5 mr-2" />
                        <span>Awaiting results from previous round</span>
                    </div>
                ) : (
                    <div className="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-4 items-center">
                        <ContenderCard
                            contender={round.champion}
                            role="Champion"
                            isLive={isLive}
                            roundStatus={round.status}
                            onSelectWinner={() => onSelectWinner(round.id, "champion")}
                        />
                        <div className="flex items-center justify-center">
                            <div className="p-2 rounded-full bg-muted">
                                <Swords className="h-5 w-5 text-muted-foreground" />
                            </div>
                        </div>
                        <ContenderCard
                            contender={round.challenger}
                            role="Challenger"
                            isLive={isLive}
                            roundStatus={round.status}
                            onSelectWinner={() => onSelectWinner(round.id, "challenger")}
                        />
                    </div>
                )}
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/dashboard/tournament-dashboard.tsx">
"use client"

import { useState } from "react"
import { TournamentHeader } from "./tournament-header"
import { RoundCard } from "./round-card"
import { ActionFooter } from "./action-footer"

export interface Contender {
    id: string
    name: string
    subject: string
    openRate: number
    clickRate: number
    isWinner: boolean
}

export interface Round {
    id: number
    status: "completed" | "completed-manual" | "live" | "pending"
    sentDate: string
    champion: Contender
    challenger: Contender
}

const initialRounds: Round[] = [
    {
        id: 1,
        status: "completed",
        sentDate: "Nov 20, 2024",
        champion: {
            id: "A",
            name: "Version A",
            subject: "Big Sale Now",
            openRate: 24,
            clickRate: 4.2,
            isWinner: true,
        },
        challenger: {
            id: "B",
            name: "Version B",
            subject: "Hello Friend",
            openRate: 12,
            clickRate: 1.1,
            isWinner: false,
        },
    },
    {
        id: 2,
        status: "completed",
        sentDate: "Nov 22, 2024",
        champion: {
            id: "A",
            name: "Version A",
            subject: "Big Sale Now",
            openRate: 23,
            clickRate: 3.9,
            isWinner: true,
        },
        challenger: {
            id: "C",
            name: "Version C",
            subject: "50% Off Today",
            openRate: 21,
            clickRate: 5.5,
            isWinner: false,
        },
    },
    {
        id: 3,
        status: "live",
        sentDate: "Nov 24, 2024",
        champion: {
            id: "A",
            name: "Version A",
            subject: "Big Sale Now",
            openRate: 15,
            clickRate: 2.1,
            isWinner: false,
        },
        challenger: {
            id: "D",
            name: "Version D",
            subject: "The Final Countdown",
            openRate: 19,
            clickRate: 3.2,
            isWinner: false,
        },
    },
    {
        id: 4,
        status: "pending",
        sentDate: "Scheduled: Nov 26, 2024",
        champion: {
            id: "?",
            name: "Winner of Round 3",
            subject: "TBD",
            openRate: 0,
            clickRate: 0,
            isWinner: false,
        },
        challenger: {
            id: "E",
            name: "Version E",
            subject: "Last Chance",
            openRate: 0,
            clickRate: 0,
            isWinner: false,
        },
    },
]

interface TournamentDashboardProps {
    onLaunchNextRound?: () => void
}

export function TournamentDashboard({ onLaunchNextRound }: TournamentDashboardProps) {
    const [rounds, setRounds] = useState<Round[]>(initialRounds)

    const handleSelectWinner = (roundId: number, winner: "champion" | "challenger") => {
        setRounds((prevRounds) =>
            prevRounds.map((round) => {
                if (round.id !== roundId) return round

                const isLive = round.status === "live"
                return {
                    ...round,
                    status: isLive ? "completed-manual" : round.status,
                    champion: {
                        ...round.champion,
                        isWinner: winner === "champion",
                    },
                    challenger: {
                        ...round.challenger,
                        isWinner: winner === "challenger",
                    },
                }
            }),
        )
    }

    return (
        <div className="min-h-screen bg-background pb-24">
            <TournamentHeader title="Black Friday Promo" status="Active" listSize={10000} remainingAudience={4500} />
            <main className="container mx-auto px-4 py-6 max-w-4xl">
                <div className="space-y-4">
                    {rounds.map((round) => (
                        <RoundCard key={round.id} round={round} onSelectWinner={handleSelectWinner} />
                    ))}
                </div>
            </main>
            <ActionFooter onLaunchNextRound={onLaunchNextRound} />
        </div>
    )
}
</file>

<file path="components/dashboard/tournament-header.tsx">
import { Badge } from "@/components/ui/badge"
import { Trophy, Users, Target } from "lucide-react"

interface TournamentHeaderProps {
    title: string
    status: string
    listSize: number
    remainingAudience: number
}

export function TournamentHeader({ title, status, listSize, remainingAudience }: TournamentHeaderProps) {
    return (
        <header className="border-b border-border bg-card/50 backdrop-blur-sm sticky top-0 z-10">
            <div className="container mx-auto px-4 py-4 max-w-4xl">
                <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                    <div className="flex items-center gap-3">
                        <div className="p-2 rounded-lg bg-primary/10">
                            <Trophy className="h-6 w-6 text-primary" />
                        </div>
                        <h1 className="text-xl font-semibold text-foreground">{title}</h1>
                    </div>
                    <div className="flex flex-wrap items-center gap-2">
                        <Badge variant="outline" className="border-live/50 bg-live/10 text-live">
                            <span className="mr-1.5 h-2 w-2 rounded-full bg-live animate-pulse-live" />
                            Status: {status}
                        </Badge>
                        <Badge variant="secondary" className="gap-1.5">
                            <Users className="h-3 w-3" />
                            List: {listSize.toLocaleString()}
                        </Badge>
                        <Badge variant="secondary" className="gap-1.5">
                            <Target className="h-3 w-3" />
                            Remaining: {remainingAudience.toLocaleString()}
                        </Badge>
                    </div>
                </div>
            </div>
        </header>
    )
}
</file>

<file path="components/editor/campaign-picker.tsx">
"use client"

import { useState, useEffect } from "react"
import { useRouter } from "next/navigation"
import { FolderOpen, Loader2, Calendar } from "lucide-react"
import { Button } from "@/components/ui/button"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog"
import { getCampaignList } from "@/app/actions/campaigns"
import { formatDistanceToNow } from "date-fns"
import { cn } from "@/lib/utils"

interface CampaignSummary {
    id: string
    name: string
    status: string
    created_at: string
}

interface CampaignPickerProps {
    currentId?: string | null
    editorType: "classic" | "modular"
    className?: string
}

export function CampaignPicker({ currentId, editorType, className }: CampaignPickerProps) {
    const [open, setOpen] = useState(false)
    const [loading, setLoading] = useState(false)
    const [campaigns, setCampaigns] = useState<CampaignSummary[]>([])
    const router = useRouter()

    useEffect(() => {
        if (open) {
            const fetchCampaigns = async () => {
                setLoading(true)
                try {
                    const data = await getCampaignList()
                    // Filter or sort if needed, but getCampaignList already sorts by created_at
                    setCampaigns(data as CampaignSummary[])
                } catch (error) {
                    console.error("Error fetching campaigns for picker:", error)
                } finally {
                    setLoading(false)
                }
            }
            fetchCampaigns()
        }
    }, [open])

    const handleSelect = (id: string) => {
        setOpen(false)
        const path = editorType === "classic" ? "/editor" : "/modular-editor"
        router.push(`${path}?id=${id}`)
    }

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                <Button variant="outline" size="sm" className={cn("gap-2", className)}>
                    <FolderOpen className="w-4 h-4" />
                    Open
                </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[500px] max-h-[80vh] flex flex-col">
                <DialogHeader>
                    <DialogTitle>Open Campaign</DialogTitle>
                    <DialogDescription>
                        Select a campaign to open in the {editorType === "classic" ? "Classic" : "Modular"} Editor.
                    </DialogDescription>
                </DialogHeader>

                <div className="flex-1 overflow-y-auto pr-2 py-4">
                    {loading ? (
                        <div className="flex flex-col items-center justify-center py-12 gap-3 text-muted-foreground">
                            <Loader2 className="w-8 h-8 animate-spin" />
                            <p className="text-sm">Fetching campaigns...</p>
                        </div>
                    ) : campaigns.length === 0 ? (
                        <div className="text-center py-12 text-muted-foreground">
                            <p>No campaigns found.</p>
                        </div>
                    ) : (
                        <div className="grid gap-2">
                            {campaigns.map((campaign) => (
                                <button
                                    key={campaign.id}
                                    onClick={() => handleSelect(campaign.id)}
                                    disabled={campaign.id === currentId}
                                    className={cn(
                                        "flex flex-col items-start gap-1 p-3 rounded-lg border text-left transition-all",
                                        campaign.id === currentId
                                            ? "bg-muted border-primary/20 opacity-80 cursor-default"
                                            : "border-border bg-card hover:bg-accent hover:border-primary/50"
                                    )}
                                >
                                    <div className="flex w-full items-center justify-between">
                                        <span className="font-medium text-sm truncate pr-4">
                                            {campaign.name || "Untitled Campaign"}
                                        </span>
                                        {campaign.id === currentId && (
                                            <span className="text-[10px] bg-primary/20 text-primary px-1.5 py-0.5 rounded font-bold uppercase">
                                                Current
                                            </span>
                                        )}
                                    </div>
                                    <div className="flex items-center gap-2 text-xs text-muted-foreground">
                                        <Calendar className="w-3 h-3" />
                                        <span>
                                            Created {formatDistanceToNow(new Date(campaign.created_at), { addSuffix: true })}
                                        </span>
                                        <span className="text-[10px] border border-border px-1 rounded uppercase">
                                            {campaign.status}
                                        </span>
                                    </div>
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/editor/history-sheet.tsx">
"use client"

import { useEffect, useState } from "react"
import { getVersions } from "@/app/actions/versions"
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger, SheetDescription } from "@/components/ui/sheet"
import { Button } from "@/components/ui/button"
import { History, Clock, RotateCcw } from "lucide-react"
import { formatDistanceToNow } from "date-fns"

interface Version {
    id: string
    created_at: string
    prompt: string
    html_content: string
}

interface HistorySheetProps {
    campaignId: string | null
    onRestore: (html: string) => void
}

export function HistorySheet({ campaignId, onRestore }: HistorySheetProps) {
    const [versions, setVersions] = useState<Version[]>([])
    const [open, setOpen] = useState(false)
    const [loading, setLoading] = useState(false)

    const loadVersions = async () => {
        if (!campaignId) return
        setLoading(true)
        try {
            const data = await getVersions(campaignId)
            if (data) setVersions(data)
        } catch (e) {
            console.error(e)
        } finally {
            setLoading(false)
        }
    }

    // Load when sheet opens
    useEffect(() => {
        if (open) loadVersions()
    }, [open, campaignId])

    return (
        <Sheet open={open} onOpenChange={setOpen}>
            <SheetTrigger asChild>
                <Button variant="ghost" size="icon" title="Version History">
                    <History className="w-4 h-4" />
                </Button>
            </SheetTrigger>
            <SheetContent className="w-[400px] gap-4 flex flex-col">
                <SheetHeader>
                    <SheetTitle>Version History</SheetTitle>
                    <SheetDescription>
                        Showing saved points for this campaign.
                    </SheetDescription>
                </SheetHeader>

                <div className="flex-1 overflow-y-auto space-y-4 py-4 pr-2">
                    {loading && <div className="text-center text-sm text-muted-foreground">Loading...</div>}

                    {!loading && versions.length === 0 && (
                        <div className="text-center text-sm text-muted-foreground p-4 border border-dashed rounded-lg">
                            No history found yet.
                        </div>
                    )}

                    {versions.map((v) => (
                        <div key={v.id} className="group flex flex-col gap-2 p-3 border rounded-lg hover:bg-muted/50 transition-colors">
                            <div className="flex items-center justify-between">
                                <span className="text-xs font-medium text-muted-foreground flex items-center gap-1">
                                    <Clock className="w-3 h-3" />
                                    {formatDistanceToNow(new Date(v.created_at), { addSuffix: true })}
                                </span>
                                <Button
                                    size="sm"
                                    variant="secondary"
                                    className="h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                                    onClick={() => {
                                        onRestore(v.html_content)
                                        setOpen(false)
                                    }}
                                >
                                    <RotateCcw className="w-3 h-3 mr-1" />
                                    Restore
                                </Button>
                            </div>
                            <p className="text-sm line-clamp-2 font-medium">
                                {v.prompt ? `"${v.prompt}"` : "Manual Save"}
                            </p>
                        </div>
                    ))}
                </div>
            </SheetContent>
        </Sheet>
    )
}
</file>

<file path="components/ui/accordion.tsx">
'use client'

import * as React from 'react'
import * as AccordionPrimitive from '@radix-ui/react-accordion'
import { ChevronDownIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Accordion({
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Root>) {
  return <AccordionPrimitive.Root data-slot="accordion" {...props} />
}

function AccordionItem({
  className,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Item>) {
  return (
    <AccordionPrimitive.Item
      data-slot="accordion-item"
      className={cn('border-b last:border-b-0', className)}
      {...props}
    />
  )
}

function AccordionTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Trigger>) {
  return (
    <AccordionPrimitive.Header className="flex">
      <AccordionPrimitive.Trigger
        data-slot="accordion-trigger"
        className={cn(
          'focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-start justify-between gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180',
          className,
        )}
        {...props}
      >
        {children}
        <ChevronDownIcon className="text-muted-foreground pointer-events-none size-4 shrink-0 translate-y-0.5 transition-transform duration-200" />
      </AccordionPrimitive.Trigger>
    </AccordionPrimitive.Header>
  )
}

function AccordionContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Content>) {
  return (
    <AccordionPrimitive.Content
      data-slot="accordion-content"
      className="data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm"
      {...props}
    >
      <div className={cn('pt-0 pb-4', className)}>{children}</div>
    </AccordionPrimitive.Content>
  )
}

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
</file>

<file path="components/ui/alert-dialog.tsx">
'use client'

import * as React from 'react'
import * as AlertDialogPrimitive from '@radix-ui/react-alert-dialog'

import { cn } from '@/lib/utils'
import { buttonVariants } from '@/components/ui/button'

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50',
        className,
      )}
      {...props}
    />
  )
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          'bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg',
          className,
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn('flex flex-col gap-2 text-center sm:text-left', className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        'flex flex-col-reverse gap-2 sm:flex-row sm:justify-end',
        className,
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn('text-lg font-semibold', className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: 'outline' }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="components/ui/alert.tsx">
import * as React from 'react'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const alertVariants = cva(
  'relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current',
  {
    variants: {
      variant: {
        default: 'bg-card text-card-foreground',
        destructive:
          'text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        'col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight',
        className,
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        'text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed',
        className,
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="components/ui/aspect-ratio.tsx">
'use client'

import * as AspectRatioPrimitive from '@radix-ui/react-aspect-ratio'

function AspectRatio({
  ...props
}: React.ComponentProps<typeof AspectRatioPrimitive.Root>) {
  return <AspectRatioPrimitive.Root data-slot="aspect-ratio" {...props} />
}

export { AspectRatio }
</file>

<file path="components/ui/avatar.tsx">
'use client'

import * as React from 'react'
import * as AvatarPrimitive from '@radix-ui/react-avatar'

import { cn } from '@/lib/utils'

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        'relative flex size-8 shrink-0 overflow-hidden rounded-full',
        className,
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn('aspect-square size-full', className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        'bg-muted flex size-full items-center justify-center rounded-full',
        className,
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="components/ui/badge.tsx">
import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const badgeVariants = cva(
  'inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden',
  {
    variants: {
      variant: {
        default:
          'border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90',
        secondary:
          'border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90',
        destructive:
          'border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60',
        outline:
          'text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<'span'> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : 'span'

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }
</file>

<file path="components/ui/breadcrumb.tsx">
import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { ChevronRight, MoreHorizontal } from 'lucide-react'

import { cn } from '@/lib/utils'

function Breadcrumb({ ...props }: React.ComponentProps<'nav'>) {
  return <nav aria-label="breadcrumb" data-slot="breadcrumb" {...props} />
}

function BreadcrumbList({ className, ...props }: React.ComponentProps<'ol'>) {
  return (
    <ol
      data-slot="breadcrumb-list"
      className={cn(
        'text-muted-foreground flex flex-wrap items-center gap-1.5 text-sm break-words sm:gap-2.5',
        className,
      )}
      {...props}
    />
  )
}

function BreadcrumbItem({ className, ...props }: React.ComponentProps<'li'>) {
  return (
    <li
      data-slot="breadcrumb-item"
      className={cn('inline-flex items-center gap-1.5', className)}
      {...props}
    />
  )
}

function BreadcrumbLink({
  asChild,
  className,
  ...props
}: React.ComponentProps<'a'> & {
  asChild?: boolean
}) {
  const Comp = asChild ? Slot : 'a'

  return (
    <Comp
      data-slot="breadcrumb-link"
      className={cn('hover:text-foreground transition-colors', className)}
      {...props}
    />
  )
}

function BreadcrumbPage({ className, ...props }: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="breadcrumb-page"
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn('text-foreground font-normal', className)}
      {...props}
    />
  )
}

function BreadcrumbSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<'li'>) {
  return (
    <li
      data-slot="breadcrumb-separator"
      role="presentation"
      aria-hidden="true"
      className={cn('[&>svg]:size-3.5', className)}
      {...props}
    >
      {children ?? <ChevronRight />}
    </li>
  )
}

function BreadcrumbEllipsis({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="breadcrumb-ellipsis"
      role="presentation"
      aria-hidden="true"
      className={cn('flex size-9 items-center justify-center', className)}
      {...props}
    >
      <MoreHorizontal className="size-4" />
      <span className="sr-only">More</span>
    </span>
  )
}

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}
</file>

<file path="components/ui/button-group.tsx">
import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { Separator } from '@/components/ui/separator'

const buttonGroupVariants = cva(
  "flex w-fit items-stretch [&>*]:focus-visible:z-10 [&>*]:focus-visible:relative [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md has-[>[data-slot=button-group]]:gap-2",
  {
    variants: {
      orientation: {
        horizontal:
          '[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none',
        vertical:
          'flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none',
      },
    },
    defaultVariants: {
      orientation: 'horizontal',
    },
  },
)

function ButtonGroup({
  className,
  orientation,
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof buttonGroupVariants>) {
  return (
    <div
      role="group"
      data-slot="button-group"
      data-orientation={orientation}
      className={cn(buttonGroupVariants({ orientation }), className)}
      {...props}
    />
  )
}

function ButtonGroupText({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<'div'> & {
  asChild?: boolean
}) {
  const Comp = asChild ? Slot : 'div'

  return (
    <Comp
      className={cn(
        "bg-muted flex items-center gap-2 rounded-md border px-4 text-sm font-medium shadow-xs [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function ButtonGroupSeparator({
  className,
  orientation = 'vertical',
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="button-group-separator"
      orientation={orientation}
      className={cn(
        'bg-input relative !m-0 self-stretch data-[orientation=vertical]:h-auto',
        className,
      )}
      {...props}
    />
  )
}

export {
  ButtonGroup,
  ButtonGroupSeparator,
  ButtonGroupText,
  buttonGroupVariants,
}
</file>

<file path="components/ui/button.tsx">
import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive:
          'bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60',
        outline:
          'border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50',
        secondary:
          'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        ghost:
          'hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50',
        link: 'text-primary underline-offset-4 hover:underline',
      },
      size: {
        default: 'h-9 px-4 py-2 has-[>svg]:px-3',
        sm: 'h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5',
        lg: 'h-10 rounded-md px-6 has-[>svg]:px-4',
        icon: 'size-9',
        'icon-sm': 'size-8',
        'icon-lg': 'size-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<'button'> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : 'button'

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }
</file>

<file path="components/ui/calendar.tsx">
'use client'

import * as React from 'react'
import {
  ChevronDownIcon,
  ChevronLeftIcon,
  ChevronRightIcon,
} from 'lucide-react'
import { DayButton, DayPicker, getDefaultClassNames } from 'react-day-picker'

import { cn } from '@/lib/utils'
import { Button, buttonVariants } from '@/components/ui/button'

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  captionLayout = 'label',
  buttonVariant = 'ghost',
  formatters,
  components,
  ...props
}: React.ComponentProps<typeof DayPicker> & {
  buttonVariant?: React.ComponentProps<typeof Button>['variant']
}) {
  const defaultClassNames = getDefaultClassNames()

  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn(
        'bg-background group/calendar p-3 [--cell-size:--spacing(8)] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent',
        String.raw`rtl:**:[.rdp-button\_next>svg]:rotate-180`,
        String.raw`rtl:**:[.rdp-button\_previous>svg]:rotate-180`,
        className,
      )}
      captionLayout={captionLayout}
      formatters={{
        formatMonthDropdown: (date) =>
          date.toLocaleString('default', { month: 'short' }),
        ...formatters,
      }}
      classNames={{
        root: cn('w-fit', defaultClassNames.root),
        months: cn(
          'flex gap-4 flex-col md:flex-row relative',
          defaultClassNames.months,
        ),
        month: cn('flex flex-col w-full gap-4', defaultClassNames.month),
        nav: cn(
          'flex items-center gap-1 w-full absolute top-0 inset-x-0 justify-between',
          defaultClassNames.nav,
        ),
        button_previous: cn(
          buttonVariants({ variant: buttonVariant }),
          'size-(--cell-size) aria-disabled:opacity-50 p-0 select-none',
          defaultClassNames.button_previous,
        ),
        button_next: cn(
          buttonVariants({ variant: buttonVariant }),
          'size-(--cell-size) aria-disabled:opacity-50 p-0 select-none',
          defaultClassNames.button_next,
        ),
        month_caption: cn(
          'flex items-center justify-center h-(--cell-size) w-full px-(--cell-size)',
          defaultClassNames.month_caption,
        ),
        dropdowns: cn(
          'w-full flex items-center text-sm font-medium justify-center h-(--cell-size) gap-1.5',
          defaultClassNames.dropdowns,
        ),
        dropdown_root: cn(
          'relative has-focus:border-ring border border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] rounded-md',
          defaultClassNames.dropdown_root,
        ),
        dropdown: cn(
          'absolute bg-popover inset-0 opacity-0',
          defaultClassNames.dropdown,
        ),
        caption_label: cn(
          'select-none font-medium',
          captionLayout === 'label'
            ? 'text-sm'
            : 'rounded-md pl-2 pr-1 flex items-center gap-1 text-sm h-8 [&>svg]:text-muted-foreground [&>svg]:size-3.5',
          defaultClassNames.caption_label,
        ),
        table: 'w-full border-collapse',
        weekdays: cn('flex', defaultClassNames.weekdays),
        weekday: cn(
          'text-muted-foreground rounded-md flex-1 font-normal text-[0.8rem] select-none',
          defaultClassNames.weekday,
        ),
        week: cn('flex w-full mt-2', defaultClassNames.week),
        week_number_header: cn(
          'select-none w-(--cell-size)',
          defaultClassNames.week_number_header,
        ),
        week_number: cn(
          'text-[0.8rem] select-none text-muted-foreground',
          defaultClassNames.week_number,
        ),
        day: cn(
          'relative w-full h-full p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md group/day aspect-square select-none',
          defaultClassNames.day,
        ),
        range_start: cn(
          'rounded-l-md bg-accent',
          defaultClassNames.range_start,
        ),
        range_middle: cn('rounded-none', defaultClassNames.range_middle),
        range_end: cn('rounded-r-md bg-accent', defaultClassNames.range_end),
        today: cn(
          'bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none',
          defaultClassNames.today,
        ),
        outside: cn(
          'text-muted-foreground aria-selected:text-muted-foreground',
          defaultClassNames.outside,
        ),
        disabled: cn(
          'text-muted-foreground opacity-50',
          defaultClassNames.disabled,
        ),
        hidden: cn('invisible', defaultClassNames.hidden),
        ...classNames,
      }}
      components={{
        Root: ({ className, rootRef, ...props }) => {
          return (
            <div
              data-slot="calendar"
              ref={rootRef}
              className={cn(className)}
              {...props}
            />
          )
        },
        Chevron: ({ className, orientation, ...props }) => {
          if (orientation === 'left') {
            return (
              <ChevronLeftIcon className={cn('size-4', className)} {...props} />
            )
          }

          if (orientation === 'right') {
            return (
              <ChevronRightIcon
                className={cn('size-4', className)}
                {...props}
              />
            )
          }

          return (
            <ChevronDownIcon className={cn('size-4', className)} {...props} />
          )
        },
        DayButton: CalendarDayButton,
        WeekNumber: ({ children, ...props }) => {
          return (
            <td {...props}>
              <div className="flex size-(--cell-size) items-center justify-center text-center">
                {children}
              </div>
            </td>
          )
        },
        ...components,
      }}
      {...props}
    />
  )
}

function CalendarDayButton({
  className,
  day,
  modifiers,
  ...props
}: React.ComponentProps<typeof DayButton>) {
  const defaultClassNames = getDefaultClassNames()

  const ref = React.useRef<HTMLButtonElement>(null)
  React.useEffect(() => {
    if (modifiers.focused) ref.current?.focus()
  }, [modifiers.focused])

  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      data-day={day.date.toLocaleDateString()}
      data-selected-single={
        modifiers.selected &&
        !modifiers.range_start &&
        !modifiers.range_end &&
        !modifiers.range_middle
      }
      data-range-start={modifiers.range_start}
      data-range-end={modifiers.range_end}
      data-range-middle={modifiers.range_middle}
      className={cn(
        'data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 dark:hover:text-accent-foreground flex aspect-square size-auto w-full min-w-(--cell-size) flex-col gap-1 leading-none font-normal group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] data-[range-end=true]:rounded-md data-[range-end=true]:rounded-r-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md data-[range-start=true]:rounded-l-md [&>span]:text-xs [&>span]:opacity-70',
        defaultClassNames.day,
        className,
      )}
      {...props}
    />
  )
}

export { Calendar, CalendarDayButton }
</file>

<file path="components/ui/card.tsx">
import * as React from 'react'

import { cn } from '@/lib/utils'

function Card({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card"
      className={cn(
        'bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm',
        className,
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        '@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6',
        className,
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-title"
      className={cn('leading-none font-semibold', className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        'col-start-2 row-span-2 row-start-1 self-start justify-self-end',
        className,
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-content"
      className={cn('px-6', className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="card-footer"
      className={cn('flex items-center px-6 [.border-t]:pt-6', className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
</file>

<file path="components/ui/carousel.tsx">
'use client'

import * as React from 'react'
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from 'embla-carousel-react'
import { ArrowLeft, ArrowRight } from 'lucide-react'

import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: 'horizontal' | 'vertical'
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error('useCarousel must be used within a <Carousel />')
  }

  return context
}

function Carousel({
  orientation = 'horizontal',
  opts,
  setApi,
  plugins,
  className,
  children,
  ...props
}: React.ComponentProps<'div'> & CarouselProps) {
  const [carouselRef, api] = useEmblaCarousel(
    {
      ...opts,
      axis: orientation === 'horizontal' ? 'x' : 'y',
    },
    plugins,
  )
  const [canScrollPrev, setCanScrollPrev] = React.useState(false)
  const [canScrollNext, setCanScrollNext] = React.useState(false)

  const onSelect = React.useCallback((api: CarouselApi) => {
    if (!api) return
    setCanScrollPrev(api.canScrollPrev())
    setCanScrollNext(api.canScrollNext())
  }, [])

  const scrollPrev = React.useCallback(() => {
    api?.scrollPrev()
  }, [api])

  const scrollNext = React.useCallback(() => {
    api?.scrollNext()
  }, [api])

  const handleKeyDown = React.useCallback(
    (event: React.KeyboardEvent<HTMLDivElement>) => {
      if (event.key === 'ArrowLeft') {
        event.preventDefault()
        scrollPrev()
      } else if (event.key === 'ArrowRight') {
        event.preventDefault()
        scrollNext()
      }
    },
    [scrollPrev, scrollNext],
  )

  React.useEffect(() => {
    if (!api || !setApi) return
    setApi(api)
  }, [api, setApi])

  React.useEffect(() => {
    if (!api) return
    onSelect(api)
    api.on('reInit', onSelect)
    api.on('select', onSelect)

    return () => {
      api?.off('select', onSelect)
    }
  }, [api, onSelect])

  return (
    <CarouselContext.Provider
      value={{
        carouselRef,
        api: api,
        opts,
        orientation:
          orientation || (opts?.axis === 'y' ? 'vertical' : 'horizontal'),
        scrollPrev,
        scrollNext,
        canScrollPrev,
        canScrollNext,
      }}
    >
      <div
        onKeyDownCapture={handleKeyDown}
        className={cn('relative', className)}
        role="region"
        aria-roledescription="carousel"
        data-slot="carousel"
        {...props}
      >
        {children}
      </div>
    </CarouselContext.Provider>
  )
}

function CarouselContent({ className, ...props }: React.ComponentProps<'div'>) {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div
      ref={carouselRef}
      className="overflow-hidden"
      data-slot="carousel-content"
    >
      <div
        className={cn(
          'flex',
          orientation === 'horizontal' ? '-ml-4' : '-mt-4 flex-col',
          className,
        )}
        {...props}
      />
    </div>
  )
}

function CarouselItem({ className, ...props }: React.ComponentProps<'div'>) {
  const { orientation } = useCarousel()

  return (
    <div
      role="group"
      aria-roledescription="slide"
      data-slot="carousel-item"
      className={cn(
        'min-w-0 shrink-0 grow-0 basis-full',
        orientation === 'horizontal' ? 'pl-4' : 'pt-4',
        className,
      )}
      {...props}
    />
  )
}

function CarouselPrevious({
  className,
  variant = 'outline',
  size = 'icon',
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      data-slot="carousel-previous"
      variant={variant}
      size={size}
      className={cn(
        'absolute size-8 rounded-full',
        orientation === 'horizontal'
          ? 'top-1/2 -left-12 -translate-y-1/2'
          : '-top-12 left-1/2 -translate-x-1/2 rotate-90',
        className,
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
}

function CarouselNext({
  className,
  variant = 'outline',
  size = 'icon',
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      data-slot="carousel-next"
      variant={variant}
      size={size}
      className={cn(
        'absolute size-8 rounded-full',
        orientation === 'horizontal'
          ? 'top-1/2 -right-12 -translate-y-1/2'
          : '-bottom-12 left-1/2 -translate-x-1/2 rotate-90',
        className,
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight />
      <span className="sr-only">Next slide</span>
    </Button>
  )
}

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}
</file>

<file path="components/ui/chart.tsx">
'use client'

import * as React from 'react'
import * as RechartsPrimitive from 'recharts'

import { cn } from '@/lib/utils'

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: '', dark: '.dark' } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error('useChart must be used within a <ChartContainer />')
  }

  return context
}

function ChartContainer({
  id,
  className,
  children,
  config,
  ...props
}: React.ComponentProps<'div'> & {
  config: ChartConfig
  children: React.ComponentProps<
    typeof RechartsPrimitive.ResponsiveContainer
  >['children']
}) {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, '')}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-slot="chart"
        data-chart={chartId}
        className={cn(
          "[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden",
          className,
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
}

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color,
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color
    return color ? `  --color-${key}: ${color};` : null
  })
  .join('\n')}
}
`,
          )
          .join('\n'),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

function ChartTooltipContent({
  active,
  payload,
  className,
  indicator = 'dot',
  hideLabel = false,
  hideIndicator = false,
  label,
  labelFormatter,
  labelClassName,
  formatter,
  color,
  nameKey,
  labelKey,
}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
  React.ComponentProps<'div'> & {
    hideLabel?: boolean
    hideIndicator?: boolean
    indicator?: 'line' | 'dot' | 'dashed'
    nameKey?: string
    labelKey?: string
  }) {
  const { config } = useChart()

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null
    }

    const [item] = payload
    const key = `${labelKey || item?.dataKey || item?.name || 'value'}`
    const itemConfig = getPayloadConfigFromPayload(config, item, key)
    const value =
      !labelKey && typeof label === 'string'
        ? config[label as keyof typeof config]?.label || label
        : itemConfig?.label

    if (labelFormatter) {
      return (
        <div className={cn('font-medium', labelClassName)}>
          {labelFormatter(value, payload)}
        </div>
      )
    }

    if (!value) {
      return null
    }

    return <div className={cn('font-medium', labelClassName)}>{value}</div>
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ])

  if (!active || !payload?.length) {
    return null
  }

  const nestLabel = payload.length === 1 && indicator !== 'dot'

  return (
    <div
      className={cn(
        'border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl',
        className,
      )}
    >
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload.map((item, index) => {
          const key = `${nameKey || item.name || item.dataKey || 'value'}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)
          const indicatorColor = color || item.payload.fill || item.color

          return (
            <div
              key={item.dataKey}
              className={cn(
                '[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5',
                indicator === 'dot' && 'items-center',
              )}
            >
              {formatter && item?.value !== undefined && item.name ? (
                formatter(item.value, item.name, item, index, item.payload)
              ) : (
                <>
                  {itemConfig?.icon ? (
                    <itemConfig.icon />
                  ) : (
                    !hideIndicator && (
                      <div
                        className={cn(
                          'shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)',
                          {
                            'h-2.5 w-2.5': indicator === 'dot',
                            'w-1': indicator === 'line',
                            'w-0 border-[1.5px] border-dashed bg-transparent':
                              indicator === 'dashed',
                            'my-0.5': nestLabel && indicator === 'dashed',
                          },
                        )}
                        style={
                          {
                            '--color-bg': indicatorColor,
                            '--color-border': indicatorColor,
                          } as React.CSSProperties
                        }
                      />
                    )
                  )}
                  <div
                    className={cn(
                      'flex flex-1 justify-between leading-none',
                      nestLabel ? 'items-end' : 'items-center',
                    )}
                  >
                    <div className="grid gap-1.5">
                      {nestLabel ? tooltipLabel : null}
                      <span className="text-muted-foreground">
                        {itemConfig?.label || item.name}
                      </span>
                    </div>
                    {item.value && (
                      <span className="text-foreground font-mono font-medium tabular-nums">
                        {item.value.toLocaleString()}
                      </span>
                    )}
                  </div>
                </>
              )}
            </div>
          )
        })}
      </div>
    </div>
  )
}

const ChartLegend = RechartsPrimitive.Legend

function ChartLegendContent({
  className,
  hideIcon = false,
  payload,
  verticalAlign = 'bottom',
  nameKey,
}: React.ComponentProps<'div'> &
  Pick<RechartsPrimitive.LegendProps, 'payload' | 'verticalAlign'> & {
    hideIcon?: boolean
    nameKey?: string
  }) {
  const { config } = useChart()

  if (!payload?.length) {
    return null
  }

  return (
    <div
      className={cn(
        'flex items-center justify-center gap-4',
        verticalAlign === 'top' ? 'pb-3' : 'pt-3',
        className,
      )}
    >
      {payload.map((item) => {
        const key = `${nameKey || item.dataKey || 'value'}`
        const itemConfig = getPayloadConfigFromPayload(config, item, key)

        return (
          <div
            key={item.value}
            className={
              '[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3'
            }
          >
            {itemConfig?.icon && !hideIcon ? (
              <itemConfig.icon />
            ) : (
              <div
                className="h-2 w-2 shrink-0 rounded-[2px]"
                style={{
                  backgroundColor: item.color,
                }}
              />
            )}
            {itemConfig?.label}
          </div>
        )
      })}
    </div>
  )
}

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string,
) {
  if (typeof payload !== 'object' || payload === null) {
    return undefined
  }

  const payloadPayload =
    'payload' in payload &&
    typeof payload.payload === 'object' &&
    payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === 'string'
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === 'string'
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}
</file>

<file path="components/ui/checkbox.tsx">
'use client'

import * as React from 'react'
import * as CheckboxPrimitive from '@radix-ui/react-checkbox'
import { CheckIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        'peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50',
        className,
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="flex items-center justify-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
</file>

<file path="components/ui/collapsible.tsx">
'use client'

import * as CollapsiblePrimitive from '@radix-ui/react-collapsible'

function Collapsible({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.Root>) {
  return <CollapsiblePrimitive.Root data-slot="collapsible" {...props} />
}

function CollapsibleTrigger({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleTrigger>) {
  return (
    <CollapsiblePrimitive.CollapsibleTrigger
      data-slot="collapsible-trigger"
      {...props}
    />
  )
}

function CollapsibleContent({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleContent>) {
  return (
    <CollapsiblePrimitive.CollapsibleContent
      data-slot="collapsible-content"
      {...props}
    />
  )
}

export { Collapsible, CollapsibleTrigger, CollapsibleContent }
</file>

<file path="components/ui/command.tsx">
'use client'

import * as React from 'react'
import { Command as CommandPrimitive } from 'cmdk'
import { SearchIcon } from 'lucide-react'

import { cn } from '@/lib/utils'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'

function Command({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive>) {
  return (
    <CommandPrimitive
      data-slot="command"
      className={cn(
        'bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md',
        className,
      )}
      {...props}
    />
  )
}

function CommandDialog({
  title = 'Command Palette',
  description = 'Search for a command to run...',
  children,
  className,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof Dialog> & {
  title?: string
  description?: string
  className?: string
  showCloseButton?: boolean
}) {
  return (
    <Dialog {...props}>
      <DialogHeader className="sr-only">
        <DialogTitle>{title}</DialogTitle>
        <DialogDescription>{description}</DialogDescription>
      </DialogHeader>
      <DialogContent
        className={cn('overflow-hidden p-0', className)}
        showCloseButton={showCloseButton}
      >
        <Command className="[&_[cmdk-group-heading]]:text-muted-foreground **:data-[slot=command-input-wrapper]:h-12 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group]]:px-2 [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

function CommandInput({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Input>) {
  return (
    <div
      data-slot="command-input-wrapper"
      className="flex h-9 items-center gap-2 border-b px-3"
    >
      <SearchIcon className="size-4 shrink-0 opacity-50" />
      <CommandPrimitive.Input
        data-slot="command-input"
        className={cn(
          'placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50',
          className,
        )}
        {...props}
      />
    </div>
  )
}

function CommandList({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.List>) {
  return (
    <CommandPrimitive.List
      data-slot="command-list"
      className={cn(
        'max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto',
        className,
      )}
      {...props}
    />
  )
}

function CommandEmpty({
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Empty>) {
  return (
    <CommandPrimitive.Empty
      data-slot="command-empty"
      className="py-6 text-center text-sm"
      {...props}
    />
  )
}

function CommandGroup({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Group>) {
  return (
    <CommandPrimitive.Group
      data-slot="command-group"
      className={cn(
        'text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium',
        className,
      )}
      {...props}
    />
  )
}

function CommandSeparator({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Separator>) {
  return (
    <CommandPrimitive.Separator
      data-slot="command-separator"
      className={cn('bg-border -mx-1 h-px', className)}
      {...props}
    />
  )
}

function CommandItem({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Item>) {
  return (
    <CommandPrimitive.Item
      data-slot="command-item"
      className={cn(
        "data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function CommandShortcut({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="command-shortcut"
      className={cn(
        'text-muted-foreground ml-auto text-xs tracking-widest',
        className,
      )}
      {...props}
    />
  )
}

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}
</file>

<file path="components/ui/context-menu.tsx">
'use client'

import * as React from 'react'
import * as ContextMenuPrimitive from '@radix-ui/react-context-menu'
import { CheckIcon, ChevronRightIcon, CircleIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function ContextMenu({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Root>) {
  return <ContextMenuPrimitive.Root data-slot="context-menu" {...props} />
}

function ContextMenuTrigger({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Trigger>) {
  return (
    <ContextMenuPrimitive.Trigger data-slot="context-menu-trigger" {...props} />
  )
}

function ContextMenuGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Group>) {
  return (
    <ContextMenuPrimitive.Group data-slot="context-menu-group" {...props} />
  )
}

function ContextMenuPortal({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Portal>) {
  return (
    <ContextMenuPrimitive.Portal data-slot="context-menu-portal" {...props} />
  )
}

function ContextMenuSub({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Sub>) {
  return <ContextMenuPrimitive.Sub data-slot="context-menu-sub" {...props} />
}

function ContextMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioGroup>) {
  return (
    <ContextMenuPrimitive.RadioGroup
      data-slot="context-menu-radio-group"
      {...props}
    />
  )
}

function ContextMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <ContextMenuPrimitive.SubTrigger
      data-slot="context-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto" />
    </ContextMenuPrimitive.SubTrigger>
  )
}

function ContextMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubContent>) {
  return (
    <ContextMenuPrimitive.SubContent
      data-slot="context-menu-sub-content"
      className={cn(
        'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg',
        className,
      )}
      {...props}
    />
  )
}

function ContextMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Content>) {
  return (
    <ContextMenuPrimitive.Portal>
      <ContextMenuPrimitive.Content
        data-slot="context-menu-content"
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-context-menu-content-available-height) min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md',
          className,
        )}
        {...props}
      />
    </ContextMenuPrimitive.Portal>
  )
}

function ContextMenuItem({
  className,
  inset,
  variant = 'default',
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Item> & {
  inset?: boolean
  variant?: 'default' | 'destructive'
}) {
  return (
    <ContextMenuPrimitive.Item
      data-slot="context-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function ContextMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.CheckboxItem>) {
  return (
    <ContextMenuPrimitive.CheckboxItem
      data-slot="context-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.CheckboxItem>
  )
}

function ContextMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioItem>) {
  return (
    <ContextMenuPrimitive.RadioItem
      data-slot="context-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.RadioItem>
  )
}

function ContextMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <ContextMenuPrimitive.Label
      data-slot="context-menu-label"
      data-inset={inset}
      className={cn(
        'text-foreground px-2 py-1.5 text-sm font-medium data-[inset]:pl-8',
        className,
      )}
      {...props}
    />
  )
}

function ContextMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Separator>) {
  return (
    <ContextMenuPrimitive.Separator
      data-slot="context-menu-separator"
      className={cn('bg-border -mx-1 my-1 h-px', className)}
      {...props}
    />
  )
}

function ContextMenuShortcut({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="context-menu-shortcut"
      className={cn(
        'text-muted-foreground ml-auto text-xs tracking-widest',
        className,
      )}
      {...props}
    />
  )
}

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
}
</file>

<file path="components/ui/dialog.tsx">
'use client'

import * as React from 'react'
import * as DialogPrimitive from '@radix-ui/react-dialog'
import { XIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50',
        className,
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean
}) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          'bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg',
          className,
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

function DialogHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="dialog-header"
      className={cn('flex flex-col gap-2 text-center sm:text-left', className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        'flex flex-col-reverse gap-2 sm:flex-row sm:justify-end',
        className,
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn('text-lg leading-none font-semibold', className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
</file>

<file path="components/ui/drawer.tsx">
'use client'

import * as React from 'react'
import { Drawer as DrawerPrimitive } from 'vaul'

import { cn } from '@/lib/utils'

function Drawer({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) {
  return <DrawerPrimitive.Root data-slot="drawer" {...props} />
}

function DrawerTrigger({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Trigger>) {
  return <DrawerPrimitive.Trigger data-slot="drawer-trigger" {...props} />
}

function DrawerPortal({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Portal>) {
  return <DrawerPrimitive.Portal data-slot="drawer-portal" {...props} />
}

function DrawerClose({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Close>) {
  return <DrawerPrimitive.Close data-slot="drawer-close" {...props} />
}

function DrawerOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Overlay>) {
  return (
    <DrawerPrimitive.Overlay
      data-slot="drawer-overlay"
      className={cn(
        'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50',
        className,
      )}
      {...props}
    />
  )
}

function DrawerContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Content>) {
  return (
    <DrawerPortal data-slot="drawer-portal">
      <DrawerOverlay />
      <DrawerPrimitive.Content
        data-slot="drawer-content"
        className={cn(
          'group/drawer-content bg-background fixed z-50 flex h-auto flex-col',
          'data-[vaul-drawer-direction=top]:inset-x-0 data-[vaul-drawer-direction=top]:top-0 data-[vaul-drawer-direction=top]:mb-24 data-[vaul-drawer-direction=top]:max-h-[80vh] data-[vaul-drawer-direction=top]:rounded-b-lg data-[vaul-drawer-direction=top]:border-b',
          'data-[vaul-drawer-direction=bottom]:inset-x-0 data-[vaul-drawer-direction=bottom]:bottom-0 data-[vaul-drawer-direction=bottom]:mt-24 data-[vaul-drawer-direction=bottom]:max-h-[80vh] data-[vaul-drawer-direction=bottom]:rounded-t-lg data-[vaul-drawer-direction=bottom]:border-t',
          'data-[vaul-drawer-direction=right]:inset-y-0 data-[vaul-drawer-direction=right]:right-0 data-[vaul-drawer-direction=right]:w-3/4 data-[vaul-drawer-direction=right]:border-l data-[vaul-drawer-direction=right]:sm:max-w-sm',
          'data-[vaul-drawer-direction=left]:inset-y-0 data-[vaul-drawer-direction=left]:left-0 data-[vaul-drawer-direction=left]:w-3/4 data-[vaul-drawer-direction=left]:border-r data-[vaul-drawer-direction=left]:sm:max-w-sm',
          className,
        )}
        {...props}
      >
        <div className="bg-muted mx-auto mt-4 hidden h-2 w-[100px] shrink-0 rounded-full group-data-[vaul-drawer-direction=bottom]/drawer-content:block" />
        {children}
      </DrawerPrimitive.Content>
    </DrawerPortal>
  )
}

function DrawerHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="drawer-header"
      className={cn(
        'flex flex-col gap-0.5 p-4 group-data-[vaul-drawer-direction=bottom]/drawer-content:text-center group-data-[vaul-drawer-direction=top]/drawer-content:text-center md:gap-1.5 md:text-left',
        className,
      )}
      {...props}
    />
  )
}

function DrawerFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="drawer-footer"
      className={cn('mt-auto flex flex-col gap-2 p-4', className)}
      {...props}
    />
  )
}

function DrawerTitle({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Title>) {
  return (
    <DrawerPrimitive.Title
      data-slot="drawer-title"
      className={cn('text-foreground font-semibold', className)}
      {...props}
    />
  )
}

function DrawerDescription({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Description>) {
  return (
    <DrawerPrimitive.Description
      data-slot="drawer-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
}
</file>

<file path="components/ui/dropdown-menu.tsx">
'use client'

import * as React from 'react'
import * as DropdownMenuPrimitive from '@radix-ui/react-dropdown-menu'
import { CheckIcon, ChevronRightIcon, CircleIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md',
          className,
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}

function DropdownMenuItem({
  className,
  inset,
  variant = 'default',
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: 'default' | 'destructive'
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        'px-2 py-1.5 text-sm font-medium data-[inset]:pl-8',
        className,
      )}
      {...props}
    />
  )
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn('bg-border -mx-1 my-1 h-px', className)}
      {...props}
    />
  )
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        'text-muted-foreground ml-auto text-xs tracking-widest',
        className,
      )}
      {...props}
    />
  )
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg',
        className,
      )}
      {...props}
    />
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
</file>

<file path="components/ui/empty.tsx">
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

function Empty({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="empty"
      className={cn(
        'flex min-w-0 flex-1 flex-col items-center justify-center gap-6 rounded-lg border-dashed p-6 text-center text-balance md:p-12',
        className,
      )}
      {...props}
    />
  )
}

function EmptyHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="empty-header"
      className={cn(
        'flex max-w-sm flex-col items-center gap-2 text-center',
        className,
      )}
      {...props}
    />
  )
}

const emptyMediaVariants = cva(
  'flex shrink-0 items-center justify-center mb-2 [&_svg]:pointer-events-none [&_svg]:shrink-0',
  {
    variants: {
      variant: {
        default: 'bg-transparent',
        icon: "bg-muted text-foreground flex size-10 shrink-0 items-center justify-center rounded-lg [&_svg:not([class*='size-'])]:size-6",
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

function EmptyMedia({
  className,
  variant = 'default',
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof emptyMediaVariants>) {
  return (
    <div
      data-slot="empty-icon"
      data-variant={variant}
      className={cn(emptyMediaVariants({ variant, className }))}
      {...props}
    />
  )
}

function EmptyTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="empty-title"
      className={cn('text-lg font-medium tracking-tight', className)}
      {...props}
    />
  )
}

function EmptyDescription({ className, ...props }: React.ComponentProps<'p'>) {
  return (
    <div
      data-slot="empty-description"
      className={cn(
        'text-muted-foreground [&>a:hover]:text-primary text-sm/relaxed [&>a]:underline [&>a]:underline-offset-4',
        className,
      )}
      {...props}
    />
  )
}

function EmptyContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="empty-content"
      className={cn(
        'flex w-full max-w-sm min-w-0 flex-col items-center gap-4 text-sm text-balance',
        className,
      )}
      {...props}
    />
  )
}

export {
  Empty,
  EmptyHeader,
  EmptyTitle,
  EmptyDescription,
  EmptyContent,
  EmptyMedia,
}
</file>

<file path="components/ui/field.tsx">
'use client'

import { useMemo } from 'react'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { Label } from '@/components/ui/label'
import { Separator } from '@/components/ui/separator'

function FieldSet({ className, ...props }: React.ComponentProps<'fieldset'>) {
  return (
    <fieldset
      data-slot="field-set"
      className={cn(
        'flex flex-col gap-6',
        'has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3',
        className,
      )}
      {...props}
    />
  )
}

function FieldLegend({
  className,
  variant = 'legend',
  ...props
}: React.ComponentProps<'legend'> & { variant?: 'legend' | 'label' }) {
  return (
    <legend
      data-slot="field-legend"
      data-variant={variant}
      className={cn(
        'mb-3 font-medium',
        'data-[variant=legend]:text-base',
        'data-[variant=label]:text-sm',
        className,
      )}
      {...props}
    />
  )
}

function FieldGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="field-group"
      className={cn(
        'group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4',
        className,
      )}
      {...props}
    />
  )
}

const fieldVariants = cva(
  'group/field flex w-full gap-3 data-[invalid=true]:text-destructive',
  {
    variants: {
      orientation: {
        vertical: ['flex-col [&>*]:w-full [&>.sr-only]:w-auto'],
        horizontal: [
          'flex-row items-center',
          '[&>[data-slot=field-label]]:flex-auto',
          'has-[>[data-slot=field-content]]:items-start has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px',
        ],
        responsive: [
          'flex-col [&>*]:w-full [&>.sr-only]:w-auto @md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto',
          '@md/field-group:[&>[data-slot=field-label]]:flex-auto',
          '@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px',
        ],
      },
    },
    defaultVariants: {
      orientation: 'vertical',
    },
  },
)

function Field({
  className,
  orientation = 'vertical',
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof fieldVariants>) {
  return (
    <div
      role="group"
      data-slot="field"
      data-orientation={orientation}
      className={cn(fieldVariants({ orientation }), className)}
      {...props}
    />
  )
}

function FieldContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="field-content"
      className={cn(
        'group/field-content flex flex-1 flex-col gap-1.5 leading-snug',
        className,
      )}
      {...props}
    />
  )
}

function FieldLabel({
  className,
  ...props
}: React.ComponentProps<typeof Label>) {
  return (
    <Label
      data-slot="field-label"
      className={cn(
        'group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50',
        'has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>*]:data-[slot=field]:p-4',
        'has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10',
        className,
      )}
      {...props}
    />
  )
}

function FieldTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="field-label"
      className={cn(
        'flex w-fit items-center gap-2 text-sm leading-snug font-medium group-data-[disabled=true]/field:opacity-50',
        className,
      )}
      {...props}
    />
  )
}

function FieldDescription({ className, ...props }: React.ComponentProps<'p'>) {
  return (
    <p
      data-slot="field-description"
      className={cn(
        'text-muted-foreground text-sm leading-normal font-normal group-has-[[data-orientation=horizontal]]/field:text-balance',
        'last:mt-0 nth-last-2:-mt-1 [[data-variant=legend]+&]:-mt-1.5',
        '[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4',
        className,
      )}
      {...props}
    />
  )
}

function FieldSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<'div'> & {
  children?: React.ReactNode
}) {
  return (
    <div
      data-slot="field-separator"
      data-content={!!children}
      className={cn(
        'relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2',
        className,
      )}
      {...props}
    >
      <Separator className="absolute inset-0 top-1/2" />
      {children && (
        <span
          className="bg-background text-muted-foreground relative mx-auto block w-fit px-2"
          data-slot="field-separator-content"
        >
          {children}
        </span>
      )}
    </div>
  )
}

function FieldError({
  className,
  children,
  errors,
  ...props
}: React.ComponentProps<'div'> & {
  errors?: Array<{ message?: string } | undefined>
}) {
  const content = useMemo(() => {
    if (children) {
      return children
    }

    if (!errors) {
      return null
    }

    if (errors.length === 1 && errors[0]?.message) {
      return errors[0].message
    }

    return (
      <ul className="ml-4 flex list-disc flex-col gap-1">
        {errors.map(
          (error, index) =>
            error?.message && <li key={index}>{error.message}</li>,
        )}
      </ul>
    )
  }, [children, errors])

  if (!content) {
    return null
  }

  return (
    <div
      role="alert"
      data-slot="field-error"
      className={cn('text-destructive text-sm font-normal', className)}
      {...props}
    >
      {content}
    </div>
  )
}

export {
  Field,
  FieldLabel,
  FieldDescription,
  FieldError,
  FieldGroup,
  FieldLegend,
  FieldSeparator,
  FieldSet,
  FieldContent,
  FieldTitle,
}
</file>

<file path="components/ui/form.tsx">
'use client'

import * as React from 'react'
import * as LabelPrimitive from '@radix-ui/react-label'
import { Slot } from '@radix-ui/react-slot'
import {
  Controller,
  FormProvider,
  useFormContext,
  useFormState,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from 'react-hook-form'

import { cn } from '@/lib/utils'
import { Label } from '@/components/ui/label'

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue,
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState } = useFormContext()
  const formState = useFormState({ name: fieldContext.name })
  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error('useFormField should be used within <FormField>')
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue,
)

function FormItem({ className, ...props }: React.ComponentProps<'div'>) {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div
        data-slot="form-item"
        className={cn('grid gap-2', className)}
        {...props}
      />
    </FormItemContext.Provider>
  )
}

function FormLabel({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  const { error, formItemId } = useFormField()

  return (
    <Label
      data-slot="form-label"
      data-error={!!error}
      className={cn('data-[error=true]:text-destructive', className)}
      htmlFor={formItemId}
      {...props}
    />
  )
}

function FormControl({ ...props }: React.ComponentProps<typeof Slot>) {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      data-slot="form-control"
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
}

function FormDescription({ className, ...props }: React.ComponentProps<'p'>) {
  const { formDescriptionId } = useFormField()

  return (
    <p
      data-slot="form-description"
      id={formDescriptionId}
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

function FormMessage({ className, ...props }: React.ComponentProps<'p'>) {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? '') : props.children

  if (!body) {
    return null
  }

  return (
    <p
      data-slot="form-message"
      id={formMessageId}
      className={cn('text-destructive text-sm', className)}
      {...props}
    >
      {body}
    </p>
  )
}

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}
</file>

<file path="components/ui/hover-card.tsx">
'use client'

import * as React from 'react'
import * as HoverCardPrimitive from '@radix-ui/react-hover-card'

import { cn } from '@/lib/utils'

function HoverCard({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Root>) {
  return <HoverCardPrimitive.Root data-slot="hover-card" {...props} />
}

function HoverCardTrigger({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Trigger>) {
  return (
    <HoverCardPrimitive.Trigger data-slot="hover-card-trigger" {...props} />
  )
}

function HoverCardContent({
  className,
  align = 'center',
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Content>) {
  return (
    <HoverCardPrimitive.Portal data-slot="hover-card-portal">
      <HoverCardPrimitive.Content
        data-slot="hover-card-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-64 origin-(--radix-hover-card-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden',
          className,
        )}
        {...props}
      />
    </HoverCardPrimitive.Portal>
  )
}

export { HoverCard, HoverCardTrigger, HoverCardContent }
</file>

<file path="components/ui/input-group.tsx">
'use client'

import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Textarea } from '@/components/ui/textarea'

function InputGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="input-group"
      role="group"
      className={cn(
        'group/input-group border-input dark:bg-input/30 relative flex w-full items-center rounded-md border shadow-xs transition-[color,box-shadow] outline-none',
        'h-9 has-[>textarea]:h-auto',

        // Variants based on alignment.
        'has-[>[data-align=inline-start]]:[&>input]:pl-2',
        'has-[>[data-align=inline-end]]:[&>input]:pr-2',
        'has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3',
        'has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3',

        // Focus state.
        'has-[[data-slot=input-group-control]:focus-visible]:border-ring has-[[data-slot=input-group-control]:focus-visible]:ring-ring/50 has-[[data-slot=input-group-control]:focus-visible]:ring-[3px]',

        // Error state.
        'has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40',

        className,
      )}
      {...props}
    />
  )
}

const inputGroupAddonVariants = cva(
  "text-muted-foreground flex h-auto cursor-text items-center justify-center gap-2 py-1.5 text-sm font-medium select-none [&>svg:not([class*='size-'])]:size-4 [&>kbd]:rounded-[calc(var(--radius)-5px)] group-data-[disabled=true]/input-group:opacity-50",
  {
    variants: {
      align: {
        'inline-start':
          'order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]',
        'inline-end':
          'order-last pr-3 has-[>button]:mr-[-0.4rem] has-[>kbd]:mr-[-0.35rem]',
        'block-start':
          'order-first w-full justify-start px-3 pt-3 [.border-b]:pb-3 group-has-[>input]/input-group:pt-2.5',
        'block-end':
          'order-last w-full justify-start px-3 pb-3 [.border-t]:pt-3 group-has-[>input]/input-group:pb-2.5',
      },
    },
    defaultVariants: {
      align: 'inline-start',
    },
  },
)

function InputGroupAddon({
  className,
  align = 'inline-start',
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof inputGroupAddonVariants>) {
  return (
    <div
      role="group"
      data-slot="input-group-addon"
      data-align={align}
      className={cn(inputGroupAddonVariants({ align }), className)}
      onClick={(e) => {
        if ((e.target as HTMLElement).closest('button')) {
          return
        }
        e.currentTarget.parentElement?.querySelector('input')?.focus()
      }}
      {...props}
    />
  )
}

const inputGroupButtonVariants = cva(
  'text-sm shadow-none flex gap-2 items-center',
  {
    variants: {
      size: {
        xs: "h-6 gap-1 px-2 rounded-[calc(var(--radius)-5px)] [&>svg:not([class*='size-'])]:size-3.5 has-[>svg]:px-2",
        sm: 'h-8 px-2.5 gap-1.5 rounded-md has-[>svg]:px-2.5',
        'icon-xs':
          'size-6 rounded-[calc(var(--radius)-5px)] p-0 has-[>svg]:p-0',
        'icon-sm': 'size-8 p-0 has-[>svg]:p-0',
      },
    },
    defaultVariants: {
      size: 'xs',
    },
  },
)

function InputGroupButton({
  className,
  type = 'button',
  variant = 'ghost',
  size = 'xs',
  ...props
}: Omit<React.ComponentProps<typeof Button>, 'size'> &
  VariantProps<typeof inputGroupButtonVariants>) {
  return (
    <Button
      type={type}
      data-size={size}
      variant={variant}
      className={cn(inputGroupButtonVariants({ size }), className)}
      {...props}
    />
  )
}

function InputGroupText({ className, ...props }: React.ComponentProps<'span'>) {
  return (
    <span
      className={cn(
        "text-muted-foreground flex items-center gap-2 text-sm [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function InputGroupInput({
  className,
  ...props
}: React.ComponentProps<'input'>) {
  return (
    <Input
      data-slot="input-group-control"
      className={cn(
        'flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent',
        className,
      )}
      {...props}
    />
  )
}

function InputGroupTextarea({
  className,
  ...props
}: React.ComponentProps<'textarea'>) {
  return (
    <Textarea
      data-slot="input-group-control"
      className={cn(
        'flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent',
        className,
      )}
      {...props}
    />
  )
}

export {
  InputGroup,
  InputGroupAddon,
  InputGroupButton,
  InputGroupText,
  InputGroupInput,
  InputGroupTextarea,
}
</file>

<file path="components/ui/input-otp.tsx">
'use client'

import * as React from 'react'
import { OTPInput, OTPInputContext } from 'input-otp'
import { MinusIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function InputOTP({
  className,
  containerClassName,
  ...props
}: React.ComponentProps<typeof OTPInput> & {
  containerClassName?: string
}) {
  return (
    <OTPInput
      data-slot="input-otp"
      containerClassName={cn(
        'flex items-center gap-2 has-disabled:opacity-50',
        containerClassName,
      )}
      className={cn('disabled:cursor-not-allowed', className)}
      {...props}
    />
  )
}

function InputOTPGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="input-otp-group"
      className={cn('flex items-center', className)}
      {...props}
    />
  )
}

function InputOTPSlot({
  index,
  className,
  ...props
}: React.ComponentProps<'div'> & {
  index: number
}) {
  const inputOTPContext = React.useContext(OTPInputContext)
  const { char, hasFakeCaret, isActive } = inputOTPContext?.slots[index] ?? {}

  return (
    <div
      data-slot="input-otp-slot"
      data-active={isActive}
      className={cn(
        'data-[active=true]:border-ring data-[active=true]:ring-ring/50 data-[active=true]:aria-invalid:ring-destructive/20 dark:data-[active=true]:aria-invalid:ring-destructive/40 aria-invalid:border-destructive data-[active=true]:aria-invalid:border-destructive dark:bg-input/30 border-input relative flex h-9 w-9 items-center justify-center border-y border-r text-sm shadow-xs transition-all outline-none first:rounded-l-md first:border-l last:rounded-r-md data-[active=true]:z-10 data-[active=true]:ring-[3px]',
        className,
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="animate-caret-blink bg-foreground h-4 w-px duration-1000" />
        </div>
      )}
    </div>
  )
}

function InputOTPSeparator({ ...props }: React.ComponentProps<'div'>) {
  return (
    <div data-slot="input-otp-separator" role="separator" {...props}>
      <MinusIcon />
    </div>
  )
}

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }
</file>

<file path="components/ui/input.tsx">
import * as React from 'react'

import { cn } from '@/lib/utils'

function Input({ className, type, ...props }: React.ComponentProps<'input'>) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        'file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
        'focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]',
        'aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive',
        className,
      )}
      {...props}
    />
  )
}

export { Input }
</file>

<file path="components/ui/item.tsx">
import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { Separator } from '@/components/ui/separator'

function ItemGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      role="list"
      data-slot="item-group"
      className={cn('group/item-group flex flex-col', className)}
      {...props}
    />
  )
}

function ItemSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="item-separator"
      orientation="horizontal"
      className={cn('my-0', className)}
      {...props}
    />
  )
}

const itemVariants = cva(
  'group/item flex items-center border border-transparent text-sm rounded-md transition-colors [a&]:hover:bg-accent/50 [a&]:transition-colors duration-100 flex-wrap outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]',
  {
    variants: {
      variant: {
        default: 'bg-transparent',
        outline: 'border-border',
        muted: 'bg-muted/50',
      },
      size: {
        default: 'p-4 gap-4 ',
        sm: 'py-3 px-4 gap-2.5',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
)

function Item({
  className,
  variant = 'default',
  size = 'default',
  asChild = false,
  ...props
}: React.ComponentProps<'div'> &
  VariantProps<typeof itemVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : 'div'
  return (
    <Comp
      data-slot="item"
      data-variant={variant}
      data-size={size}
      className={cn(itemVariants({ variant, size, className }))}
      {...props}
    />
  )
}

const itemMediaVariants = cva(
  'flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none group-has-[[data-slot=item-description]]/item:translate-y-0.5',
  {
    variants: {
      variant: {
        default: 'bg-transparent',
        icon: "size-8 border rounded-sm bg-muted [&_svg:not([class*='size-'])]:size-4",
        image:
          'size-10 rounded-sm overflow-hidden [&_img]:size-full [&_img]:object-cover',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

function ItemMedia({
  className,
  variant = 'default',
  ...props
}: React.ComponentProps<'div'> & VariantProps<typeof itemMediaVariants>) {
  return (
    <div
      data-slot="item-media"
      data-variant={variant}
      className={cn(itemMediaVariants({ variant, className }))}
      {...props}
    />
  )
}

function ItemContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-content"
      className={cn(
        'flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none',
        className,
      )}
      {...props}
    />
  )
}

function ItemTitle({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-title"
      className={cn(
        'flex w-fit items-center gap-2 text-sm leading-snug font-medium',
        className,
      )}
      {...props}
    />
  )
}

function ItemDescription({ className, ...props }: React.ComponentProps<'p'>) {
  return (
    <p
      data-slot="item-description"
      className={cn(
        'text-muted-foreground line-clamp-2 text-sm leading-normal font-normal text-balance',
        '[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4',
        className,
      )}
      {...props}
    />
  )
}

function ItemActions({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-actions"
      className={cn('flex items-center gap-2', className)}
      {...props}
    />
  )
}

function ItemHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-header"
      className={cn(
        'flex basis-full items-center justify-between gap-2',
        className,
      )}
      {...props}
    />
  )
}

function ItemFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="item-footer"
      className={cn(
        'flex basis-full items-center justify-between gap-2',
        className,
      )}
      {...props}
    />
  )
}

export {
  Item,
  ItemMedia,
  ItemContent,
  ItemActions,
  ItemGroup,
  ItemSeparator,
  ItemTitle,
  ItemDescription,
  ItemHeader,
  ItemFooter,
}
</file>

<file path="components/ui/kbd.tsx">
import { cn } from '@/lib/utils'

function Kbd({ className, ...props }: React.ComponentProps<'kbd'>) {
  return (
    <kbd
      data-slot="kbd"
      className={cn(
        'bg-muted w-fit text-muted-foreground pointer-events-none inline-flex h-5 min-w-5 items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium select-none',
        "[&_svg:not([class*='size-'])]:size-3",
        '[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10',
        className,
      )}
      {...props}
    />
  )
}

function KbdGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <kbd
      data-slot="kbd-group"
      className={cn('inline-flex items-center gap-1', className)}
      {...props}
    />
  )
}

export { Kbd, KbdGroup }
</file>

<file path="components/ui/label.tsx">
'use client'

import * as React from 'react'
import * as LabelPrimitive from '@radix-ui/react-label'

import { cn } from '@/lib/utils'

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        'flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50',
        className,
      )}
      {...props}
    />
  )
}

export { Label }
</file>

<file path="components/ui/menubar.tsx">
'use client'

import * as React from 'react'
import * as MenubarPrimitive from '@radix-ui/react-menubar'
import { CheckIcon, ChevronRightIcon, CircleIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Menubar({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Root>) {
  return (
    <MenubarPrimitive.Root
      data-slot="menubar"
      className={cn(
        'bg-background flex h-9 items-center gap-1 rounded-md border p-1 shadow-xs',
        className,
      )}
      {...props}
    />
  )
}

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu data-slot="menubar-menu" {...props} />
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group data-slot="menubar-group" {...props} />
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal data-slot="menubar-portal" {...props} />
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return (
    <MenubarPrimitive.RadioGroup data-slot="menubar-radio-group" {...props} />
  )
}

function MenubarTrigger({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Trigger>) {
  return (
    <MenubarPrimitive.Trigger
      data-slot="menubar-trigger"
      className={cn(
        'focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex items-center rounded-sm px-2 py-1 text-sm font-medium outline-hidden select-none',
        className,
      )}
      {...props}
    />
  )
}

function MenubarContent({
  className,
  align = 'start',
  alignOffset = -4,
  sideOffset = 8,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Content>) {
  return (
    <MenubarPortal>
      <MenubarPrimitive.Content
        data-slot="menubar-content"
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[12rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-md',
          className,
        )}
        {...props}
      />
    </MenubarPortal>
  )
}

function MenubarItem({
  className,
  inset,
  variant = 'default',
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Item> & {
  inset?: boolean
  variant?: 'default' | 'destructive'
}) {
  return (
    <MenubarPrimitive.Item
      data-slot="menubar-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function MenubarCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.CheckboxItem>) {
  return (
    <MenubarPrimitive.CheckboxItem
      data-slot="menubar-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.CheckboxItem>
  )
}

function MenubarRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioItem>) {
  return (
    <MenubarPrimitive.RadioItem
      data-slot="menubar-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.RadioItem>
  )
}

function MenubarLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <MenubarPrimitive.Label
      data-slot="menubar-label"
      data-inset={inset}
      className={cn(
        'px-2 py-1.5 text-sm font-medium data-[inset]:pl-8',
        className,
      )}
      {...props}
    />
  )
}

function MenubarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Separator>) {
  return (
    <MenubarPrimitive.Separator
      data-slot="menubar-separator"
      className={cn('bg-border -mx-1 my-1 h-px', className)}
      {...props}
    />
  )
}

function MenubarShortcut({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      data-slot="menubar-shortcut"
      className={cn(
        'text-muted-foreground ml-auto text-xs tracking-widest',
        className,
      )}
      {...props}
    />
  )
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />
}

function MenubarSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <MenubarPrimitive.SubTrigger
      data-slot="menubar-sub-trigger"
      data-inset={inset}
      className={cn(
        'focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-none select-none data-[inset]:pl-8',
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto h-4 w-4" />
    </MenubarPrimitive.SubTrigger>
  )
}

function MenubarSubContent({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubContent>) {
  return (
    <MenubarPrimitive.SubContent
      data-slot="menubar-sub-content"
      className={cn(
        'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg',
        className,
      )}
      {...props}
    />
  )
}

export {
  Menubar,
  MenubarPortal,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarGroup,
  MenubarSeparator,
  MenubarLabel,
  MenubarItem,
  MenubarShortcut,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarSub,
  MenubarSubTrigger,
  MenubarSubContent,
}
</file>

<file path="components/ui/navigation-menu.tsx">
import * as React from 'react'
import * as NavigationMenuPrimitive from '@radix-ui/react-navigation-menu'
import { cva } from 'class-variance-authority'
import { ChevronDownIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function NavigationMenu({
  className,
  children,
  viewport = true,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Root> & {
  viewport?: boolean
}) {
  return (
    <NavigationMenuPrimitive.Root
      data-slot="navigation-menu"
      data-viewport={viewport}
      className={cn(
        'group/navigation-menu relative flex max-w-max flex-1 items-center justify-center',
        className,
      )}
      {...props}
    >
      {children}
      {viewport && <NavigationMenuViewport />}
    </NavigationMenuPrimitive.Root>
  )
}

function NavigationMenuList({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.List>) {
  return (
    <NavigationMenuPrimitive.List
      data-slot="navigation-menu-list"
      className={cn(
        'group flex flex-1 list-none items-center justify-center gap-1',
        className,
      )}
      {...props}
    />
  )
}

function NavigationMenuItem({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Item>) {
  return (
    <NavigationMenuPrimitive.Item
      data-slot="navigation-menu-item"
      className={cn('relative', className)}
      {...props}
    />
  )
}

const navigationMenuTriggerStyle = cva(
  'group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=open]:hover:bg-accent data-[state=open]:text-accent-foreground data-[state=open]:focus:bg-accent data-[state=open]:bg-accent/50 focus-visible:ring-ring/50 outline-none transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1',
)

function NavigationMenuTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Trigger>) {
  return (
    <NavigationMenuPrimitive.Trigger
      data-slot="navigation-menu-trigger"
      className={cn(navigationMenuTriggerStyle(), 'group', className)}
      {...props}
    >
      {children}{' '}
      <ChevronDownIcon
        className="relative top-[1px] ml-1 size-3 transition duration-300 group-data-[state=open]:rotate-180"
        aria-hidden="true"
      />
    </NavigationMenuPrimitive.Trigger>
  )
}

function NavigationMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Content>) {
  return (
    <NavigationMenuPrimitive.Content
      data-slot="navigation-menu-content"
      className={cn(
        'data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 top-0 left-0 w-full p-2 pr-2.5 md:absolute md:w-auto',
        'group-data-[viewport=false]/navigation-menu:bg-popover group-data-[viewport=false]/navigation-menu:text-popover-foreground group-data-[viewport=false]/navigation-menu:data-[state=open]:animate-in group-data-[viewport=false]/navigation-menu:data-[state=closed]:animate-out group-data-[viewport=false]/navigation-menu:data-[state=closed]:zoom-out-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:zoom-in-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:fade-in-0 group-data-[viewport=false]/navigation-menu:data-[state=closed]:fade-out-0 group-data-[viewport=false]/navigation-menu:top-full group-data-[viewport=false]/navigation-menu:mt-1.5 group-data-[viewport=false]/navigation-menu:overflow-hidden group-data-[viewport=false]/navigation-menu:rounded-md group-data-[viewport=false]/navigation-menu:border group-data-[viewport=false]/navigation-menu:shadow group-data-[viewport=false]/navigation-menu:duration-200 **:data-[slot=navigation-menu-link]:focus:ring-0 **:data-[slot=navigation-menu-link]:focus:outline-none',
        className,
      )}
      {...props}
    />
  )
}

function NavigationMenuViewport({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Viewport>) {
  return (
    <div
      className={'absolute top-full left-0 isolate z-50 flex justify-center'}
    >
      <NavigationMenuPrimitive.Viewport
        data-slot="navigation-menu-viewport"
        className={cn(
          'origin-top-center bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border shadow md:w-[var(--radix-navigation-menu-viewport-width)]',
          className,
        )}
        {...props}
      />
    </div>
  )
}

function NavigationMenuLink({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Link>) {
  return (
    <NavigationMenuPrimitive.Link
      data-slot="navigation-menu-link"
      className={cn(
        "data-[active=true]:focus:bg-accent data-[active=true]:hover:bg-accent data-[active=true]:bg-accent/50 data-[active=true]:text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus-visible:ring-ring/50 [&_svg:not([class*='text-'])]:text-muted-foreground flex flex-col gap-1 rounded-sm p-2 text-sm transition-all outline-none focus-visible:ring-[3px] focus-visible:outline-1 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function NavigationMenuIndicator({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Indicator>) {
  return (
    <NavigationMenuPrimitive.Indicator
      data-slot="navigation-menu-indicator"
      className={cn(
        'data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden',
        className,
      )}
      {...props}
    >
      <div className="bg-border relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm shadow-md" />
    </NavigationMenuPrimitive.Indicator>
  )
}

export {
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
  navigationMenuTriggerStyle,
}
</file>

<file path="components/ui/pagination.tsx">
import * as React from 'react'
import {
  ChevronLeftIcon,
  ChevronRightIcon,
  MoreHorizontalIcon,
} from 'lucide-react'

import { cn } from '@/lib/utils'
import { Button, buttonVariants } from '@/components/ui/button'

function Pagination({ className, ...props }: React.ComponentProps<'nav'>) {
  return (
    <nav
      role="navigation"
      aria-label="pagination"
      data-slot="pagination"
      className={cn('mx-auto flex w-full justify-center', className)}
      {...props}
    />
  )
}

function PaginationContent({
  className,
  ...props
}: React.ComponentProps<'ul'>) {
  return (
    <ul
      data-slot="pagination-content"
      className={cn('flex flex-row items-center gap-1', className)}
      {...props}
    />
  )
}

function PaginationItem({ ...props }: React.ComponentProps<'li'>) {
  return <li data-slot="pagination-item" {...props} />
}

type PaginationLinkProps = {
  isActive?: boolean
} & Pick<React.ComponentProps<typeof Button>, 'size'> &
  React.ComponentProps<'a'>

function PaginationLink({
  className,
  isActive,
  size = 'icon',
  ...props
}: PaginationLinkProps) {
  return (
    <a
      aria-current={isActive ? 'page' : undefined}
      data-slot="pagination-link"
      data-active={isActive}
      className={cn(
        buttonVariants({
          variant: isActive ? 'outline' : 'ghost',
          size,
        }),
        className,
      )}
      {...props}
    />
  )
}

function PaginationPrevious({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to previous page"
      size="default"
      className={cn('gap-1 px-2.5 sm:pl-2.5', className)}
      {...props}
    >
      <ChevronLeftIcon />
      <span className="hidden sm:block">Previous</span>
    </PaginationLink>
  )
}

function PaginationNext({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to next page"
      size="default"
      className={cn('gap-1 px-2.5 sm:pr-2.5', className)}
      {...props}
    >
      <span className="hidden sm:block">Next</span>
      <ChevronRightIcon />
    </PaginationLink>
  )
}

function PaginationEllipsis({
  className,
  ...props
}: React.ComponentProps<'span'>) {
  return (
    <span
      aria-hidden
      data-slot="pagination-ellipsis"
      className={cn('flex size-9 items-center justify-center', className)}
      {...props}
    >
      <MoreHorizontalIcon className="size-4" />
      <span className="sr-only">More pages</span>
    </span>
  )
}

export {
  Pagination,
  PaginationContent,
  PaginationLink,
  PaginationItem,
  PaginationPrevious,
  PaginationNext,
  PaginationEllipsis,
}
</file>

<file path="components/ui/popover.tsx">
'use client'

import * as React from 'react'
import * as PopoverPrimitive from '@radix-ui/react-popover'

import { cn } from '@/lib/utils'

function Popover({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Root>) {
  return <PopoverPrimitive.Root data-slot="popover" {...props} />
}

function PopoverTrigger({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {
  return <PopoverPrimitive.Trigger data-slot="popover-trigger" {...props} />
}

function PopoverContent({
  className,
  align = 'center',
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Content>) {
  return (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        data-slot="popover-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden',
          className,
        )}
        {...props}
      />
    </PopoverPrimitive.Portal>
  )
}

function PopoverAnchor({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {
  return <PopoverPrimitive.Anchor data-slot="popover-anchor" {...props} />
}

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }
</file>

<file path="components/ui/progress.tsx">
'use client'

import * as React from 'react'
import * as ProgressPrimitive from '@radix-ui/react-progress'

import { cn } from '@/lib/utils'

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        'bg-primary/20 relative h-2 w-full overflow-hidden rounded-full',
        className,
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }
</file>

<file path="components/ui/radio-group.tsx">
'use client'

import * as React from 'react'
import * as RadioGroupPrimitive from '@radix-ui/react-radio-group'
import { CircleIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function RadioGroup({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Root>) {
  return (
    <RadioGroupPrimitive.Root
      data-slot="radio-group"
      className={cn('grid gap-3', className)}
      {...props}
    />
  )
}

function RadioGroupItem({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Item>) {
  return (
    <RadioGroupPrimitive.Item
      data-slot="radio-group-item"
      className={cn(
        'border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50',
        className,
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator
        data-slot="radio-group-indicator"
        className="relative flex items-center justify-center"
      >
        <CircleIcon className="fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  )
}

export { RadioGroup, RadioGroupItem }
</file>

<file path="components/ui/resizable.tsx">
'use client'

import * as React from 'react'
import { GripVerticalIcon } from 'lucide-react'
import * as ResizablePrimitive from 'react-resizable-panels'

import { cn } from '@/lib/utils'

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        'flex h-full w-full data-[panel-group-direction=vertical]:flex-col',
        className,
      )}
      {...props}
    />
  )
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        'bg-border focus-visible:ring-ring relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:translate-x-0 data-[panel-group-direction=vertical]:after:-translate-y-1/2 [&[data-panel-group-direction=vertical]>div]:rotate-90',
        className,
      )}
      {...props}
    >
      {withHandle && (
        <div className="bg-border z-10 flex h-4 w-3 items-center justify-center rounded-xs border">
          <GripVerticalIcon className="size-2.5" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  )
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle }
</file>

<file path="components/ui/scroll-area.tsx">
'use client'

import * as React from 'react'
import * as ScrollAreaPrimitive from '@radix-ui/react-scroll-area'

import { cn } from '@/lib/utils'

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn('relative', className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  )
}

function ScrollBar({
  className,
  orientation = 'vertical',
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        'flex touch-none p-px transition-colors select-none',
        orientation === 'vertical' &&
          'h-full w-2.5 border-l border-l-transparent',
        orientation === 'horizontal' &&
          'h-2.5 flex-col border-t border-t-transparent',
        className,
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  )
}

export { ScrollArea, ScrollBar }
</file>

<file path="components/ui/select.tsx">
'use client'

import * as React from 'react'
import * as SelectPrimitive from '@radix-ui/react-select'
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = 'default',
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: 'sm' | 'default'
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = 'popper',
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          'bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md',
          position === 'popper' &&
            'data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1',
          className,
        )}
        position={position}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            'p-1',
            position === 'popper' &&
              'h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1',
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn('text-muted-foreground px-2 py-1.5 text-xs', className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className,
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn('bg-border pointer-events-none -mx-1 my-1 h-px', className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        'flex cursor-default items-center justify-center py-1',
        className,
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        'flex cursor-default items-center justify-center py-1',
        className,
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}
</file>

<file path="components/ui/separator.tsx">
'use client'

import * as React from 'react'
import * as SeparatorPrimitive from '@radix-ui/react-separator'

import { cn } from '@/lib/utils'

function Separator({
  className,
  orientation = 'horizontal',
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        'bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px',
        className,
      )}
      {...props}
    />
  )
}

export { Separator }
</file>

<file path="components/ui/sheet.tsx">
'use client'

import * as React from 'react'
import * as SheetPrimitive from '@radix-ui/react-dialog'
import { XIcon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
  return <SheetPrimitive.Root data-slot="sheet" {...props} />
}

function SheetTrigger({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
  return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />
}

function SheetClose({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Close>) {
  return <SheetPrimitive.Close data-slot="sheet-close" {...props} />
}

function SheetPortal({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Portal>) {
  return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />
}

function SheetOverlay({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
  return (
    <SheetPrimitive.Overlay
      data-slot="sheet-overlay"
      className={cn(
        'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50',
        className,
      )}
      {...props}
    />
  )
}

function SheetContent({
  className,
  children,
  side = 'right',
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Content> & {
  side?: 'top' | 'right' | 'bottom' | 'left'
}) {
  return (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content
        data-slot="sheet-content"
        className={cn(
          'bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500',
          side === 'right' &&
            'data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm',
          side === 'left' &&
            'data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm',
          side === 'top' &&
            'data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b',
          side === 'bottom' &&
            'data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t',
          className,
        )}
        {...props}
      >
        {children}
        <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
          <XIcon className="size-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  )
}

function SheetHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sheet-header"
      className={cn('flex flex-col gap-1.5 p-4', className)}
      {...props}
    />
  )
}

function SheetFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sheet-footer"
      className={cn('mt-auto flex flex-col gap-2 p-4', className)}
      {...props}
    />
  )
}

function SheetTitle({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Title>) {
  return (
    <SheetPrimitive.Title
      data-slot="sheet-title"
      className={cn('text-foreground font-semibold', className)}
      {...props}
    />
  )
}

function SheetDescription({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Description>) {
  return (
    <SheetPrimitive.Description
      data-slot="sheet-description"
      className={cn('text-muted-foreground text-sm', className)}
      {...props}
    />
  )
}

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="components/ui/sidebar.tsx">
'use client'

import * as React from 'react'
import { Slot } from '@radix-ui/react-slot'
import { cva, VariantProps } from 'class-variance-authority'
import { PanelLeftIcon } from 'lucide-react'

import { useIsMobile } from '@/hooks/use-mobile'
import { cn } from '@/lib/utils'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Separator } from '@/components/ui/separator'
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from '@/components/ui/sheet'
import { Skeleton } from '@/components/ui/skeleton'
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip'

const SIDEBAR_COOKIE_NAME = 'sidebar_state'
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
const SIDEBAR_WIDTH = '16rem'
const SIDEBAR_WIDTH_MOBILE = '18rem'
const SIDEBAR_WIDTH_ICON = '3rem'
const SIDEBAR_KEYBOARD_SHORTCUT = 'b'

type SidebarContextProps = {
  state: 'expanded' | 'collapsed'
  open: boolean
  setOpen: (open: boolean) => void
  openMobile: boolean
  setOpenMobile: (open: boolean) => void
  isMobile: boolean
  toggleSidebar: () => void
}

const SidebarContext = React.createContext<SidebarContextProps | null>(null)

function useSidebar() {
  const context = React.useContext(SidebarContext)
  if (!context) {
    throw new Error('useSidebar must be used within a SidebarProvider.')
  }

  return context
}

function SidebarProvider({
  defaultOpen = true,
  open: openProp,
  onOpenChange: setOpenProp,
  className,
  style,
  children,
  ...props
}: React.ComponentProps<'div'> & {
  defaultOpen?: boolean
  open?: boolean
  onOpenChange?: (open: boolean) => void
}) {
  const isMobile = useIsMobile()
  const [openMobile, setOpenMobile] = React.useState(false)

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen)
  const open = openProp ?? _open
  const setOpen = React.useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      const openState = typeof value === 'function' ? value(open) : value
      if (setOpenProp) {
        setOpenProp(openState)
      } else {
        _setOpen(openState)
      }

      // This sets the cookie to keep the sidebar state.
      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
    },
    [setOpenProp, open],
  )

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)
  }, [isMobile, setOpen, setOpenMobile])

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (
        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
        (event.metaKey || event.ctrlKey)
      ) {
        event.preventDefault()
        toggleSidebar()
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [toggleSidebar])

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? 'expanded' : 'collapsed'

  const contextValue = React.useMemo<SidebarContextProps>(
    () => ({
      state,
      open,
      setOpen,
      isMobile,
      openMobile,
      setOpenMobile,
      toggleSidebar,
    }),
    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar],
  )

  return (
    <SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          data-slot="sidebar-wrapper"
          style={
            {
              '--sidebar-width': SIDEBAR_WIDTH,
              '--sidebar-width-icon': SIDEBAR_WIDTH_ICON,
              ...style,
            } as React.CSSProperties
          }
          className={cn(
            'group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full',
            className,
          )}
          {...props}
        >
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>
  )
}

function Sidebar({
  side = 'left',
  variant = 'sidebar',
  collapsible = 'offcanvas',
  className,
  children,
  ...props
}: React.ComponentProps<'div'> & {
  side?: 'left' | 'right'
  variant?: 'sidebar' | 'floating' | 'inset'
  collapsible?: 'offcanvas' | 'icon' | 'none'
}) {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()

  if (collapsible === 'none') {
    return (
      <div
        data-slot="sidebar"
        className={cn(
          'bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col',
          className,
        )}
        {...props}
      >
        {children}
      </div>
    )
  }

  if (isMobile) {
    return (
      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-slot="sidebar"
          data-mobile="true"
          className="bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden"
          style={
            {
              '--sidebar-width': SIDEBAR_WIDTH_MOBILE,
            } as React.CSSProperties
          }
          side={side}
        >
          <SheetHeader className="sr-only">
            <SheetTitle>Sidebar</SheetTitle>
            <SheetDescription>Displays the mobile sidebar.</SheetDescription>
          </SheetHeader>
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>
    )
  }

  return (
    <div
      className="group peer text-sidebar-foreground hidden md:block"
      data-state={state}
      data-collapsible={state === 'collapsed' ? collapsible : ''}
      data-variant={variant}
      data-side={side}
      data-slot="sidebar"
    >
      {/* This is what handles the sidebar gap on desktop */}
      <div
        data-slot="sidebar-gap"
        className={cn(
          'relative w-(--sidebar-width) bg-transparent transition-[width] duration-200 ease-linear',
          'group-data-[collapsible=offcanvas]:w-0',
          'group-data-[side=right]:rotate-180',
          variant === 'floating' || variant === 'inset'
            ? 'group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4)))]'
            : 'group-data-[collapsible=icon]:w-(--sidebar-width-icon)',
        )}
      />
      <div
        data-slot="sidebar-container"
        className={cn(
          'fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) transition-[left,right,width] duration-200 ease-linear md:flex',
          side === 'left'
            ? 'left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]'
            : 'right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]',
          // Adjust the padding for floating and inset variants.
          variant === 'floating' || variant === 'inset'
            ? 'p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4))+2px)]'
            : 'group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l',
          className,
        )}
        {...props}
      >
        <div
          data-sidebar="sidebar"
          data-slot="sidebar-inner"
          className="bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm"
        >
          {children}
        </div>
      </div>
    </div>
  )
}

function SidebarTrigger({
  className,
  onClick,
  ...props
}: React.ComponentProps<typeof Button>) {
  const { toggleSidebar } = useSidebar()

  return (
    <Button
      data-sidebar="trigger"
      data-slot="sidebar-trigger"
      variant="ghost"
      size="icon"
      className={cn('size-7', className)}
      onClick={(event) => {
        onClick?.(event)
        toggleSidebar()
      }}
      {...props}
    >
      <PanelLeftIcon />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  )
}

function SidebarRail({ className, ...props }: React.ComponentProps<'button'>) {
  const { toggleSidebar } = useSidebar()

  return (
    <button
      data-sidebar="rail"
      data-slot="sidebar-rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        'hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex',
        'in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize',
        '[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize',
        'hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full',
        '[[data-side=left][data-collapsible=offcanvas]_&]:-right-2',
        '[[data-side=right][data-collapsible=offcanvas]_&]:-left-2',
        className,
      )}
      {...props}
    />
  )
}

function SidebarInset({ className, ...props }: React.ComponentProps<'main'>) {
  return (
    <main
      data-slot="sidebar-inset"
      className={cn(
        'bg-background relative flex w-full flex-1 flex-col',
        'md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2',
        className,
      )}
      {...props}
    />
  )
}

function SidebarInput({
  className,
  ...props
}: React.ComponentProps<typeof Input>) {
  return (
    <Input
      data-slot="sidebar-input"
      data-sidebar="input"
      className={cn('bg-background h-8 w-full shadow-none', className)}
      {...props}
    />
  )
}

function SidebarHeader({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-header"
      data-sidebar="header"
      className={cn('flex flex-col gap-2 p-2', className)}
      {...props}
    />
  )
}

function SidebarFooter({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-footer"
      data-sidebar="footer"
      className={cn('flex flex-col gap-2 p-2', className)}
      {...props}
    />
  )
}

function SidebarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="sidebar-separator"
      data-sidebar="separator"
      className={cn('bg-sidebar-border mx-2 w-auto', className)}
      {...props}
    />
  )
}

function SidebarContent({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-content"
      data-sidebar="content"
      className={cn(
        'flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden',
        className,
      )}
      {...props}
    />
  )
}

function SidebarGroup({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-group"
      data-sidebar="group"
      className={cn('relative flex w-full min-w-0 flex-col p-2', className)}
      {...props}
    />
  )
}

function SidebarGroupLabel({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<'div'> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : 'div'

  return (
    <Comp
      data-slot="sidebar-group-label"
      data-sidebar="group-label"
      className={cn(
        'text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0',
        'group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0',
        className,
      )}
      {...props}
    />
  )
}

function SidebarGroupAction({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<'button'> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : 'button'

  return (
    <Comp
      data-slot="sidebar-group-action"
      data-sidebar="group-action"
      className={cn(
        'text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0',
        // Increases the hit area of the button on mobile.
        'after:absolute after:-inset-2 md:after:hidden',
        'group-data-[collapsible=icon]:hidden',
        className,
      )}
      {...props}
    />
  )
}

function SidebarGroupContent({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-group-content"
      data-sidebar="group-content"
      className={cn('w-full text-sm', className)}
      {...props}
    />
  )
}

function SidebarMenu({ className, ...props }: React.ComponentProps<'ul'>) {
  return (
    <ul
      data-slot="sidebar-menu"
      data-sidebar="menu"
      className={cn('flex w-full min-w-0 flex-col gap-1', className)}
      {...props}
    />
  )
}

function SidebarMenuItem({ className, ...props }: React.ComponentProps<'li'>) {
  return (
    <li
      data-slot="sidebar-menu-item"
      data-sidebar="menu-item"
      className={cn('group/menu-item relative', className)}
      {...props}
    />
  )
}

const sidebarMenuButtonVariants = cva(
  'peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0',
  {
    variants: {
      variant: {
        default: 'hover:bg-sidebar-accent hover:text-sidebar-accent-foreground',
        outline:
          'bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]',
      },
      size: {
        default: 'h-8 text-sm',
        sm: 'h-7 text-xs',
        lg: 'h-12 text-sm group-data-[collapsible=icon]:p-0!',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
)

function SidebarMenuButton({
  asChild = false,
  isActive = false,
  variant = 'default',
  size = 'default',
  tooltip,
  className,
  ...props
}: React.ComponentProps<'button'> & {
  asChild?: boolean
  isActive?: boolean
  tooltip?: string | React.ComponentProps<typeof TooltipContent>
} & VariantProps<typeof sidebarMenuButtonVariants>) {
  const Comp = asChild ? Slot : 'button'
  const { isMobile, state } = useSidebar()

  const button = (
    <Comp
      data-slot="sidebar-menu-button"
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props}
    />
  )

  if (!tooltip) {
    return button
  }

  if (typeof tooltip === 'string') {
    tooltip = {
      children: tooltip,
    }
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent
        side="right"
        align="center"
        hidden={state !== 'collapsed' || isMobile}
        {...tooltip}
      />
    </Tooltip>
  )
}

function SidebarMenuAction({
  className,
  asChild = false,
  showOnHover = false,
  ...props
}: React.ComponentProps<'button'> & {
  asChild?: boolean
  showOnHover?: boolean
}) {
  const Comp = asChild ? Slot : 'button'

  return (
    <Comp
      data-slot="sidebar-menu-action"
      data-sidebar="menu-action"
      className={cn(
        'text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0',
        // Increases the hit area of the button on mobile.
        'after:absolute after:-inset-2 md:after:hidden',
        'peer-data-[size=sm]/menu-button:top-1',
        'peer-data-[size=default]/menu-button:top-1.5',
        'peer-data-[size=lg]/menu-button:top-2.5',
        'group-data-[collapsible=icon]:hidden',
        showOnHover &&
          'peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0',
        className,
      )}
      {...props}
    />
  )
}

function SidebarMenuBadge({
  className,
  ...props
}: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="sidebar-menu-badge"
      data-sidebar="menu-badge"
      className={cn(
        'text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none',
        'peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground',
        'peer-data-[size=sm]/menu-button:top-1',
        'peer-data-[size=default]/menu-button:top-1.5',
        'peer-data-[size=lg]/menu-button:top-2.5',
        'group-data-[collapsible=icon]:hidden',
        className,
      )}
      {...props}
    />
  )
}

function SidebarMenuSkeleton({
  className,
  showIcon = false,
  ...props
}: React.ComponentProps<'div'> & {
  showIcon?: boolean
}) {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`
  }, [])

  return (
    <div
      data-slot="sidebar-menu-skeleton"
      data-sidebar="menu-skeleton"
      className={cn('flex h-8 items-center gap-2 rounded-md px-2', className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 max-w-(--skeleton-width) flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            '--skeleton-width': width,
          } as React.CSSProperties
        }
      />
    </div>
  )
}

function SidebarMenuSub({ className, ...props }: React.ComponentProps<'ul'>) {
  return (
    <ul
      data-slot="sidebar-menu-sub"
      data-sidebar="menu-sub"
      className={cn(
        'border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5',
        'group-data-[collapsible=icon]:hidden',
        className,
      )}
      {...props}
    />
  )
}

function SidebarMenuSubItem({
  className,
  ...props
}: React.ComponentProps<'li'>) {
  return (
    <li
      data-slot="sidebar-menu-sub-item"
      data-sidebar="menu-sub-item"
      className={cn('group/menu-sub-item relative', className)}
      {...props}
    />
  )
}

function SidebarMenuSubButton({
  asChild = false,
  size = 'md',
  isActive = false,
  className,
  ...props
}: React.ComponentProps<'a'> & {
  asChild?: boolean
  size?: 'sm' | 'md'
  isActive?: boolean
}) {
  const Comp = asChild ? Slot : 'a'

  return (
    <Comp
      data-slot="sidebar-menu-sub-button"
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        'text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline-hidden focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0',
        'data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground',
        size === 'sm' && 'text-xs',
        size === 'md' && 'text-sm',
        'group-data-[collapsible=icon]:hidden',
        className,
      )}
      {...props}
    />
  )
}

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
}
</file>

<file path="components/ui/skeleton.tsx">
import { cn } from '@/lib/utils'

function Skeleton({ className, ...props }: React.ComponentProps<'div'>) {
  return (
    <div
      data-slot="skeleton"
      className={cn('bg-accent animate-pulse rounded-md', className)}
      {...props}
    />
  )
}

export { Skeleton }
</file>

<file path="components/ui/slider.tsx">
'use client'

import * as React from 'react'
import * as SliderPrimitive from '@radix-ui/react-slider'

import { cn } from '@/lib/utils'

function Slider({
  className,
  defaultValue,
  value,
  min = 0,
  max = 100,
  ...props
}: React.ComponentProps<typeof SliderPrimitive.Root>) {
  const _values = React.useMemo(
    () =>
      Array.isArray(value)
        ? value
        : Array.isArray(defaultValue)
          ? defaultValue
          : [min, max],
    [value, defaultValue, min, max],
  )

  return (
    <SliderPrimitive.Root
      data-slot="slider"
      defaultValue={defaultValue}
      value={value}
      min={min}
      max={max}
      className={cn(
        'relative flex w-full touch-none items-center select-none data-[disabled]:opacity-50 data-[orientation=vertical]:h-full data-[orientation=vertical]:min-h-44 data-[orientation=vertical]:w-auto data-[orientation=vertical]:flex-col',
        className,
      )}
      {...props}
    >
      <SliderPrimitive.Track
        data-slot="slider-track"
        className={
          'bg-muted relative grow overflow-hidden rounded-full data-[orientation=horizontal]:h-1.5 data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-1.5'
        }
      >
        <SliderPrimitive.Range
          data-slot="slider-range"
          className={
            'bg-primary absolute data-[orientation=horizontal]:h-full data-[orientation=vertical]:w-full'
          }
        />
      </SliderPrimitive.Track>
      {Array.from({ length: _values.length }, (_, index) => (
        <SliderPrimitive.Thumb
          data-slot="slider-thumb"
          key={index}
          className="border-primary ring-ring/50 block size-4 shrink-0 rounded-full border bg-white shadow-sm transition-[color,box-shadow] hover:ring-4 focus-visible:ring-4 focus-visible:outline-hidden disabled:pointer-events-none disabled:opacity-50"
        />
      ))}
    </SliderPrimitive.Root>
  )
}

export { Slider }
</file>

<file path="components/ui/sonner.tsx">
'use client'

import { useTheme } from 'next-themes'
import { Toaster as Sonner, ToasterProps } from 'sonner'

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = 'system' } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps['theme']}
      className="toaster group"
      style={
        {
          '--normal-bg': 'var(--popover)',
          '--normal-text': 'var(--popover-foreground)',
          '--normal-border': 'var(--border)',
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }
</file>

<file path="components/ui/spinner.tsx">
import { Loader2Icon } from 'lucide-react'

import { cn } from '@/lib/utils'

function Spinner({ className, ...props }: React.ComponentProps<'svg'>) {
  return (
    <Loader2Icon
      role="status"
      aria-label="Loading"
      className={cn('size-4 animate-spin', className)}
      {...props}
    />
  )
}

export { Spinner }
</file>

<file path="components/ui/switch.tsx">
'use client'

import * as React from 'react'
import * as SwitchPrimitive from '@radix-ui/react-switch'

import { cn } from '@/lib/utils'

function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        'peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50',
        className,
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={
          'bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0'
        }
      />
    </SwitchPrimitive.Root>
  )
}

export { Switch }
</file>

<file path="components/ui/table.tsx">
'use client'

import * as React from 'react'

import { cn } from '@/lib/utils'

function Table({ className, ...props }: React.ComponentProps<'table'>) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn('w-full caption-bottom text-sm', className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<'thead'>) {
  return (
    <thead
      data-slot="table-header"
      className={cn('[&_tr]:border-b', className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<'tbody'>) {
  return (
    <tbody
      data-slot="table-body"
      className={cn('[&_tr:last-child]:border-0', className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<'tfoot'>) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        'bg-muted/50 border-t font-medium [&>tr]:last:border-b-0',
        className,
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<'tr'>) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        'hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors',
        className,
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<'th'>) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        'text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]',
        className,
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<'td'>) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        'p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]',
        className,
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<'caption'>) {
  return (
    <caption
      data-slot="table-caption"
      className={cn('text-muted-foreground mt-4 text-sm', className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="components/ui/tabs.tsx">
'use client'

import * as React from 'react'
import * as TabsPrimitive from '@radix-ui/react-tabs'

import { cn } from '@/lib/utils'

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn('flex flex-col gap-2', className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        'bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]',
        className,
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn('flex-1 outline-none', className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="components/ui/textarea.tsx">
import * as React from 'react'

import { cn } from '@/lib/utils'

function Textarea({ className, ...props }: React.ComponentProps<'textarea'>) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        'border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm',
        className,
      )}
      {...props}
    />
  )
}

export { Textarea }
</file>

<file path="components/ui/toast.tsx">
'use client'

import * as React from 'react'
import * as ToastPrimitives from '@radix-ui/react-toast'
import { cva, type VariantProps } from 'class-variance-authority'
import { X } from 'lucide-react'

import { cn } from '@/lib/utils'

const ToastProvider = ToastPrimitives.Provider

const ToastViewport = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Viewport>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Viewport
    ref={ref}
    className={cn(
      'fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]',
      className,
    )}
    {...props}
  />
))
ToastViewport.displayName = ToastPrimitives.Viewport.displayName

const toastVariants = cva(
  'group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full',
  {
    variants: {
      variant: {
        default: 'border bg-background text-foreground',
        destructive:
          'destructive group border-destructive bg-destructive text-destructive-foreground',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  },
)

const Toast = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &
    VariantProps<typeof toastVariants>
>(({ className, variant, ...props }, ref) => {
  return (
    <ToastPrimitives.Root
      ref={ref}
      className={cn(toastVariants({ variant }), className)}
      {...props}
    />
  )
})
Toast.displayName = ToastPrimitives.Root.displayName

const ToastAction = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Action>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Action
    ref={ref}
    className={cn(
      'inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive',
      className,
    )}
    {...props}
  />
))
ToastAction.displayName = ToastPrimitives.Action.displayName

const ToastClose = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Close>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Close
    ref={ref}
    className={cn(
      'absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600',
      className,
    )}
    toast-close=""
    {...props}
  >
    <X className="h-4 w-4" />
  </ToastPrimitives.Close>
))
ToastClose.displayName = ToastPrimitives.Close.displayName

const ToastTitle = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Title>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Title
    ref={ref}
    className={cn('text-sm font-semibold', className)}
    {...props}
  />
))
ToastTitle.displayName = ToastPrimitives.Title.displayName

const ToastDescription = React.forwardRef<
  React.ElementRef<typeof ToastPrimitives.Description>,
  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>
>(({ className, ...props }, ref) => (
  <ToastPrimitives.Description
    ref={ref}
    className={cn('text-sm opacity-90', className)}
    {...props}
  />
))
ToastDescription.displayName = ToastPrimitives.Description.displayName

type ToastProps = React.ComponentPropsWithoutRef<typeof Toast>

type ToastActionElement = React.ReactElement<typeof ToastAction>

export {
  type ToastProps,
  type ToastActionElement,
  ToastProvider,
  ToastViewport,
  Toast,
  ToastTitle,
  ToastDescription,
  ToastClose,
  ToastAction,
}
</file>

<file path="components/ui/toaster.tsx">
'use client'

import { useToast } from '@/hooks/use-toast'
import {
  Toast,
  ToastClose,
  ToastDescription,
  ToastProvider,
  ToastTitle,
  ToastViewport,
} from '@/components/ui/toast'

export function Toaster() {
  const { toasts } = useToast()

  return (
    <ToastProvider>
      {toasts.map(function ({ id, title, description, action, ...props }) {
        return (
          <Toast key={id} {...props}>
            <div className="grid gap-1">
              {title && <ToastTitle>{title}</ToastTitle>}
              {description && (
                <ToastDescription>{description}</ToastDescription>
              )}
            </div>
            {action}
            <ToastClose />
          </Toast>
        )
      })}
      <ToastViewport />
    </ToastProvider>
  )
}
</file>

<file path="components/ui/toggle-group.tsx">
'use client'

import * as React from 'react'
import * as ToggleGroupPrimitive from '@radix-ui/react-toggle-group'
import { type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'
import { toggleVariants } from '@/components/ui/toggle'

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: 'default',
  variant: 'default',
})

function ToggleGroup({
  className,
  variant,
  size,
  children,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <ToggleGroupPrimitive.Root
      data-slot="toggle-group"
      data-variant={variant}
      data-size={size}
      className={cn(
        'group/toggle-group flex w-fit items-center rounded-md data-[variant=outline]:shadow-xs',
        className,
      )}
      {...props}
    >
      <ToggleGroupContext.Provider value={{ variant, size }}>
        {children}
      </ToggleGroupContext.Provider>
    </ToggleGroupPrimitive.Root>
  )
}

function ToggleGroupItem({
  className,
  children,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Item> &
  VariantProps<typeof toggleVariants>) {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      data-slot="toggle-group-item"
      data-variant={context.variant || variant}
      data-size={context.size || size}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        'min-w-0 flex-1 shrink-0 rounded-none shadow-none first:rounded-l-md last:rounded-r-md focus:z-10 focus-visible:z-10 data-[variant=outline]:border-l-0 data-[variant=outline]:first:border-l',
        className,
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
}

export { ToggleGroup, ToggleGroupItem }
</file>

<file path="components/ui/toggle.tsx">
'use client'

import * as React from 'react'
import * as TogglePrimitive from '@radix-ui/react-toggle'
import { cva, type VariantProps } from 'class-variance-authority'

import { cn } from '@/lib/utils'

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium hover:bg-muted hover:text-muted-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] outline-none transition-[color,box-shadow] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive whitespace-nowrap",
  {
    variants: {
      variant: {
        default: 'bg-transparent',
        outline:
          'border border-input bg-transparent shadow-xs hover:bg-accent hover:text-accent-foreground',
      },
      size: {
        default: 'h-9 px-2 min-w-9',
        sm: 'h-8 px-1.5 min-w-8',
        lg: 'h-10 px-2.5 min-w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  },
)

function Toggle({
  className,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof TogglePrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <TogglePrimitive.Root
      data-slot="toggle"
      className={cn(toggleVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Toggle, toggleVariants }
</file>

<file path="components/ui/tooltip.tsx">
'use client'

import * as React from 'react'
import * as TooltipPrimitive from '@radix-ui/react-tooltip'

import { cn } from '@/lib/utils'

function TooltipProvider({
  delayDuration = 0,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return (
    <TooltipPrimitive.Provider
      data-slot="tooltip-provider"
      delayDuration={delayDuration}
      {...props}
    />
  )
}

function Tooltip({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return (
    <TooltipProvider>
      <TooltipPrimitive.Root data-slot="tooltip" {...props} />
    </TooltipProvider>
  )
}

function TooltipTrigger({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
}

function TooltipContent({
  className,
  sideOffset = 0,
  children,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          'bg-foreground text-background animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance',
          className,
        )}
        {...props}
      >
        {children}
        <TooltipPrimitive.Arrow className="bg-foreground fill-foreground z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]" />
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  )
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
</file>

<file path="components/ui/use-mobile.tsx">
import * as React from 'react'

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener('change', onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener('change', onChange)
  }, [])

  return !!isMobile
}
</file>

<file path="components/ui/use-toast.ts">
'use client'

// Inspired by react-hot-toast library
import * as React from 'react'

import type { ToastActionElement, ToastProps } from '@/components/ui/toast'

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: 'ADD_TOAST',
  UPDATE_TOAST: 'UPDATE_TOAST',
  DISMISS_TOAST: 'DISMISS_TOAST',
  REMOVE_TOAST: 'REMOVE_TOAST',
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType['ADD_TOAST']
      toast: ToasterToast
    }
  | {
      type: ActionType['UPDATE_TOAST']
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType['DISMISS_TOAST']
      toastId?: ToasterToast['id']
    }
  | {
      type: ActionType['REMOVE_TOAST']
      toastId?: ToasterToast['id']
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: 'REMOVE_TOAST',
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case 'ADD_TOAST':
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case 'UPDATE_TOAST':
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t,
        ),
      }

    case 'DISMISS_TOAST': {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t,
        ),
      }
    }
    case 'REMOVE_TOAST':
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, 'id'>

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: 'UPDATE_TOAST',
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: 'DISMISS_TOAST', toastId: id })

  dispatch({
    type: 'ADD_TOAST',
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: 'DISMISS_TOAST', toastId }),
  }
}

export { useToast, toast }
</file>

<file path="components/dashboard-header.tsx">
import { Bell, Search } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"

export function DashboardHeader() {
    return (
        <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b border-border bg-background/95 px-6 backdrop-blur supports-[backdrop-filter]:bg-background/60">
            <div className="flex items-center gap-4">
                <h1 className="text-xl font-semibold text-foreground">Dashboard</h1>
            </div>

            <div className="flex items-center gap-4">
                <div className="relative">
                    <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                    <Input placeholder="Search campaigns..." className="w-64 bg-muted pl-9" />
                </div>
                <Button variant="ghost" size="icon" className="relative">
                    <Bell className="h-5 w-5" />
                    <span className="absolute -right-1 -top-1 flex h-4 w-4 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-primary-foreground">
                        3
                    </span>
                </Button>
            </div>
        </header>
    )
}
</file>

<file path="components/metrics-cards.tsx">
import { Card, CardContent } from "@/components/ui/card"
import { Users, Mail, Clock, TrendingUp } from "lucide-react"

const metrics = [
    {
        title: "Total Subscribers",
        value: "1,326",
        trend: "+5% this week",
        icon: Users,
        trendUp: true,
    },
    {
        title: "Avg. Open Rate",
        value: "24.5%",
        trend: "+2.1% vs last month",
        icon: Mail,
        trendUp: true,
    },
    {
        title: "Next Scheduled Send",
        value: "Black Friday Round 4",
        trend: "Tomorrow, 9 AM",
        icon: Clock,
        trendUp: null,
    },
]

export function MetricsCards() {
    return (
        <div className="grid gap-4 md:grid-cols-3">
            {metrics.map((metric) => (
                <Card key={metric.title} className="bg-card border-border">
                    <CardContent className="p-6">
                        <div className="flex items-start justify-between">
                            <div className="space-y-2">
                                <p className="text-sm text-muted-foreground">{metric.title}</p>
                                <p className="text-2xl font-bold text-card-foreground">{metric.value}</p>
                                <div className="flex items-center gap-1 text-xs">
                                    {metric.trendUp !== null && (
                                        <TrendingUp className={`h-3 w-3 ${metric.trendUp ? "text-green-500" : "text-red-500"}`} />
                                    )}
                                    <span className={metric.trendUp ? "text-green-500" : "text-muted-foreground"}>{metric.trend}</span>
                                </div>
                            </div>
                            <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-muted">
                                <metric.icon className="h-5 w-5 text-primary" />
                            </div>
                        </div>
                    </CardContent>
                </Card>
            ))}
        </div>
    )
}
</file>

<file path="components/quick-actions.tsx">
import Link from "next/link"
import { Button } from "@/components/ui/button"
import { Plus, Upload } from "lucide-react"

export function QuickActions() {
    return (
        <div className="flex flex-wrap gap-4">
            <Button asChild size="lg" className="bg-primary text-primary-foreground hover:bg-primary/90">
                <Link href="/editor">
                    <Plus className="mr-2 h-5 w-5" />
                    Create New Campaign
                </Link>
            </Button>
            <Button asChild variant="secondary" size="lg">
                <Link href="/audience">
                    <Upload className="mr-2 h-5 w-5" />
                    Import Audience
                </Link>
            </Button>
        </div>
    )
}
</file>

<file path="components/website-tracker.tsx">
"use client"

import { useEffect, useRef, Suspense } from "react"
import { useSearchParams, usePathname } from "next/navigation"

function TrackerContent() {
    const searchParams = useSearchParams()
    const pathname = usePathname()
    const startTime = useRef(Date.now())

    // Check if user came from an email
    const sid = searchParams.get("sid")
    const cid = searchParams.get("cid")

    useEffect(() => {
        if (!sid) return

        // 1. Log Page View immediately
        // Note: Replace this with your actual tracking engine URL if it's different
        const baseUrl = "https://email.dreamplaypianos.com"

        const trackPage = async () => {
            try {
                await fetch(`${baseUrl}/api/track`, {
                    method: "POST",
                    body: JSON.stringify({
                        subscriber_id: sid,
                        campaign_id: cid,
                        type: "page_view",
                        url: window.location.href
                    })
                })
            } catch (e) {
                console.error("Failed to track page view", e)
            }
        }

        trackPage()

        // 2. Track Duration on unmount/tab close
        const logDuration = () => {
            const duration = Math.floor((Date.now() - startTime.current) / 1000)
            if (duration > 1) { // Only log if > 1 second
                // Use navigator.sendBeacon for reliability during unload
                const data = JSON.stringify({
                    subscriber_id: sid,
                    campaign_id: cid,
                    type: "session_end",
                    duration: duration,
                    url: window.location.href
                })
                navigator.sendBeacon(`${baseUrl}/api/track`, data)
            }
        }

        window.addEventListener("beforeunload", logDuration)

        return () => {
            logDuration()
            window.removeEventListener("beforeunload", logDuration)
        }
    }, [pathname, sid, cid])

    return null
}

export function WebsiteTracker() {
    return (
        <Suspense fallback={null}>
            <TrackerContent />
        </Suspense>
    )
}
</file>

<file path="hooks/use-mobile.ts">
import * as React from 'react'

const MOBILE_BREAKPOINT = 768

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    }
    mql.addEventListener('change', onChange)
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)
    return () => mql.removeEventListener('change', onChange)
  }, [])

  return !!isMobile
}
</file>

<file path="hooks/use-toast.ts">
'use client'

// Inspired by react-hot-toast library
import * as React from 'react'

import type { ToastActionElement, ToastProps } from '@/components/ui/toast'

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 1000000

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: 'ADD_TOAST',
  UPDATE_TOAST: 'UPDATE_TOAST',
  DISMISS_TOAST: 'DISMISS_TOAST',
  REMOVE_TOAST: 'REMOVE_TOAST',
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
      type: ActionType['ADD_TOAST']
      toast: ToasterToast
    }
  | {
      type: ActionType['UPDATE_TOAST']
      toast: Partial<ToasterToast>
    }
  | {
      type: ActionType['DISMISS_TOAST']
      toastId?: ToasterToast['id']
    }
  | {
      type: ActionType['REMOVE_TOAST']
      toastId?: ToasterToast['id']
    }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: 'REMOVE_TOAST',
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case 'ADD_TOAST':
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case 'UPDATE_TOAST':
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t,
        ),
      }

    case 'DISMISS_TOAST': {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
                ...t,
                open: false,
              }
            : t,
        ),
      }
    }
    case 'REMOVE_TOAST':
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, 'id'>

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: 'UPDATE_TOAST',
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: 'DISMISS_TOAST', toastId: id })

  dispatch({
    type: 'ADD_TOAST',
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: 'DISMISS_TOAST', toastId }),
  }
}

export { useToast, toast }
</file>

<file path="lib/supabase/client.ts">
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
</file>

<file path="lib/supabase/schema.sql">
-- Enable UUID extension if not already enabled
create extension if not exists "uuid-ossp";

create table campaigns (
  id uuid default uuid_generate_v4() primary key,
  name text not null,
  status text check (status in ('draft', 'scheduled', 'sending', 'completed')),
  subject_line text,
  sent_at timestamp with time zone,
  
  -- The Analytics Stats
  total_recipients integer default 0,
  total_opens integer default 0,
  total_clicks integer default 0,
  revenue_attributed numeric default 0, -- $$$ from Shopify/Stripe
  
  created_at timestamp with time zone default now()
);

-- Index for fast sorting by date
create index campaigns_sent_at_idx on campaigns (sent_at desc);
</file>

<file path="lib/supabase/server.ts">
import { createServerClient, type CookieOptions } from "@supabase/ssr"
import { cookies } from "next/headers"

export async function createClient() {
    const cookieStore = await cookies()

    return createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() {
                    return cookieStore.getAll()
                },
                setAll(cookiesToSet) {
                    try {
                        cookiesToSet.forEach(({ name, value, options }) =>
                            cookieStore.set(name, value, options)
                        )
                    } catch {
                        // The `setAll` method was called from a Server Component.
                        // This can be ignored if you have middleware refreshing
                        // user sessions.
                    }
                },
            },
        }
    )
}
</file>

<file path="lib/render-template.ts">
/**
 * Renders a template by replacing all {{key}} placeholders with actual values from the assets object.
 * @param html - The raw HTML template string containing {{variable}} placeholders
 * @param assets - An object mapping variable names to their replacement values
 * @returns The processed HTML string with all placeholders replaced
 */
export function renderTemplate(html: string, assets: Record<string, string>): string {
    let result = html

    // Loop through all asset keys and replace {{key}} with the actual value
    for (const [key, value] of Object.entries(assets)) {
        const pattern = new RegExp(`\\{\\{${key}\\}\\}`, "g")
        result = result.replace(pattern, value || "")
    }

    return result
}
</file>

<file path="lib/utils.ts">
import { clsx, type ClassValue } from 'clsx'
import { twMerge } from 'tailwind-merge'

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}
</file>

<file path="scripts/bulk-fix.js">
const { createClient } = require('@supabase/supabase-js');
const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT';
const supabase = createClient(supabaseUrl, supabaseKey);

async function bulkFix() {
  const { data: campaigns } = await supabase.from('campaigns').select('id, name, variable_values');
  
  for (const camp of campaigns) {
    const vals = camp.variable_values || {};
    let changed = false;
    
    for (const [key, val] of Object.entries(vals)) {
      if (typeof val === 'string' && val.includes('email-assets') && val.includes(' ')) {
        console.log(`Fixing ${camp.name} [${key}]`);
        
        // Encode only the filename part to be safe
        const parts = val.split('/');
        const filename = parts.pop();
        const encodedFilename = encodeURIComponent(filename);
        const fixedUrl = [...parts, encodedFilename].join('/');
        
        vals[key] = fixedUrl;
        changed = true;
      }
    }
    
    if (changed) {
      const { error } = await supabase.from('campaigns').update({ variable_values: vals }).eq('id', camp.id);
      if (error) console.error(`Failed to update ${camp.name}`, error);
      else console.log(`SUCCESS: Updated ${camp.name}`);
    }
  }
}

bulkFix();
</file>

<file path="scripts/check-bucket.js">
const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT'; // Service Key

const supabase = createClient(supabaseUrl, supabaseKey);

async function check() {
  const { data, error } = await supabase.storage.getBucket('email-assets');
  if (error) {
    console.error('Error:', error);
  } else {
    console.log('Bucket Info:', JSON.stringify(data, null, 2));
  }
}

check();
</file>

<file path="scripts/check-bucket.ts">
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT'; // Service Key

const supabase = createClient(supabaseUrl, supabaseKey);

async function check() {
  const { data, error } = await supabase.storage.getBucket('email-assets');
  if (error) {
    console.error('Error:', error);
  } else {
    console.log('Bucket Info:', JSON.stringify(data, null, 2));
  }
}

check();
</file>

<file path="scripts/check-campaign.js">
const { createClient } = require('@supabase/supabase-js');
const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT';
const supabase = createClient(supabaseUrl, supabaseKey);
async function get() {
  const { data } = await supabase.from('campaigns').select('variable_values, html_content').eq('id', '8d9edeb5-934f-4a50-8655-7aa72428bb03').single();
  console.log(JSON.stringify(data, null, 2));
}
get();
</file>

<file path="scripts/check-columns.js">
const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT'; // Service Key

const supabase = createClient(supabaseUrl, supabaseKey);

async function checkColumns() {
    console.log('Fetching one campaign row to check columns...');
    const { data, error } = await supabase
        .from('campaigns')
        .select('*')
        .limit(1);

    if (error) {
        console.error('Error fetching campaign:', error);
        return;
    }

    if (data && data.length > 0) {
        console.log('Existing columns in campaigns table:', Object.keys(data[0]));
        if ('opens' in data[0]) console.log('✅ opens column exists');
        else console.log('❌ opens column MISSING');
        if ('clicks' in data[0]) console.log('✅ clicks column exists');
        else console.log('❌ clicks column MISSING');
    } else {
        console.log('No campaigns found to check columns.');
    }
}

checkColumns();
</file>

<file path="scripts/check-rpc.js">
const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT'; // Service Key

const supabase = createClient(supabaseUrl, supabaseKey);

async function checkRPCs() {
    console.log('Checking for RPC functions...');

    // Try to call increment_opens with a fake ID just to see if it exists
    const { error: openError } = await supabase.rpc('increment_opens', { row_id: '00000000-0000-0000-0000-000000000000' });
    if (openError && openError.message.includes('not found')) {
        console.log('RPC increment_opens does NOT exist.');
    } else {
        console.log('RPC increment_opens exists or returned expected error.');
    }

    const { error: clickError } = await supabase.rpc('increment_clicks', { row_id: '00000000-0000-0000-0000-000000000000' });
    if (clickError && clickError.message.includes('not found')) {
        console.log('RPC increment_clicks does NOT exist.');
    } else {
        console.log('RPC increment_clicks exists or returned expected error.');
    }
}

checkRPCs();
</file>

<file path="scripts/check-schema.js">
const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT'; // Service Key

const supabase = createClient(supabaseUrl, supabaseKey);

async function checkSchema() {
    console.log('Checking for subscriber_events table...');
    const { data, error } = await supabase
        .from('subscriber_events')
        .select('id')
        .limit(1);

    if (error) {
        if (error.code === 'PGRST116' || error.message.includes('not found')) {
            console.log('Table subscriber_events does not exist.');
        } else {
            console.error('Error checking table:', error);
        }
    } else {
        console.log('Table subscriber_events exists.');
    }

    console.log('Checking for campaigns columns (opens, clicks)...');
    const { data: campaignData, error: campaignError } = await supabase
        .from('campaigns')
        .select('opens, clicks')
        .limit(1);

    if (campaignError) {
        console.log('Columns opens/clicks might not exist in campaigns table.');
    } else {
        console.log('Columns opens/clicks exist in campaigns table.');
    }
}

checkSchema();
</file>

<file path="scripts/debug-assets.js">
const { createClient } = require('@supabase/supabase-js');

const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT'; // Service Key

const supabase = createClient(supabaseUrl, supabaseKey);

async function check() {
  // 1. List files
  const { data: files, error } = await supabase.storage.from('email-assets').list('', { limit: 5, sortBy: { column: 'created_at', order: 'desc' } });
  
  if (error) {
    console.error('List Error:', error);
    return;
  }

  console.log('--- Recent Files ---');
  for (const file of files) {
    console.log('Name:', file.name);
    console.log('Metadata:', file.metadata);
    
    // Construct Public URL
    const rawUrl = `${supabaseUrl}/storage/v1/object/public/email-assets/${file.name}`;
    const encodedUrl = `${supabaseUrl}/storage/v1/object/public/email-assets/${encodeURIComponent(file.name)}`;
    
    console.log('Raw URL:', rawUrl);
    console.log('Encoded URL:', encodedUrl);
    console.log('---------------------');
  }
}

check();
</file>

<file path="scripts/fix-campaign.js">
const { createClient } = require('@supabase/supabase-js');
const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT';
const supabase = createClient(supabaseUrl, supabaseKey);

async function fix() {
  const id = '8d9edeb5-934f-4a50-8655-7aa72428bb03';
  // 1. Get current
  const { data } = await supabase.from('campaigns').select('variable_values').eq('id', id).single();
  const values = data.variable_values;
  
  // 2. Fix URL
  const oldUrl = values.hero_src;
  const newUrl = encodeURI(oldUrl); // encodeURI should catch spaces
  // Or better, manually encode just the spaces if we want to be safe, but encodeURI is safest for full path
  // Actually, wait. The base URL part shouldn't be encoded if it has colons etc.
  // The filename part is what we want.
  
  // Custom fix: split by '/' and encode the last part
  const parts = oldUrl.split('/');
  const filename = parts.pop();
  const encodedFilename = encodeURIComponent(filename);
  const fixedUrl = [...parts, encodedFilename].join('/');

  console.log('Old:', oldUrl);
  console.log('New:', fixedUrl);

  values.hero_src = fixedUrl;

  // 3. Update
  const { error } = await supabase.from('campaigns').update({ variable_values: values }).eq('id', id);
  
  if (error) console.error('Update failed:', error);
  else console.log('Update success!');
}

fix();
</file>

<file path="scripts/scan-campaigns.js">
const { createClient } = require('@supabase/supabase-js');
const supabaseUrl = 'https://quyqwdjygzalqqmrgkfk.supabase.co';
const supabaseKey = 'sb_secret_a2xA5WO4NSkdJCu34Q-iRg_hsPgnxjT';
const supabase = createClient(supabaseUrl, supabaseKey);

async function scan() {
  const { data: campaigns, error } = await supabase.from('campaigns').select('id, name, variable_values');
  if (error) { console.error(error); return; }

  const needsFix = [];

  for (const camp of campaigns) {
    const vals = camp.variable_values || {};
    let broken = false;
    for (const [key, val] of Object.entries(vals)) {
      if (typeof val === 'string' && val.includes('email-assets') && val.includes(' ')) {
        console.log(`[Broken] Campaign: ${camp.name} (${camp.id})`);
        console.log(`   Key: ${key}`);
        console.log(`   Value: ${val}`);
        broken = true;
      }
    }
    if (broken) needsFix.push(camp);
  }

  console.log(`\nTotal campaigns to fix: ${needsFix.length}`);
}

scan();
</file>

<file path="supabase/migrations/20260126_create_subscriber_events.sql">
-- Create Event Type Enum
create type event_type as enum ('sent', 'open', 'click', 'page_view', 'session_end');

-- Create Subscriber Events Table
create table subscriber_events (
  id uuid default uuid_generate_v4() primary key,
  subscriber_id uuid references subscribers(id) on delete cascade,
  campaign_id uuid references campaigns(id) on delete set null,
  type event_type not null,
  
  -- Context
  url text,                -- What link did they click?
  metadata jsonb,          -- { "duration_seconds": 45, "browser": "Chrome" }
  ip_address text,         -- For location history
  
  created_at timestamp with time zone default now()
);

-- Fast lookup so you can load the "History" tab instantly
create index idx_subscriber_events on subscriber_events(subscriber_id);
</file>

<file path="supabase/migrations/20260127235000_create_app_settings.sql">
-- 1. Create a table for app settings
create table if not exists app_settings (
  key text primary key,
  value text not null,
  updated_at timestamp with time zone default now()
);

-- 2. Enable Row Level Security (RLS)
alter table app_settings enable row level security;

-- 3. Policy: Allow authenticated users to READ settings
create policy "Allow authenticated read"
on app_settings for select
to authenticated
using (true);

-- 4. Policy: Allow authenticated users to UPDATE settings
create policy "Allow authenticated update"
on app_settings for update
to authenticated
using (true);

-- 5. Insert your default context (so it's not empty)
insert into app_settings (key, value)
values ('company_context', '### COMPANY KNOWLEDGE BASE (DreamPlay Pianos):\n- Product: DreamPlay One...')
on conflict (key) do nothing;
</file>

<file path="supabase/migrations/20260128004000_create_campaign_versions.sql">
create table campaign_versions (
  id uuid default uuid_generate_v4() primary key,
  campaign_id uuid references campaigns(id) on delete cascade,
  html_content text not null,
  prompt text,
  created_at timestamp with time zone default now()
);

alter table campaign_versions enable row level security;

create policy "Allow authenticated insert" on campaign_versions for insert to authenticated with check (true);
create policy "Allow authenticated select" on campaign_versions for select to authenticated using (true);
</file>

<file path=".gitignore">
# dependencies
/node_modules
/.pnpm-store

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
pnpm-debug.log*

# local env files
.env*.local

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path=".repomixignore">
# Add patterns to ignore here, one per line
_legacy_v0_code/
.next/
node_modules/
.git/
pnpm-lock.yaml
package-lock.json
yarn.lock
.DS_Store
repomix-output.xml
.vscode/
</file>

<file path="all_campaigns.json">
[{"id":"8e0b0797-6be2-46f6-b948-5f17e3ca56bf","name":"qwer","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200"}}, 
 {"id":"c606e297-4bd7-4c88-9de2-1248a36ae5a6","name":"NEW CAMPAIGN","variable_values":{"cta_link": "https://www.dreamplaypianos.com/", "headline": "Welcome to the Tournament", "hero_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768193507053-screenshots-638.png", "presenter_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768193535466-screenshots-639.png", "video_thumbnail_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768193458980-Thumbnail.jpg"}}, 
 {"id":"a0554f56-d0f3-4c27-b59b-0ff08e3e3a86","name":"First Email For DreamPlay","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200", "ecourse_link": "musicalbasics-academy.teachable.com/p/piano-fundamentals-101", "hero_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765828738514-5%20-%204LionelYu.JPG", "profile_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765631110785-0X5A4562.jpg", "piano_lessons_link": "https://lessons.musicalbasics.com/", "secret_project_link": "https://www.dreamplaypianos.com/"}}, 
 {"id":"288e5106-4d77-4e07-81d2-48fade4d301d","name":"DreamPlay","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200"}}, 
 {"id":"d81ec738-597d-4594-8ea1-f7fca516f801","name":"wow campaign","variable_values":{"headline": "The Perfect Piano", "hero_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765828738514-5 - 4LionelYu.JPG", "carol_leone_image": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768127782373-carol-leone.png", "keyboard_image_ds55": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768127063146-DS5.5 White CENTERED.JPG", "keyboard_image_ds60": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768127075901-DS6.0 Black copy.JPG", "profile_picture_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1767935095803-Dreamplay Logo without pianos.png", "ai_feature_image_learning": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1767935234615-Main Product In Studio copy.JPG", "ai_feature_image_accompaniment": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768127075901-DS6.0 Black copy.JPG"}}, 
 {"id":"f4799052-dc4a-4f81-bb64-c5b6f7084f21","name":"Campaign for John Person","variable_values":{"subscriber_id": "f2220042-418c-4328-b403-0d0793b141ff"}}, 
 {"id":"f6d2d058-d261-4295-b9f0-69ec73ac8365","name":"Untitled Modular Campaign","variable_values":{}}, 
 {"id":"3455f910-a876-422a-af15-1d71f3316bd4","name":"Untitled Modular Campaign 2","variable_values":{}}, 
 {"id":"b29ee607-51f9-4739-b5f5-d2931ddf6fef","name":"xzcvzxcv","variable_values":{"headline": "HELLO THERE"}}, 
 {"id":"48dbddc9-705c-4723-83f2-4a4121792f5c","name":"talking about myself","variable_values":{}}, 
 {"id":"859908b4-b1ca-4b57-9127-931cfab0712f","name":"Copy of First Email For DreamPlay","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200", "ecourse_link": "musicalbasics-academy.teachable.com/p/piano-fundamentals-101", "hero_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765828738514-5%20-%204LionelYu.JPG", "profile_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765631110785-0X5A4562.jpg", "piano_lessons_link": "https://lessons.musicalbasics.com/", "secret_project_link": "https://www.dreamplaypianos.com/"}}, 
 {"id":"885eeaa9-e9d5-40c5-b84a-b1bc11bbbe4f","name":"Untitled Campaign","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200", "logo_image": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1767935095803-Dreamplay Logo without pianos.png"}}, 
 {"id":"9202cc86-0362-4bed-a8d3-edf62e65de41","name":"Campaign for John Person","variable_values":{"subscriber_id": "f2220042-418c-4328-b403-0d0793b141ff"}}, 
 {"id":"96d0f6a5-b518-4652-82aa-ae8350f49f43","name":"Copy of talking about myself (for Hello There)","variable_values":{"subscriber_id": "621fd46c-40cc-47bf-bc4d-1557b222802d"}}, 
 {"id":"daa9f2f0-2a23-400e-a4cc-a9318206056b","name":"Copy of Copy of First Email For DreamPlay (for Hello There)","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200", "ecourse_link": "musicalbasics-academy.teachable.com/p/piano-fundamentals-101", "subscriber_id": "621fd46c-40cc-47bf-bc4d-1557b222802d", "hero_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765828738514-5%20-%204LionelYu.JPG", "profile_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765631110785-0X5A4562.jpg", "piano_lessons_link": "https://lessons.musicalbasics.com/", "secret_project_link": "https://www.dreamplaypianos.com/"}}, 
 {"id":"eb12f2dd-cffa-4847-9847-2ea78ea81296","name":"Copy of Copy of First Email For DreamPlay (for John Person)","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200", "ecourse_link": "musicalbasics-academy.teachable.com/p/piano-fundamentals-101", "subscriber_id": "f2220042-418c-4328-b403-0d0793b141ff", "hero_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765828738514-5%20-%204LionelYu.JPG", "profile_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765631110785-0X5A4562.jpg", "piano_lessons_link": "https://lessons.musicalbasics.com/", "secret_project_link": "https://www.dreamplaypianos.com/"}}, 
 {"id":"69e2dea9-b509-4801-a42f-3220334072e7","name":"Copy of Copy of Copy of First Email For DreamPlay (for John Person) (for yulionel829@gmail.com)","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200", "ecourse_link": "musicalbasics-academy.teachable.com/p/piano-fundamentals-101", "subscriber_id": "2b39c0de-d522-4f99-85da-cef85857426e", "hero_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765828738514-5%20-%204LionelYu.JPG", "profile_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765631110785-0X5A4562.jpg", "piano_lessons_link": "https://lessons.musicalbasics.com/", "secret_project_link": "https://www.dreamplaypianos.com/"}}, 
 {"id":"dd1859c7-6a45-4de1-ba9c-f1d4b53722e1","name":"Copy of Campaign for John Person (for yulionel829@gmail.com)","variable_values":{"subscriber_id": "2b39c0de-d522-4f99-85da-cef85857426e"}}, 
 {"id":"cd55d2c0-f558-42ac-a24c-7042726ec8fe","name":"Copy of Untitled Modular Campaign (for yulionel829@gmail.com)","variable_values":{"subscriber_id": "2b39c0de-d522-4f99-85da-cef85857426e"}}, 
 {"id":"387a3587-867f-44b2-927d-e4742c2e12cd","name":"Copy of Untitled Modular Campaign (for yulionel829@gmail.com)","variable_values":{"subscriber_id": "2b39c0de-d522-4f99-85da-cef85857426e"}}, 
 {"id":"d0c8f148-c013-4cf3-a50a-034cd539d0c2","name":"asdfasdf","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200", "ecourse_link": "musicalbasics-academy.teachable.com/p/piano-fundamentals-101", "subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf", "hero_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765828738514-5%20-%204LionelYu.JPG", "profile_image_url": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1765631110785-0X5A4562.jpg", "piano_lessons_link": "https://lessons.musicalbasics.com/", "secret_project_link": "https://www.dreamplaypianos.com/"}}, 
 {"id":"e1302d79-6ad6-4b29-9104-19b5d1935a20","name":"asdfasdfxczvzxcv","variable_values":{"subscriber_id": "2b39c0de-d522-4f99-85da-cef85857426e"}}, 
 {"id":"d7dfb051-a68a-4539-b50d-ee947b0a0fac","name":"Copy of asdfasdfxczvzxcv","variable_values":{"subscriber_id": "2b39c0de-d522-4f99-85da-cef85857426e"}}, 
 {"id":"325067a7-a0f5-417e-bb6d-5b77622bde49","name":"Copy of Copy of asdfasdfxczvzxcv (for Lionel Yu)","variable_values":{"subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf"}}, 
 {"id":"a708b944-6209-4e6b-b02a-c75dea9a32e6","name":"Copy of DreamPlay (for Lionel Yu)","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200", "subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf"}}, 
 {"id":"20bb1a55-5157-4b57-a3d3-5ce90ce84724","name":"Copy of Copy of Untitled Modular Campaign (for yulionel829@gmail.com) (for Lionel Yu)","variable_values":{"subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf"}}, 
 {"id":"32377be2-5ce2-4c92-a9a8-24eb42dca210","name":"Copy of asdfasdfxczvzxcv (for Lionel Yu)","variable_values":{"subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf"}}, 
 {"id":"67592515-36cc-4adc-9322-9057fae1b868","name":"Copy of Copy of DreamPlay (for Lionel Yu) (for Lionel Yu)","variable_values":{"headline": "Welcome to the Tournament", "hero_src": "https://via.placeholder.com/600x200", "subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf"}}, 
 {"id":"8e15dac4-b445-438b-bc8e-110cb7fdb028","name":"Copy of Copy of Untitled Modular Campaign (for yulionel829@gmail.com) (for Lionel Yu)","variable_values":{"subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf"}}, 
 {"id":"bdb58e5c-c4f6-4866-b78c-e66a428a2289","name":"ewqrrqewewr","variable_values":{"subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf"}}, 
 {"id":"a8a6cb36-0b46-4c5d-94e7-58ba66b3e376","name":"Send Email DreamPlay","variable_values":{"from_name": "Lionel Yu", "from_email": "lionel@email.dreamplaypianos.com"}}, 
 {"id":"8353d189-1bdd-497b-a52c-0f3d637bb1ce","name":"another test (for Lionel Yu)","variable_values":{"headline": "No More Strain.", "hero_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768127075901-DS6.0 Black copy.JPG", "from_name": "Lionel Yu", "from_email": "lionel@email.dreamplaypianos.com", "subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf", "learn_more_url": "https://www.dreamplaypianos.com/"}}, 
 {"id":"8d9edeb5-934f-4a50-8655-7aa72428bb03","name":"another test","variable_values":{"headline": "No More Strain.", "hero_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768127075901-DS6.0%20Black%20copy.JPG", "from_name": "Lionel Yu", "from_email": "lionel@email.dreamplaypianos.com", "learn_more_url": "https://www.dreamplaypianos.com/"}}, 
 {"id":"4caed8bf-f9d0-4418-9fb6-ed2e25b3afc1","name":"Copy of another test","variable_values":{"headline": "No More Strain.", "hero_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1769666192463-Main Product Grey Background.JPG", "from_name": "Lionel Yu", "from_email": "lionel@email.dreamplaypianos.com", "learn_more_url": "https://www.dreamplaypianos.com/"}}, 
 {"id":"aadf2695-9a27-42da-8d5d-5f2156d9c4ab","name":"another test (for Lionel Yu)","variable_values":{"headline": "No More Strain.", "hero_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1769666192463-Main Product Grey Background.JPG", "from_name": "Lionel Yu", "from_email": "lionel@email.dreamplaypianos.com", "subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf", "learn_more_url": "https://www.dreamplaypianos.com/"}}, 
 {"id":"ed03bcb6-93e0-42c7-807b-3955fe50c410","name":"Copy of another test (for Lionel Yu)","variable_values":{"headline": "No More Strain.", "hero_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1769666192463-Main Product Grey Background.JPG", "from_name": "Lionel Yu", "from_email": "lionel@email.dreamplaypianos.com", "subscriber_id": "871e0bbb-47c2-4ede-884f-23c4b4bb59bf", "learn_more_url": "https://www.dreamplaypianos.com/"}}]
</file>

<file path="campaign_record.json">
[{"variable_values":{"headline": "No More Strain.", "hero_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768127075901-DS6.0 Black copy.JPG", "from_name": "Lionel Yu", "from_email": "lionel@email.dreamplaypianos.com", "learn_more_url": "https://www.dreamplaypianos.com/"},"html_content":"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>DreamPlay - Narrow Keyboards</title>\n</head>\n<body style=\"margin: 0; padding: 0; font-family: Georgia, 'Times New Roman', serif; background-color: #f9f7f4;\">\n    <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color: #f9f7f4;\">\n        <tr>\n            <td align=\"center\" style=\"padding: 20px 0;\">\n                <table width=\"600\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color: #ffffff; border: 1px solid #e8e4df;\">\n                    <!-- Hero Image -->\n                    <tr>\n                        <td align=\"center\" style=\"padding: 0;\">\n                            <img src=\"{{hero_src}}\" alt=\"DreamPlay Keyboard\" width=\"600\" style=\"display: block; width: 100%; max-width: 600px; height: auto;\" />\n                        </td>\n                    </tr>\n                    <!-- Headline -->\n                    <tr>\n                        <td align=\"center\" style=\"padding: 30px 20px 20px 20px;\">\n                            <h1 style=\"margin: 0; font-size: 28px; font-weight: normal; color: #3a3a3a; line-height: 1.4; font-style: italic;\">{{headline}}</h1>\n                        </td>\n                    </tr>\n                    <!-- Letter Content -->\n                    <tr>\n                        <td style=\"padding: 0 45px 45px 45px;\">\n                            <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\">\n                                <tr>\n                                    <td style=\"padding-bottom: 20px;\">\n                                        <p style=\"margin: 0 0 18px 0; font-size: 16px; line-height: 1.7; color: #4a4a4a;\">\n                                            Dear Friend,\n                                        </p>\n                                        <p style=\"margin: 0 0 18px 0; font-size: 16px; line-height: 1.7; color: #4a4a4a;\">\n                                            I want to share something with you that's been close to my heart for years. You see, I've watched countless talented pianists struggle-not because they lacked skill or passion, but simply because standard keyboards weren't built for their hands.\n                                        </p>\n                                        <p style=\"margin: 0 0 18px 0; font-size: 16px; line-height: 1.7; color: #4a4a4a;\">\n                                            That's why we created DreamPlay. Our narrow keyboards-the DS5.5 and DS6.0-aren't just instruments. They're a revolution for pianists with medium and small-sized hands who've been told to \"stretch more\" or \"practice harder\" when the real issue was the keyboard itself.\n                                        </p>\n                                        <p style=\"margin: 0 0 18px 0; font-size: 16px; line-height: 1.7; color: #4a4a4a;\">\n                                            Imagine playing without that constant strain. Imagine reaching octaves comfortably, playing for hours without fatigue, and finally feeling like the piano was made for <em>you</em>. That's what our ergonomic design offers-not just comfort, but freedom.\n                                        </p>\n                                        <p style=\"margin: 0 0 18px 0; font-size: 16px; line-height: 1.7; color: #4a4a4a;\">\n                                            These aren't compromise instruments. They're professional-grade keyboards built for serious musicians who deserve equipment that works with their body, not against it.\n                                        </p>\n                                        <p style=\"margin: 0 0 30px 0; font-size: 16px; line-height: 1.7; color: #4a4a4a;\">\n                                            I'd love for you to experience the difference yourself. Your hands and your music will thank you.\n                                        </p>\n                                        <!-- Learn More Button -->\n                                        <table width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"margin: 0 0 30px 0;\">\n                                            <tr>\n                                                <td align=\"center\">\n                                                    <a href=\"{{learn_more_url}}\" style=\"display: inline-block; padding: 14px 40px; background-color: #5a5a5a; color: #ffffff; text-decoration: none; font-size: 16px; font-family: Georgia, 'Times New Roman', serif; border-radius: 3px; font-weight: normal;\">Learn More</a>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                        <p style=\"margin: 0 0 5px 0; font-size: 16px; line-height: 1.7; color: #4a4a4a;\">\n                                            Warmly,\n                                        </p>\n                                        <p style=\"margin: 0; font-size: 18px; line-height: 1.7; color: #4a4a4a; font-style: italic;\">\n                                            The DreamPlay Team\n                                        </p>\n                                    </td>\n                                </tr>\n                            </table>\n                        </td>\n                    </tr>\n                </table>\n            </td>\n        </tr>\n    </table>\n</body>\n</html>"}]
</file>

<file path="campaign_updated.json">
[{"variable_values":{"headline": "No More Strain.", "hero_src": "https://quyqwdjygzalqqmrgkfk.supabase.co/storage/v1/object/public/email-assets/1768127075901-DS6.0%20Black%20copy.JPG", "from_name": "Lionel Yu", "from_email": "lionel@email.dreamplaypianos.com", "learn_more_url": "https://www.dreamplaypianos.com/"}}]
</file>

<file path="next.config.mjs">
/** @type {import('next').NextConfig} */
const nextConfig = {
    typescript: {
        ignoreBuildErrors: true,
    },
    images: {
        unoptimized: true,
    },
}

export default nextConfig
</file>

<file path="postcss.config.mjs">
/** @type {import('postcss-load-config').Config} */
const config = {
    plugins: {
        '@tailwindcss/postcss': {},
    },
}

export default config
</file>

<file path="recent_files.json">
[{"name":"1769666192463-Main Product Grey Background.JPG","id":"5416e365-83a6-4784-a483-23af5c6547f0","updated_at":"2026-01-29T05:56:32.768Z","created_at":"2026-01-29T05:56:32.768Z","last_accessed_at":"2026-01-29T05:56:32.768Z","metadata":{"eTag":"\"7425c9e2c9b39e8d8fe3249d2a5b859f\"","size":440080,"mimetype":"image/jpeg","cacheControl":"max-age=3600","lastModified":"2026-01-29T05:56:33.000Z","contentLength":440080,"httpStatusCode":200}},{"name":"1769666179539-DS6.0 White.JPG","id":"aa232c4c-60c6-4517-bd3f-e8d4135cceae","updated_at":"2026-01-29T05:56:20.459Z","created_at":"2026-01-29T05:56:20.459Z","last_accessed_at":"2026-01-29T05:56:20.459Z","metadata":{"eTag":"\"b8863cdee2097399bb447cff987055e7\"","size":3398613,"mimetype":"image/jpeg","cacheControl":"max-age=3600","lastModified":"2026-01-29T05:56:21.000Z","contentLength":3398613,"httpStatusCode":200}},{"name":"1768193535466-screenshots-639.png","id":"a88f505b-6e70-4ae0-9fa0-420f77c2b9f9","updated_at":"2026-01-12T04:52:15.913Z","created_at":"2026-01-12T04:52:15.913Z","last_accessed_at":"2026-01-12T04:52:15.913Z","metadata":{"eTag":"\"5ed4408de64e37efff1894e0c9d6a34c\"","size":1034638,"mimetype":"image/png","cacheControl":"max-age=3600","lastModified":"2026-01-12T04:52:16.000Z","contentLength":1034638,"httpStatusCode":200}},{"name":"1768193507053-screenshots-638.png","id":"07a1fa51-d771-420b-bb39-a087194ea3f7","updated_at":"2026-01-12T04:51:47.422Z","created_at":"2026-01-12T04:51:47.422Z","last_accessed_at":"2026-01-12T04:51:47.422Z","metadata":{"eTag":"\"717885a9b4f9dcf3a6448e701917653a\"","size":786041,"mimetype":"image/png","cacheControl":"max-age=3600","lastModified":"2026-01-12T04:51:48.000Z","contentLength":786041,"httpStatusCode":200}},{"name":"1768193458980-Thumbnail.jpg","id":"109c0c81-7114-4381-8ef5-abd324f8c5db","updated_at":"2026-01-12T04:50:59.528Z","created_at":"2026-01-12T04:50:59.528Z","last_accessed_at":"2026-01-12T04:50:59.528Z","metadata":{"eTag":"\"7bed52f599f6304ab2672cb378c53645\"","size":954607,"mimetype":"image/jpeg","cacheControl":"max-age=3600","lastModified":"2026-01-12T04:51:00.000Z","contentLength":954607,"httpStatusCode":200}}]
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "target": "ES6",
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules",
    "_legacy_v0_code"
  ]
}
</file>

<file path="app/(dashboard)/analytics/page.tsx">
"use client"

import { useEffect, useState } from "react"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Users, Mail, MousePointer2, DollarSign, ArrowUpRight, ArrowDownRight, Smartphone, Monitor, Loader2 } from "lucide-react"
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts'

export default function AnalyticsPage() {
    const [data, setData] = useState<any>(null)
    const [loading, setLoading] = useState(true)

    useEffect(() => {
        // Fetch real data on load
        fetch('/api/analytics')
            .then(res => res.json())
            .then(realData => {
                setData(realData)
                setLoading(false)
            })
            .catch(err => {
                console.error("Failed to fetch analytics:", err)
                setLoading(false)
            })
    }, [])

    if (loading) {
        return (
            <div className="flex h-screen items-center justify-center bg-background text-foreground">
                <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
            </div>
        )
    }

    // Default empty state if data fails
    const kpi = data?.kpi || { revenue: 0, subscribers: 0, openRate: 0, clickRate: 0 }
    const chartData = data?.chart || []
    const recentCampaigns = data?.recent || []

    return (
        <div className="p-8 space-y-8 bg-background min-h-screen text-foreground">

            {/* 1. HEADER */}
            <div className="flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold tracking-tight">Campaign Intelligence</h1>
                    <p className="text-muted-foreground mt-1">Performance for DreamPlay Pianos (Last 30 Days)</p>
                </div>
                <div className="flex gap-2">
                    <span className="bg-green-900/30 text-green-400 px-3 py-1 rounded-full text-xs font-medium border border-green-900/50 flex items-center gap-2">
                        <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
                        All Systems Operational
                    </span>
                </div>
            </div>

            {/* 2. KPI CARDS */}
            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                <KpiCard
                    title="Total Revenue"
                    value={`$${kpi.revenue.toLocaleString()}`}
                    icon={<DollarSign className="h-4 w-4 text-emerald-500" />}
                    trend="+12%" // You could calculate this if you had historical data
                    trendUp={true}
                />
                <KpiCard
                    title="Active Subscribers"
                    value={kpi.subscribers.toLocaleString()}
                    icon={<Users className="h-4 w-4 text-blue-500" />}
                    trend="+2.1%"
                    trendUp={true}
                />
                <KpiCard
                    title="Avg. Open Rate"
                    value={`${kpi.openRate.toFixed(1)}%`}
                    icon={<Mail className="h-4 w-4 text-purple-500" />}
                    trend="-1.4%"
                    trendUp={false}
                    subtext="Industry avg: 38%"
                />
                <KpiCard
                    title="Click-Through Rate"
                    value={`${kpi.clickRate.toFixed(1)}%`}
                    icon={<MousePointer2 className="h-4 w-4 text-orange-500" />}
                    trend="+0.8%"
                    trendUp={true}
                />
            </div>

            {/* 3. VISUALIZATIONS */}
            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-7">

                {/* Main Chart */}
                <Card className="col-span-4 bg-card border-border">
                    <CardHeader>
                        <CardTitle>Engagement Velocity</CardTitle>
                        <CardDescription>Opens vs. Clicks over the last 30 days</CardDescription>
                    </CardHeader>
                    <CardContent className="pl-2">
                        <div className="h-[300px] w-full">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart data={chartData}>
                                    <CartesianGrid strokeDasharray="3 3" stroke="#333" vertical={false} />
                                    <XAxis dataKey="day" stroke="#888" fontSize={12} tickLine={false} axisLine={false} />
                                    <YAxis stroke="#888" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `${value}`} />
                                    <Tooltip
                                        contentStyle={{ backgroundColor: '#1f1f1f', borderColor: '#333', borderRadius: '8px' }}
                                        itemStyle={{ color: '#fff' }}
                                    />
                                    <Line type="monotone" dataKey="opens" stroke="#8b5cf6" strokeWidth={2} dot={false} activeDot={{ r: 8 }} />
                                    <Line type="monotone" dataKey="clicks" stroke="#10b981" strokeWidth={2} dot={false} />
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                    </CardContent>
                </Card>

                {/* Side Chart: Device Split (Static for now as mostly client-side tracking) */}
                <Card className="col-span-3 bg-card border-border">
                    <CardHeader>
                        <CardTitle>Device Breakdown</CardTitle>
                        <CardDescription>Where are your pianists reading?</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <div className="flex items-center justify-center gap-8 mb-6">
                            <div className="flex flex-col items-center">
                                <div className="bg-primary/10 p-3 rounded-full mb-2">
                                    <Smartphone className="w-6 h-6 text-primary" />
                                </div>
                                <span className="text-2xl font-bold">65%</span>
                                <span className="text-xs text-muted-foreground">Mobile</span>
                            </div>
                            <div className="w-px h-12 bg-border" />
                            <div className="flex flex-col items-center">
                                <div className="bg-muted p-3 rounded-full mb-2">
                                    <Monitor className="w-6 h-6 text-muted-foreground" />
                                </div>
                                <span className="text-2xl font-bold">35%</span>
                                <span className="text-xs text-muted-foreground">Desktop</span>
                            </div>
                        </div>
                        <p className="text-sm text-center text-muted-foreground">
                            Your audience is highly mobile. Ensure your "Buy Now" buttons are large and tap-friendly.
                        </p>
                    </CardContent>
                </Card>
            </div>

            {/* 4. RECENT CAMPAIGNS LIST */}
            <Card className="bg-card border-border">
                <CardHeader>
                    <CardTitle>Recent Campaigns</CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="space-y-8">
                        {recentCampaigns.length === 0 ? (
                            <div className="text-center text-muted-foreground py-8">
                                No campaigns sent yet. Start your first broadcast!
                            </div>
                        ) : (
                            recentCampaigns.map((campaign: any, i: number) => {
                                const openRate = campaign.total_recipients > 0
                                    ? ((campaign.total_opens || 0) / campaign.total_recipients * 100).toFixed(1)
                                    : "0.0";
                                const clickRate = campaign.total_recipients > 0
                                    ? ((campaign.total_clicks || 0) / campaign.total_recipients * 100).toFixed(1)
                                    : "0.0";

                                return (
                                    <div key={campaign.id || i} className="flex items-center justify-between border-b border-border pb-4 last:border-0 last:pb-0">
                                        <div className="space-y-1">
                                            <p className="text-sm font-medium leading-none">{campaign.name}</p>
                                            <p className="text-xs text-muted-foreground">
                                                {campaign.sent_at
                                                    ? new Date(campaign.sent_at).toLocaleDateString()
                                                    : "Draft"}
                                            </p>
                                        </div>
                                        <div className="flex items-center gap-8">
                                            <div className="text-right">
                                                <p className="text-xs text-muted-foreground">Open Rate</p>
                                                <p className="font-bold text-sm">{openRate}%</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-muted-foreground">Click Rate</p>
                                                <p className="font-bold text-sm text-emerald-400">{clickRate}%</p>
                                            </div>
                                            <div className={`text-xs px-2 py-1 rounded border capitalize ${campaign.status === 'sending' ? 'bg-blue-500/10 border-blue-500/20 text-blue-400' :
                                                    campaign.status === 'completed' ? 'bg-green-500/10 border-green-500/20 text-green-400' :
                                                        'bg-muted border-border'
                                                }`}>
                                                {campaign.status}
                                            </div>
                                        </div>
                                    </div>
                                )
                            })
                        )}
                    </div>
                </CardContent>
            </Card>
        </div>
    )
}

function KpiCard({ title, value, icon, trend, trendUp, subtext }: any) {
    return (
        <Card className="bg-card border-border">
            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium text-muted-foreground">
                    {title}
                </CardTitle>
                {icon}
            </CardHeader>
            <CardContent>
                <div className="text-2xl font-bold">{value}</div>
                <div className="flex items-center gap-2 mt-1">
                    <span className={`text-xs flex items-center ${trendUp ? 'text-emerald-500' : 'text-red-500'}`}>
                        {trendUp ? <ArrowUpRight className="h-3 w-3 mr-1" /> : <ArrowDownRight className="h-3 w-3 mr-1" />}
                        {trend}
                    </span>
                    {subtext && <span className="text-xs text-muted-foreground ml-1">{subtext}</span>}
                </div>
            </CardContent>
        </Card>
    )
}
</file>

<file path="app/(dashboard)/assets/page.tsx">
"use client"

import { useState, useCallback, useEffect } from "react"
import { Upload, ImageIcon, Loader2, Trash2 } from "lucide-react"
import { cn } from "@/lib/utils"
import { createClient } from "@/lib/supabase/client"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { deleteAsset } from "@/app/actions/assets"

interface Asset {
    id: string
    name: string
    url: string
    size?: number
    created_at?: string
}

export default function AssetsPage() {
    const [assets, setAssets] = useState<Asset[]>([])
    const [loading, setLoading] = useState(true)
    const [uploading, setUploading] = useState(false)
    const [deleting, setDeleting] = useState<string | null>(null)
    const [isDragOver, setIsDragOver] = useState(false)
    const supabase = createClient()

    const fetchAssets = useCallback(async () => {
        setLoading(true)
        const { data, error } = await supabase.storage.from("email-assets").list()

        if (error) {
            console.error("Error fetching assets:", error)
        } else if (data) {
            const loadedAssets: Asset[] = data.map((file) => ({
                id: file.id,
                name: file.name,
                url: `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/email-assets/${encodeURIComponent(file.name)}`,
                size: file.metadata?.size,
                created_at: file.created_at,
            }))
            setAssets(loadedAssets)
        }
        setLoading(false)
    }, [supabase])

    useEffect(() => {
        fetchAssets()
    }, [fetchAssets])

    // Compress Image using Canvas
    const compressImage = async (file: File): Promise<File> => {
        return new Promise((resolve, reject) => {
            const img = new Image()
            const reader = new FileReader()

            reader.onload = (e) => {
                img.src = e.target?.result as string
            }
            reader.onerror = reject

            img.onload = () => {
                const canvas = document.createElement("canvas")
                const ctx = canvas.getContext("2d")
                if (!ctx) return reject(new Error("Canvas context failed"))

                const MAX_WIDTH = 1200
                const MAX_HEIGHT = 1200
                let width = img.width
                let height = img.height

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width
                        width = MAX_WIDTH
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height
                        height = MAX_HEIGHT
                    }
                }

                canvas.width = width
                canvas.height = height
                ctx.drawImage(img, 0, 0, width, height)

                canvas.toBlob(
                    (blob) => {
                        if (!blob) return reject(new Error("Compression failed"))
                        const compressedFile = new File([blob], file.name, {
                            type: "image/jpeg",
                            lastModified: Date.now(),
                        })
                        resolve(compressedFile)
                    },
                    "image/jpeg",
                    0.8,
                )
            }

            reader.readAsDataURL(file)
        })
    }

    const handleFileUpload = async (file: File) => {
        setUploading(true)

        try {
            let fileToUpload = file
            if (file.type.startsWith("image/")) {
                fileToUpload = await compressImage(file)
            }

            const fileName = `${Date.now()}-${fileToUpload.name}`
            const { error } = await supabase.storage.from("email-assets").upload(fileName, fileToUpload)

            if (error) {
                console.error("Error uploading file:", error)
            } else {
                await fetchAssets()
            }
        } catch (e) {
            console.error("Upload process failed:", e)
        }
        setUploading(false)
    }

    const handleDelete = async (asset: Asset) => {
        if (!confirm(`Delete "${asset.name}"? This cannot be undone.`)) return

        setDeleting(asset.id)
        const result = await deleteAsset(asset.name)

        if (!result.success) {
            console.error("Error deleting asset:", result.error)
        } else {
            await fetchAssets()
        }
        setDeleting(null)
    }

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault()
        setIsDragOver(true)
    }, [])

    const handleDragLeave = useCallback((e: React.DragEvent) => {
        e.preventDefault()
        setIsDragOver(false)
    }, [])

    const handleDrop = useCallback(
        (e: React.DragEvent) => {
            e.preventDefault()
            setIsDragOver(false)
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFileUpload(e.dataTransfer.files[0])
            }
        },
        [],
    )

    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            handleFileUpload(e.target.files[0])
        }
    }

    const formatFileSize = (bytes?: number) => {
        if (!bytes) return "Unknown"
        if (bytes < 1024) return `${bytes} B`
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
    }

    return (
        <div className="p-6">
            <div className="mb-6">
                <h1 className="text-2xl font-bold tracking-tight text-foreground">Assets Library</h1>
                <p className="text-muted-foreground">Manage your email images and assets</p>
            </div>

            <Card className="mb-6">
                <CardHeader>
                    <CardTitle>Upload New Asset</CardTitle>
                    <CardDescription>Images are automatically compressed for optimal email delivery</CardDescription>
                </CardHeader>
                <CardContent>
                    <div
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                        onClick={() => document.getElementById("asset-upload")?.click()}
                        className={cn(
                            "flex flex-col items-center justify-center gap-3 py-12 rounded-lg border-2 border-dashed transition-colors cursor-pointer",
                            isDragOver
                                ? "border-primary bg-primary/5"
                                : "border-muted-foreground/25 hover:border-primary hover:bg-primary/5",
                        )}
                    >
                        <input
                            id="asset-upload"
                            type="file"
                            accept="image/*"
                            className="hidden"
                            onChange={handleFileSelect}
                        />
                        {uploading ? (
                            <Loader2 className="w-10 h-10 text-primary animate-spin" />
                        ) : (
                            <Upload className={cn("w-10 h-10", isDragOver ? "text-primary" : "text-muted-foreground")} />
                        )}
                        <p className="text-sm text-muted-foreground">
                            {uploading ? (
                                "Uploading..."
                            ) : (
                                <>
                                    Drag & drop or <span className="text-primary font-medium">click to upload</span>
                                </>
                            )}
                        </p>
                    </div>
                </CardContent>
            </Card>

            <Card>
                <CardHeader>
                    <CardTitle>Your Assets</CardTitle>
                    <CardDescription>Showing {assets.length} assets</CardDescription>
                </CardHeader>
                <CardContent>
                    {loading ? (
                        <div className="flex justify-center py-12">
                            <Loader2 className="w-8 h-8 text-muted-foreground animate-spin" />
                        </div>
                    ) : assets.length === 0 ? (
                        <div className="flex flex-col items-center justify-center py-16 text-center">
                            <ImageIcon className="w-12 h-12 text-muted-foreground mb-3" />
                            <p className="text-muted-foreground">No assets found. Upload one to get started.</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            {assets.map((asset) => (
                                <div
                                    key={asset.id}
                                    className="group relative aspect-square rounded-lg overflow-hidden bg-muted border border-border"
                                >
                                    <img
                                        src={asset.url || "/placeholder.svg"}
                                        alt={asset.name}
                                        className="w-full h-full object-cover"
                                    />
                                    <div className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent px-2 py-2">
                                        <p className="text-xs text-white truncate">{asset.name}</p>
                                        <p className="text-xs text-white/60">{formatFileSize(asset.size)}</p>
                                    </div>
                                    {/* Delete Button */}
                                    <button
                                        onClick={() => handleDelete(asset)}
                                        disabled={deleting === asset.id}
                                        className="absolute top-2 right-2 w-8 h-8 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-50"
                                        title="Delete asset"
                                    >
                                        {deleting === asset.id ? (
                                            <Loader2 className="w-4 h-4 text-white animate-spin" />
                                        ) : (
                                            <Trash2 className="w-4 h-4 text-white" />
                                        )}
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>
    )
}
</file>

<file path="app/(dashboard)/campaigns/page.tsx">
import { CampaignsTable } from "@/components/campaigns-table"
import { CreateCampaignDialog } from "@/components/campaigns/create-campaign-dialog"
import { getCampaigns } from "@/app/actions/campaigns"

export const dynamic = "force-dynamic"

export default async function CampaignsPage() {
    const campaigns = await getCampaigns()

    return (
        <div className="p-6 space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight text-foreground">Campaigns</h1>
                    <p className="text-muted-foreground mt-1">
                        Manage your email campaigns and newsletters.
                    </p>
                </div>
                <CreateCampaignDialog />
            </div>

            <div className="space-y-8">
                {/* Drafts Section */}
                <CampaignsTable
                    title="Drafts"
                    campaigns={campaigns.filter(c => c.status === 'draft')}
                    loading={false}
                />

                {/* Sent Section */}
                <CampaignsTable
                    title="Sent Campaigns"
                    campaigns={campaigns.filter(c => ['sent', 'completed', 'active'].includes(c.status))}
                    loading={false}
                />
            </div>
        </div>
    )
}
</file>

<file path="app/(dashboard)/dashboard/[id]/page.tsx">
import { CampaignLaunchChecks } from "@/components/campaign/campaign-launch-checks"
import { createClient } from "@/lib/supabase/server"
import { Campaign } from "@/lib/types"
import { notFound } from "next/navigation"

interface DashboardPageProps {
    params: Promise<{ id: string }>
}

export default async function DashboardPage({ params }: DashboardPageProps) {
    const { id } = await params
    const supabase = await createClient()

    // Fetch Campaign
    const { data: campaign, error: campaignError } = await supabase
        .from("campaigns")
        .select("*")
        .eq("id", id)
        .single()

    if (campaignError || !campaign) {
        notFound()
    }

    // Check for single subscriber lock
    let targetSubscriber = null
    const lockedSubscriberId = campaign.variable_values?.subscriber_id

    if (lockedSubscriberId) {
        const { data: subscriber } = await supabase
            .from("subscribers")
            .select("*")
            .eq("id", lockedSubscriberId)
            .single()

        targetSubscriber = subscriber
    }

    // Fetch Subscriber Count
    // If locked, count is 1. Otherwise fetch total active.
    let subscriberCount = 0
    if (lockedSubscriberId) {
        subscriberCount = 1
    } else {
        const { count, error: countError } = await supabase
            .from("subscribers")
            .select("*", { count: 'exact', head: true })
            .eq("status", "active")
        subscriberCount = count || 0
    }

    const audience = {
        total_subscribers: subscriberCount,
        active_subscribers: subscriberCount
    }

    return (
        <CampaignLaunchChecks
            campaign={campaign as Campaign}
            audience={audience}
            targetSubscriber={targetSubscriber}
        />
    )
}
</file>

<file path="app/layout.tsx">
import type React from "react"
import type { Metadata } from "next"
import { Geist, Geist_Mono } from "next/font/google"
import { Analytics } from "@vercel/analytics/next"
import { WebsiteTracker } from "@/components/website-tracker"
import "./globals.css"

const geistSans = Geist({
  subsets: ["latin"],
  variable: "--font-sans"
})
const geistMono = Geist_Mono({
  subsets: ["latin"],
  variable: "--font-mono"
})

export const metadata: Metadata = {
  title: "Musical Basics Engine",
  description: "Email Marketing Command Center",
}

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode
}>) {
  return (
    <html lang="en" className="dark">
      <body className={`${geistSans.variable} ${geistMono.variable} font-sans antialiased`}>
        <WebsiteTracker />
        {children}
        <Analytics />
      </body>
    </html>
  )
}
</file>

<file path="components/campaign/broadcast-confirm-dialog.tsx">
"use client"

import { AlertTriangle, Rocket, X } from "lucide-react"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
} from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"

interface BroadcastConfirmDialogProps {
    open: boolean
    onOpenChange: (open: boolean) => void
    subscriberCount: number
    campaignName: string
    subjectLine: string | null
    onConfirm: () => void
}

export function BroadcastConfirmDialog({
    open,
    onOpenChange,
    subscriberCount,
    campaignName,
    subjectLine,
    onConfirm,
}: BroadcastConfirmDialogProps) {
    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent className="border-border bg-card sm:max-w-md">
                <DialogHeader className="space-y-3">
                    <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-amber-500/10">
                        <AlertTriangle className="h-6 w-6 text-amber-500" />
                    </div>
                    <DialogTitle className="text-center text-foreground">Confirm Broadcast</DialogTitle>
                    <DialogDescription className="text-center text-muted-foreground">
                        You are about to send this campaign. This action cannot be undone.
                    </DialogDescription>
                </DialogHeader>

                <div className="space-y-3 rounded-lg border border-border bg-background p-4">
                    <div>
                        <p className="text-xs font-medium uppercase tracking-wider text-muted-foreground">Campaign</p>
                        <p className="text-foreground">{campaignName}</p>
                    </div>
                    <div>
                        <p className="text-xs font-medium uppercase tracking-wider text-muted-foreground">Subject Line</p>
                        <p className="text-foreground">{subjectLine || "(No Subject)"}</p>
                    </div>
                    <div>
                        <p className="text-xs font-medium uppercase tracking-wider text-muted-foreground">Recipients</p>
                        <p className="text-lg font-semibold text-[#D4AF37]">
                            {subscriberCount === 1 ? "1 subscriber" : `${subscriberCount.toLocaleString()} subscribers`}
                        </p>
                    </div>
                </div>

                <DialogFooter className="flex-col gap-2 sm:flex-col">
                    <Button onClick={onConfirm} className="w-full gap-2 bg-[#D4AF37] text-[#050505] hover:bg-[#b8962e]">
                        <Rocket className="h-4 w-4" />
                        Yes, Send Broadcast Now
                    </Button>
                    <Button
                        variant="outline"
                        onClick={() => onOpenChange(false)}
                        className="w-full gap-2 border-border hover:bg-secondary"
                    >
                        <X className="h-4 w-4" />
                        Cancel
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}
</file>

<file path="components/campaign/email-preview-card.tsx">
"use client"

import { Monitor, Smartphone, Mail } from "lucide-react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Campaign } from "@/lib/types"

interface EmailPreviewCardProps {
    campaign: Campaign
    previewMode: "desktop" | "mobile"
    onPreviewModeChange: (mode: "desktop" | "mobile") => void
}

export function EmailPreviewCard({ campaign, previewMode, onPreviewModeChange }: EmailPreviewCardProps) {
    // Replace Mustache variables with actual values for preview
    const renderedHtml = Object.entries(campaign.variable_values || {}).reduce(
        (html, [key, value]) => html.replace(new RegExp(`{{${key}}}`, "g"), value),
        campaign.html_content || "",
    )

    return (
        <Card className="h-full border-border bg-card">
            <CardHeader className="flex flex-row items-center justify-between pb-3">
                <CardTitle className="flex items-center gap-2 text-base font-medium text-foreground">
                    <Mail className="h-5 w-5 text-[#D4AF37]" />
                    Email Preview
                </CardTitle>

                {/* Desktop/Mobile Toggle */}
                <div className="flex gap-1 rounded-lg border border-border bg-background p-1">
                    <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => onPreviewModeChange("desktop")}
                        className={`gap-2 ${previewMode === "desktop"
                            ? "bg-[#D4AF37] text-[#050505] hover:bg-[#D4AF37]"
                            : "text-muted-foreground hover:bg-secondary hover:text-foreground"
                            }`}
                    >
                        <Monitor className="h-4 w-4" />
                        <span className="hidden sm:inline">Desktop</span>
                    </Button>
                    <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => onPreviewModeChange("mobile")}
                        className={`gap-2 ${previewMode === "mobile"
                            ? "bg-[#D4AF37] text-[#050505] hover:bg-[#D4AF37]"
                            : "text-muted-foreground hover:bg-secondary hover:text-foreground"
                            }`}
                    >
                        <Smartphone className="h-4 w-4" />
                        <span className="hidden sm:inline">Mobile</span>
                    </Button>
                </div>
            </CardHeader>

            <CardContent>
                {/* Preview Viewport Container */}
                <div className="flex justify-center rounded-lg border border-border bg-zinc-950 p-4">
                    {/* Device Frame */}
                    <div
                        className={`relative overflow-hidden rounded-lg border-2 border-zinc-700 bg-white shadow-2xl transition-all duration-300 ${previewMode === "mobile" ? "w-[375px]" : "w-full max-w-[600px]"
                            }`}
                    >
                        {/* Browser Chrome */}
                        <div className="flex items-center gap-2 border-b border-zinc-200 bg-zinc-100 px-4 py-2">
                            <div className="flex gap-1.5">
                                <div className="h-3 w-3 rounded-full bg-red-400" />
                                <div className="h-3 w-3 rounded-full bg-yellow-400" />
                                <div className="h-3 w-3 rounded-full bg-green-400" />
                            </div>
                            <div className="flex-1 rounded-md bg-white px-3 py-1 text-xs text-zinc-400">mail.example.com</div>
                        </div>

                        {/* Email Content */}
                        <div
                            className="h-[800px] overflow-y-auto"
                            style={{ minHeight: previewMode === "mobile" ? "800px" : "800px" }}
                        >
                            <iframe
                                srcDoc={renderedHtml}
                                title="Email Preview"
                                className="h-full w-full border-0"
                                sandbox="allow-same-origin"
                            />
                        </div>
                    </div>
                </div>

                <p className="mt-4 text-center text-xs text-muted-foreground">
                    Preview shows how the email will appear in recipient inboxes
                </p>
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/campaign/launchpad-card.tsx">
"use client"

import { Rocket, AlertTriangle } from "lucide-react"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Button } from "@/components/ui/button"

interface LaunchpadCardProps {
    subscriberCount: number
    onLaunch: () => void
    isDisabled?: boolean
}

export function LaunchpadCard({ subscriberCount, onLaunch, isDisabled }: LaunchpadCardProps) {
    return (
        <Card className="border-2 border-[#D4AF37]/30 bg-gradient-to-b from-[#D4AF37]/5 to-transparent">
            <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-base font-medium text-foreground">
                    <Rocket className="h-5 w-5 text-[#D4AF37]" />
                    The Launchpad
                </CardTitle>
                <CardDescription className="text-muted-foreground">Danger Zone — This action cannot be undone.</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
                <div className="flex items-start gap-3 rounded-lg border border-amber-500/20 bg-amber-500/5 p-3">
                    <AlertTriangle className="mt-0.5 h-5 w-5 shrink-0 text-amber-500" />
                    <p className="text-sm text-muted-foreground">
                        You are about to send this campaign to{" "}
                        <span className="font-semibold text-foreground">
                            {subscriberCount === 1 ? "1 subscriber" : `${subscriberCount.toLocaleString()} subscribers`}
                        </span>.
                        Please review everything before launching.
                    </p>
                </div>

                <Button
                    onClick={onLaunch}
                    disabled={isDisabled}
                    className="w-full gap-2 bg-[#D4AF37] text-[#050505] hover:bg-[#b8962e] disabled:opacity-50"
                    size="lg"
                >
                    <Rocket className="h-5 w-5" />
                    Send Broadcast to All Subscribers
                </Button>

                {isDisabled && (
                    <p className="text-center text-sm text-muted-foreground">This campaign has already been sent.</p>
                )}
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/campaign/sender-identity-card.tsx">
"use client"

import { User, Mail } from "lucide-react"
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"

interface SenderIdentityCardProps {
    fromName: string
    fromEmail: string
    onFromNameChange?: (value: string) => void
    onFromEmailChange?: (value: string) => void
    readOnly?: boolean
}

export function SenderIdentityCard({
    fromName,
    fromEmail,
    onFromNameChange,
    onFromEmailChange,
    readOnly = false,
}: SenderIdentityCardProps) {
    return (
        <Card className="border-border bg-card">
            <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-base font-medium text-foreground">
                    <User className="h-5 w-5 text-[#D4AF37]" />
                    Sender Identity
                </CardTitle>
                <CardDescription className="text-muted-foreground">
                    Who your subscribers will see this email from.
                </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
                <div className="space-y-2">
                    <Label htmlFor="from-name" className="text-sm text-muted-foreground">
                        From Name
                    </Label>
                    <div className="relative">
                        <User className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                        <Input
                            id="from-name"
                            value={fromName}
                            onChange={(e) => onFromNameChange?.(e.target.value)}
                            readOnly={readOnly}
                            className="pl-10 border-border bg-background text-foreground placeholder:text-muted-foreground focus-visible:ring-[#D4AF37]"
                            placeholder="e.g., Lionel Yu"
                        />
                    </div>
                </div>
                <div className="space-y-2">
                    <Label htmlFor="from-email" className="text-sm text-muted-foreground">
                        From Email
                    </Label>
                    <div className="relative">
                        <Mail className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                        <Input
                            id="from-email"
                            type="email"
                            value={fromEmail}
                            onChange={(e) => onFromEmailChange?.(e.target.value)}
                            readOnly={readOnly}
                            className="pl-10 border-border bg-background text-foreground placeholder:text-muted-foreground focus-visible:ring-[#D4AF37]"
                            placeholder="e.g., lionel@email.dreamplaypianos.com"
                        />
                    </div>
                </div>
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/editor/block-manager.tsx">
"use client"

import { ArrowUp, ArrowDown, Plus, Trash2, Edit2, GripVertical, Layers } from "lucide-react"
import { Button } from "@/components/ui/button"
import { ScrollArea } from "@/components/ui/scroll-area"
import { cn } from "@/lib/utils"
import { useState } from "react"

export interface Block {
    id: string
    name: string
    content: string
}

interface BlockManagerProps {
    blocks: Block[]
    activeBlockId: string | null
    onSelectBlock: (id: string) => void
    onUpdateBlocks: (blocks: Block[]) => void
    onAddBlock: () => void
}

export function BlockManager({ blocks, activeBlockId, onSelectBlock, onUpdateBlocks, onAddBlock }: BlockManagerProps) {
    const [editingId, setEditingId] = useState<string | null>(null)
    const [editName, setEditName] = useState("")
    const [draggedIndex, setDraggedIndex] = useState<number | null>(null)

    const moveBlock = (index: number, direction: -1 | 1, e: React.MouseEvent) => {
        e.stopPropagation()
        const newBlocks = [...blocks]
        if (direction === -1 && index > 0) {
            [newBlocks[index], newBlocks[index - 1]] = [newBlocks[index - 1], newBlocks[index]]
        } else if (direction === 1 && index < newBlocks.length - 1) {
            [newBlocks[index], newBlocks[index + 1]] = [newBlocks[index + 1], newBlocks[index]]
        }
        onUpdateBlocks(newBlocks)
    }

    const deleteBlock = (id: string, e: React.MouseEvent) => {
        e.stopPropagation()
        if (confirm("Delete this block?")) {
            const newBlocks = blocks.filter(b => b.id !== id)
            onUpdateBlocks(newBlocks)
            if (activeBlockId === id && newBlocks.length > 0) onSelectBlock(newBlocks[0].id)
        }
    }

    const startRenaming = (block: Block, e: React.MouseEvent) => {
        e.stopPropagation()
        setEditingId(block.id)
        setEditName(block.name)
    }

    const saveName = () => {
        if (editingId) {
            const newBlocks = blocks.map(b => b.id === editingId ? { ...b, name: editName } : b)
            onUpdateBlocks(newBlocks)
            setEditingId(null)
        }
    }

    // --- DnD HANDLERS ---
    const handleDragStart = (e: React.DragEvent, index: number) => {
        setDraggedIndex(index)
        e.dataTransfer.effectAllowed = "move"
        // Transparent image or simple ref logic could be used here for preview
        // check browser default behavior
    }

    const handleDragOver = (e: React.DragEvent, index: number) => {
        e.preventDefault() // Necessary for onDrop to fire
        e.dataTransfer.dropEffect = "move"
    }

    const handleDrop = (e: React.DragEvent, dropIndex: number) => {
        e.preventDefault()
        if (draggedIndex === null || draggedIndex === dropIndex) return

        const newBlocks = [...blocks]
        const [movedItem] = newBlocks.splice(draggedIndex, 1)
        newBlocks.splice(dropIndex, 0, movedItem)

        onUpdateBlocks(newBlocks)
        setDraggedIndex(null)
    }

    return (
        <div className="flex flex-col h-full bg-card w-full">
            <div className="p-4 border-b border-border flex items-center justify-between">
                <div className="flex items-center gap-2 font-semibold text-sm">
                    <Layers className="w-4 h-4 text-muted-foreground" />
                    <span>Layout Blocks</span>
                </div>
                <Button size="sm" variant="ghost" onClick={onAddBlock} className="h-8 w-8 p-0">
                    <Plus className="w-4 h-4" />
                </Button>
            </div>

            <ScrollArea className="flex-1">
                <div className="p-2 space-y-1">
                    {blocks.map((block, index) => (
                        <div
                            key={block.id}
                            draggable
                            onDragStart={(e) => handleDragStart(e, index)}
                            onDragOver={(e) => handleDragOver(e, index)}
                            onDrop={(e) => handleDrop(e, index)}
                            onClick={() => onSelectBlock(block.id)}
                            className={cn(
                                "group flex items-center gap-2 p-2 rounded-md text-sm cursor-pointer border transition-all",
                                activeBlockId === block.id
                                    ? "bg-primary/10 border-primary/50 text-primary font-medium"
                                    : "bg-transparent border-transparent hover:bg-muted text-muted-foreground",
                                draggedIndex === index && "opacity-50 border-dashed border-primary"
                            )}
                        >
                            <GripVertical className="w-4 h-4 opacity-20 group-hover:opacity-100 transition-opacity cursor-grab active:cursor-grabbing" />

                            {editingId === block.id ? (
                                <input
                                    className="flex-1 bg-background border rounded px-1 min-w-0"
                                    value={editName}
                                    onChange={(e) => setEditName(e.target.value)}
                                    onBlur={saveName}
                                    onKeyDown={(e) => e.key === 'Enter' && saveName()}
                                    autoFocus
                                    onClick={(e) => e.stopPropagation()}
                                />
                            ) : (
                                <span className="flex-1 truncate select-none">{block.name}</span>
                            )}

                            <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={(e) => startRenaming(block, e)} className="p-1 hover:text-foreground">
                                    <Edit2 className="w-3 h-3" />
                                </button>
                                <button onClick={(e) => moveBlock(index, -1, e)} className="p-1 hover:text-foreground" disabled={index === 0}>
                                    <ArrowUp className="w-3 h-3" />
                                </button>
                                <button onClick={(e) => moveBlock(index, 1, e)} className="p-1 hover:text-foreground" disabled={index === blocks.length - 1}>
                                    <ArrowDown className="w-3 h-3" />
                                </button>
                                <button onClick={(e) => deleteBlock(block.id, e)} className="p-1 hover:text-red-500">
                                    <Trash2 className="w-3 h-3" />
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            </ScrollArea>
        </div>
    )
}
</file>

<file path="components/editor/code-pane.tsx">
"use client"

import { Code } from "lucide-react"

interface CodePaneProps {
    code: string
    onChange: (code: string) => void
    className?: string
}

export function CodePane({ code, onChange, className }: CodePaneProps) {
    return (
        <div className={`flex flex-col border-r border-border bg-card ${className || "flex-1"}`}>
            <div className="p-4 border-b border-border flex items-center justify-between">
                <h2 className="text-sm font-semibold text-foreground flex items-center gap-2">
                    <Code className="w-4 h-4" />
                    HTML Editor
                </h2>
                <span className="text-xs text-muted-foreground font-mono">index.html</span>
            </div>
            <div className="flex-1 p-0 relative">
                <textarea
                    value={code}
                    onChange={(e) => onChange(e.target.value)}
                    className="absolute inset-0 w-full h-full p-4 bg-[#1e1e1e] text-[#d4d4d4] font-mono text-sm resize-none focus:outline-none leading-relaxed"
                    spellCheck={false}
                    placeholder="Write your HTML here..."
                />
            </div>
        </div>
    )
}
</file>

<file path="repomix.config.json">
{
  "$schema": "https://repomix.com/schemas/latest/schema.json",
  "input": {
    "maxFileSize": 52428800
  },
  "output": {
    "filePath": "repomix-output.xml",
    "style": "xml",
    "parsableStyle": false,
    "fileSummary": true,
    "directoryStructure": true,
    "files": true,
    "removeComments": false,
    "removeEmptyLines": false,
    "compress": false,
    "topFilesLength": 5,
    "showLineNumbers": false,
    "truncateBase64": false,
    "copyToClipboard": false,
    "includeFullDirectoryStructure": false,
    "tokenCountTree": false,
    "git": {
      "sortByChanges": true,
      "sortByChangesMaxCommits": 100,
      "includeDiffs": false,
      "includeLogs": false,
      "includeLogsCount": 50
    }
  },
  "include": [],
  "ignore": {
    "useGitignore": true,
    "useDotIgnore": true,
    "useDefaultPatterns": true,
    "customPatterns": [
      "_legacy_v0_code/**",
      "**/*.local"
    ]
  },
  "security": {
    "enableSecurityCheck": true
  },
  "tokenCount": {
    "encoding": "o200k_base"
  }
}
</file>

<file path="components/campaign/audience-card.tsx">
import { Users, User, Mail } from "lucide-react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Campaign, Subscriber } from "@/lib/types"

export interface Audience {
    total_subscribers: number
    active_subscribers: number
}

interface AudienceCardProps {
    audience: Audience
    campaign?: Campaign
    targetSubscriber?: Subscriber | null
}

export function AudienceCard({ audience, campaign, targetSubscriber }: AudienceCardProps) {
    const lockedSubscriberId = campaign?.variable_values?.subscriber_id

    return (
        <Card className="border-border bg-card">
            <CardHeader className="pb-3">
                <CardTitle className="flex items-center gap-2 text-base font-medium text-foreground">
                    <Users className="h-5 w-5 text-[#D4AF37]" />
                    Target Audience
                </CardTitle>
            </CardHeader>
            <CardContent>
                {lockedSubscriberId ? (
                    <div className="flex items-center gap-4 bg-blue-500/10 p-4 rounded-lg border border-blue-500/20">
                        <User className="h-8 w-8 text-blue-400" />
                        <div>
                            <p className="font-bold text-lg text-blue-400">1 Subscriber</p>
                            {targetSubscriber ? (
                                <div className="text-sm text-blue-300 mt-1">
                                    <p className="font-medium">{targetSubscriber.first_name} {targetSubscriber.last_name}</p>
                                    <p className="opacity-80">{targetSubscriber.email}</p>
                                </div>
                            ) : (
                                <p className="text-sm text-muted-foreground">
                                    Exclusive send to this individual.
                                </p>
                            )}
                        </div>
                    </div>
                ) : (
                    <>
                        <div className="flex items-baseline gap-2">
                            <span className="text-4xl font-bold tracking-tight text-foreground">
                                {audience.active_subscribers.toLocaleString()}
                            </span>
                            <span className="text-muted-foreground">Active Subscribers</span>
                        </div>
                        <p className="mt-2 text-sm text-muted-foreground">All subscribers will receive this campaign when launched.</p>
                    </>
                )}
            </CardContent>
        </Card>
    )
}
</file>

<file path="components/campaign/campaign-header.tsx">
"use client"

import { useState } from "react"
import Link from "next/link"
import { ChevronRight, Pencil } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Campaign } from "@/lib/types"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
} from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { createClient } from "@/lib/supabase/client"
import { useRouter } from "next/navigation"
import { useToast } from "@/hooks/use-toast"

interface CampaignHeaderProps {
    campaign: Campaign
}

const statusConfig: Record<string, { label: string; className: string }> = {
    draft: { label: "Draft", className: "bg-zinc-700 text-zinc-300 hover:bg-zinc-700" },
    active: { label: "Scheduled", className: "bg-amber-900/50 text-amber-400 hover:bg-amber-900/50" },
    completed: { label: "Sent", className: "bg-emerald-900/50 text-emerald-400 hover:bg-emerald-900/50" },
    sent: { label: "Sent", className: "bg-emerald-900/50 text-emerald-400 hover:bg-emerald-900/50" },
}

export function CampaignHeader({ campaign }: CampaignHeaderProps) {
    // Fallback for status if not in config
    const status = statusConfig[campaign.status] || statusConfig.draft
    const [isEditSubjectOpen, setIsEditSubjectOpen] = useState(false)
    const [subjectInput, setSubjectInput] = useState(campaign.subject_line || "")
    const [saving, setSaving] = useState(false)

    const router = useRouter()
    const { toast } = useToast()
    const supabase = createClient()

    const handleSaveSubject = async () => {
        setSaving(true)
        const { error } = await supabase
            .from("campaigns")
            .update({ subject_line: subjectInput, updated_at: new Date().toISOString() })
            .eq("id", campaign.id)

        if (error) {
            toast({
                title: "Error updating subject line",
                description: error.message || "Unknown error",
                variant: "destructive",
            })
        } else {
            toast({
                title: "Subject line updated",
                description: "Your changes have been saved.",
            })
            setIsEditSubjectOpen(false)
            router.refresh()
        }
        setSaving(false)
    }

    return (
        <div className="space-y-4">
            {/* Breadcrumbs */}
            <nav className="flex items-center gap-2 text-sm text-muted-foreground">
                <Link href="/" className="transition-colors hover:text-foreground">
                    Home
                </Link>
                <ChevronRight className="h-4 w-4" />
                <Link href="/campaigns" className="text-muted-foreground hover:text-foreground transition-colors">
                    Campaigns
                </Link>
                <ChevronRight className="h-4 w-4" />
                <span className="text-foreground">{campaign.name}</span>
            </nav>

            {/* Title Row */}
            <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <div className="flex items-center gap-3">
                    <h1 className="text-2xl font-bold tracking-tight text-foreground sm:text-3xl">{campaign.name}</h1>
                    <Badge variant="secondary" className={status.className}>
                        {status.label}
                    </Badge>
                </div>

                <Button variant="outline" asChild className="w-fit gap-2 border-border hover:bg-secondary bg-transparent">
                    <Link href={`/editor?id=${campaign.id}`}>
                        <Pencil className="h-4 w-4" />
                        Edit Design
                    </Link>
                </Button>
            </div>

            {/* Subject Line Preview */}
            <div className="rounded-lg border border-border bg-card p-4 flex items-center justify-between group">
                <div>
                    <div className="flex items-center gap-2 mb-1">
                        <p className="text-xs font-medium uppercase tracking-wider text-muted-foreground">Subject Line</p>
                    </div>
                    <p className="text-foreground">{campaign.subject_line || "(No subject)"}</p>
                </div>
                <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => {
                        setSubjectInput(campaign.subject_line || "")
                        setIsEditSubjectOpen(true)
                    }}
                    className="opacity-0 group-hover:opacity-100 transition-opacity"
                >
                    <Pencil className="h-4 w-4 mr-2" />
                    Edit
                </Button>
            </div>

            {/* Edit Subject Dialog */}
            <Dialog open={isEditSubjectOpen} onOpenChange={setIsEditSubjectOpen}>
                <DialogContent className="sm:max-w-[425px]">
                    <DialogHeader>
                        <DialogTitle>Edit Subject Line</DialogTitle>
                        <DialogDescription>
                            Make changes to your email subject line here. Click save when you're done.
                        </DialogDescription>
                    </DialogHeader>
                    <div className="grid gap-4 py-4">
                        <div className="grid grid-cols-4 items-center gap-4">
                            <Label htmlFor="subject" className="text-right">
                                Subject
                            </Label>
                            <Input
                                id="subject"
                                value={subjectInput}
                                onChange={(e) => setSubjectInput(e.target.value)}
                                className="col-span-3"
                            />
                        </div>
                    </div>
                    <DialogFooter>
                        <Button variant="outline" onClick={() => setIsEditSubjectOpen(false)}>Cancel</Button>
                        <Button onClick={handleSaveSubject} disabled={saving}>
                            {saving ? "Saving..." : "Save changes"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </div>
    )
}
</file>

<file path="components/editor/preview-pane.tsx">
"use client"

import { useEffect, useRef, useState } from "react"

interface PreviewPaneProps {
    html: string
    viewMode?: 'desktop' | 'mobile'
}

export function PreviewPane({ html, viewMode = 'desktop' }: PreviewPaneProps) {
    const iframeRef = useRef<HTMLIFrameElement>(null)
    const [height, setHeight] = useState(800) // Default start height

    // Inject content and resize
    useEffect(() => {
        if (iframeRef.current) {
            const doc = iframeRef.current.contentDocument
            if (doc) {
                doc.open()
                doc.write(html)
                doc.close()

                // ⚡️ MAGIC FIX: Calculate the real height of the email content
                // We use a slight timeout to ensure images/fonts have started rendering
                setTimeout(() => {
                    if (doc.body) {
                        const newHeight = doc.body.scrollHeight + 50 // +50px buffer
                        setHeight(newHeight)
                    }
                }, 100)
            }
        }
    }, [html, viewMode])

    return (
        <div className="w-full h-full bg-white relative shadow-sm transition-all duration-300">
            <iframe
                ref={iframeRef}
                className="w-full border-0 transition-all duration-300"
                style={{ height: `${height}px` }} // ⚡️ Apply real pixel height
                title="Email Preview"
                sandbox="allow-same-origin allow-scripts"
            />
        </div>
    )
}
</file>

<file path="components/app-sidebar.tsx">
"use client"

import Link from "next/link"
import { usePathname } from "next/navigation"
import { Home, Mail, Users, PenTool, BarChart3, Settings, Music, Layers, ImageIcon } from "lucide-react"
import { cn } from "@/lib/utils"

const navItems = [
    { name: "Home", href: "/", icon: Home },
    { name: "Campaigns", href: "/campaigns", icon: Mail },
    { name: "Audience", href: "/audience", icon: Users },
    { name: "Email Builder", href: "/editor", icon: PenTool },
    { name: "Modular Builder", href: "/modular-editor", icon: Layers },
    { name: "Assets Library", href: "/assets", icon: ImageIcon },
    { name: "Analytics", href: "/analytics", icon: BarChart3 },
    { name: "Settings", href: "/settings", icon: Settings },
]

export function AppSidebar() {
    const pathname = usePathname()

    return (
        <aside className="fixed left-0 top-0 z-40 h-screen w-64 border-r border-border bg-card">
            <div className="flex h-full flex-col">
                {/* Brand */}
                <div className="flex h-16 items-center gap-3 border-b border-border px-6">
                    <div className="flex h-9 w-9 items-center justify-center rounded-lg bg-primary">
                        <Music className="h-5 w-5 text-primary-foreground" />
                    </div>
                    <span className="text-lg font-semibold text-foreground">Musical Basics</span>
                </div>

                {/* Navigation */}
                <nav className="flex-1 space-y-1 px-3 py-4">
                    {navItems.map((item) => {
                        const isActive = pathname === item.href
                        return (
                            <Link
                                key={item.name}
                                href={item.href}
                                className={cn(
                                    "flex items-center gap-3 rounded-lg px-3 py-2.5 text-sm font-medium transition-colors",
                                    isActive
                                        ? "bg-primary/10 text-primary"
                                        : "text-muted-foreground hover:bg-muted hover:text-foreground",
                                )}
                            >
                                <item.icon className="h-5 w-5" />
                                {item.name}
                            </Link>
                        )
                    })}
                </nav>

                {/* Footer */}
                <div className="border-t border-border p-4">
                    <p className="text-xs text-muted-foreground">Musical Basics Engine v1.0</p>
                </div>
            </div>
        </aside>
    )
}
</file>

<file path="app/api/webhooks/subscribe/route.ts">
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";

const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
);

// 1. Define your Safe List
const allowedOrigins = [
    "https://dreamplaypianos.com",
    "https://www.dreamplaypianos.com"
];

// 2. Helper to generate dynamic headers based on who is asking
function getCorsHeaders(request: Request) {
    const origin = request.headers.get("origin");

    // If the requester is in our safe list, let them in. 
    // Otherwise, default to the main domain (which effectively blocks them).
    const allowOrigin = (origin && allowedOrigins.includes(origin))
        ? origin
        : allowedOrigins[0];

    return {
        "Access-Control-Allow-Origin": allowOrigin,
        "Access-Control-Allow-Methods": "POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type, Authorization",
    };
}

export async function OPTIONS(request: Request) {
    return NextResponse.json({}, { headers: getCorsHeaders(request) });
}

export async function POST(request: Request) {
    try {
        const { email, first_name, last_name, tags, city, country, ip_address } = await request.json();

        if (!email) {
            return NextResponse.json(
                { error: "Email required" },
                { status: 400, headers: getCorsHeaders(request) }
            );
        }

        const finalTags = tags && Array.isArray(tags) ? tags : ["Website Import"];

        // Check for existing user to merge tags
        const { data: existingUser } = await supabase
            .from("subscribers")
            .select("tags")
            .eq("email", email)
            .single();

        let mergedTags = finalTags;
        if (existingUser?.tags) {
            mergedTags = Array.from(new Set([...existingUser.tags, ...finalTags]));
        }

        const { data, error } = await supabase
            .from("subscribers")
            .upsert({
                email,
                first_name,
                last_name,
                tags: mergedTags,
                status: "active",
                // 📍 NEW: Location Data
                location_city: city,
                location_country: country,
                ip_address: ip_address
            }, { onConflict: "email" })
            .select()
            .single();

        if (error) throw error;

        return NextResponse.json(
            { success: true, id: data.id },
            { headers: getCorsHeaders(request) }
        );

    } catch (error: any) {
        console.error("Webhook Error:", error);
        return NextResponse.json(
            { error: error.message },
            { status: 500, headers: getCorsHeaders(request) }
        );
    }
}
</file>

<file path="app/editor/page.tsx">
"use client"

import { useEffect, useState, Suspense } from "react"
import { useSearchParams, useRouter } from "next/navigation"
import { EmailEditor } from "@/components/editor/email-editor"
import { createClient } from "@/lib/supabase/client"
import { useToast } from "@/hooks/use-toast"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Button } from "@/components/ui/button"

const DEFAULT_HTML = `<div><img src="{{hero_src}}" class="w-full" /> <h1>{{headline}}</h1></div>`
const DEFAULT_ASSETS = {
    hero_src: "https://via.placeholder.com/600x200",
    headline: "Welcome to the Tournament",
}

function EditorPageContent() {
    const searchParams = useSearchParams()
    const router = useRouter()
    const { toast } = useToast()
    const supabase = createClient()
    const id = searchParams.get("id")

    const [html, setHtml] = useState(DEFAULT_HTML)
    const [assets, setAssets] = useState<Record<string, string>>(DEFAULT_ASSETS)
    const [name, setName] = useState("Untitled Campaign")
    const [status, setStatus] = useState("draft")

    // NEW: Campaign Settings
    const [subjectLine, setSubjectLine] = useState("")
    const [fromName, setFromName] = useState("Lionel Yu")
    const [fromEmail, setFromEmail] = useState("lionel@email.dreamplaypianos.com")

    const [loading, setLoading] = useState(!!id)
    const [saving, setSaving] = useState(false)

    const [saveDialogOpen, setSaveDialogOpen] = useState(false)
    const [nameInput, setNameInput] = useState("")

    useEffect(() => {
        if (!id) return

        const fetchCampaign = async () => {
            setLoading(true)
            const { data, error } = await supabase
                .from("campaigns")
                .select("*")
                .eq("id", id)
                .single()

            if (data) {
                setHtml(data.html_content || DEFAULT_HTML)
                setAssets(data.variable_values || DEFAULT_ASSETS)
                setName(data.name || "Untitled Campaign")
                setStatus(data.status || "draft")

                // Load Settings
                setSubjectLine(data.subject_line || "")
                if (data.variable_values?.from_name) setFromName(data.variable_values.from_name)
                if (data.variable_values?.from_email) setFromEmail(data.variable_values.from_email)
            }
            setLoading(false)
        }

        fetchCampaign()
    }, [id, supabase, toast])

    const executeSave = async (campaignName: string) => {
        setSaving(true)
        const campaignData = {
            name: campaignName,
            subject_line: subjectLine,
            html_content: html,
            // Save sender info to variable_values (merged with assets)
            variable_values: {
                ...assets,
                from_name: fromName,
                from_email: fromEmail
            },
            status: status,
        }

        let error
        let newId = id

        if (id) {
            const { error: updateError } = await supabase
                .from("campaigns")
                .update(campaignData)
                .eq("id", id)
            error = updateError
        } else {
            const { data, error: insertError } = await supabase
                .from("campaigns")
                .insert([campaignData])
                .select()
                .single()

            error = insertError
            if (data) newId = data.id
        }

        if (error) {
            toast({
                title: "Error saving campaign",
                description: error.message,
                variant: "destructive",
            })
        } else {
            setName(campaignName)
            toast({
                title: "Campaign saved",
                description: "Your changes have been saved successfully.",
            })
            if (!id && newId) {
                router.replace(`/editor?id=${newId}`)
            }
        }
        setSaving(false)
        setSaveDialogOpen(false)
    }

    const handleSaveClick = () => {
        if (name === "Untitled Campaign") {
            setNameInput(name)
            setSaveDialogOpen(true)
        } else {
            executeSave(name)
        }
    }

    if (loading) {
        return (
            <div className="flex h-screen items-center justify-center bg-background text-foreground">
                <p>Loading campaign...</p>
            </div>
        )
    }

    return (
        <main className="h-screen w-screen">
            <EmailEditor
                html={html}
                assets={assets}
                subjectLine={subjectLine}
                fromName={fromName}
                fromEmail={fromEmail}
                onHtmlChange={setHtml}
                onAssetsChange={setAssets}
                onSubjectChange={setSubjectLine}
                onSenderChange={(field, value) => {
                    if (field === "name") setFromName(value)
                    if (field === "email") setFromEmail(value)
                }}
                campaignName={name}
                onNameChange={setName}
                onSave={handleSaveClick}
            />

            <Dialog open={saveDialogOpen} onOpenChange={setSaveDialogOpen}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>Save Campaign</DialogTitle>
                    </DialogHeader>
                    <div className="grid gap-4 py-4">
                        <div className="grid gap-2">
                            <Label htmlFor="name">Campaign Name</Label>
                            <Input
                                id="name"
                                value={nameInput}
                                onChange={(e) => setNameInput(e.target.value)}
                                placeholder="Enter campaign name"
                            />
                        </div>
                    </div>
                    <DialogFooter>
                        <Button variant="outline" onClick={() => setSaveDialogOpen(false)}>Cancel</Button>
                        <Button onClick={() => executeSave(nameInput)} disabled={saving}>
                            {saving ? "Saving..." : "Save"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </main>
    )
}

export default function EditorPage() {
    return (
        <Suspense fallback={<div className="flex h-screen items-center justify-center">Loading...</div>}>
            <EditorPageContent />
        </Suspense>
    )
}
</file>

<file path="app/modular-editor/page.tsx">
"use client"

import { useEffect, useState, Suspense } from "react"
import { useSearchParams, useRouter } from "next/navigation"
import { ModularEmailEditor } from "@/components/editor/modular-email-editor"
import { createClient } from "@/lib/supabase/client"
import { useToast } from "@/hooks/use-toast"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Button } from "@/components/ui/button"

const DEFAULT_HTML = `<!DOCTYPE html>
<html>
<head>
    <style>body { font-family: sans-serif; }</style>
</head>
<body>
    <div style="padding: 20px; background: #f0f0f0;">
        <h1>Welcome to Modular Mode</h1>
        <p>This is a separate test environment.</p>
    </div>
</body>
</html>`

const DEFAULT_ASSETS = {}

function ModularEditorPageContent() {
    const searchParams = useSearchParams()
    const router = useRouter()
    const { toast } = useToast()
    const supabase = createClient()
    const id = searchParams.get("id")

    const [html, setHtml] = useState(DEFAULT_HTML)
    const [assets, setAssets] = useState<Record<string, string>>(DEFAULT_ASSETS)
    const [name, setName] = useState("Untitled Modular Campaign")
    const [status, setStatus] = useState("draft")

    // NEW: Campaign Settings
    const [subjectLine, setSubjectLine] = useState("")
    const [fromName, setFromName] = useState("Lionel Yu")
    const [fromEmail, setFromEmail] = useState("lionel@email.dreamplaypianos.com")

    const [loading, setLoading] = useState(!!id)
    const [saving, setSaving] = useState(false)

    const [saveDialogOpen, setSaveDialogOpen] = useState(false)
    const [nameInput, setNameInput] = useState("")

    useEffect(() => {
        if (!id) return

        const fetchCampaign = async () => {
            setLoading(true)
            const { data, error } = await supabase
                .from("campaigns")
                .select("*")
                .eq("id", id)
                .single()

            if (data) {
                setHtml(data.html_content || DEFAULT_HTML)
                setAssets(data.variable_values || DEFAULT_ASSETS)
                setName(data.name || "Untitled Modular Campaign")
                setStatus(data.status || "draft")

                // Load Settings
                setSubjectLine(data.subject_line || "")
                if (data.variable_values?.from_name) setFromName(data.variable_values.from_name)
                if (data.variable_values?.from_email) setFromEmail(data.variable_values.from_email)
            }
            setLoading(false)
        }

        fetchCampaign()
    }, [id, supabase, toast])

    const executeSave = async (campaignName: string) => {
        setSaving(true)
        const campaignData = {
            name: campaignName,
            subject_line: subjectLine, // Save to column
            html_content: html,
            // Save sender info to variable_values (merged with assets)
            variable_values: {
                ...assets,
                from_name: fromName,
                from_email: fromEmail
            },
            status: status,
        }

        let error
        let newId = id

        if (id) {
            const { error: updateError } = await supabase
                .from("campaigns")
                .update(campaignData)
                .eq("id", id)
            error = updateError
        } else {
            const { data, error: insertError } = await supabase
                .from("campaigns")
                .insert([campaignData])
                .select()
                .single()

            error = insertError
            if (data) newId = data.id
        }

        if (error) {
            toast({
                title: "Error saving campaign",
                description: error.message,
                variant: "destructive",
            })
        } else {
            setName(campaignName)
            toast({
                title: "Campaign saved",
                description: "Your changes have been saved successfully.",
            })
            if (!id && newId) {
                router.replace(`/modular-editor?id=${newId}`)
            }
        }
        setSaving(false)
        setSaveDialogOpen(false)
    }

    const handleSaveClick = () => {
        if (name === "Untitled Modular Campaign" || !id) {
            setNameInput(name)
            setSaveDialogOpen(true)
        } else {
            executeSave(name)
        }
    }

    if (loading) {
        return (
            <div className="flex h-screen items-center justify-center bg-background text-foreground">
                <p>Loading campaign...</p>
            </div>
        )
    }

    return (
        <main className="h-screen w-screen">
            <ModularEmailEditor
                html={html}
                assets={assets}
                subjectLine={subjectLine}
                fromName={fromName}
                fromEmail={fromEmail}
                onHtmlChange={setHtml}
                onAssetsChange={setAssets}
                onSubjectChange={setSubjectLine}
                onSenderChange={(field, value) => {
                    if (field === "name") setFromName(value)
                    if (field === "email") setFromEmail(value)
                }}
                campaignName={name}
                onNameChange={setName}
                onSave={handleSaveClick}
            />

            <Dialog open={saveDialogOpen} onOpenChange={setSaveDialogOpen}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>Save Modular Campaign</DialogTitle>
                    </DialogHeader>
                    <div className="grid gap-4 py-4">
                        <div className="grid gap-2">
                            <Label htmlFor="name">Campaign Name</Label>
                            <Input
                                id="name"
                                value={nameInput}
                                onChange={(e) => setNameInput(e.target.value)}
                                placeholder="Enter campaign name"
                            />
                        </div>
                    </div>
                    <DialogFooter>
                        <Button variant="outline" onClick={() => setSaveDialogOpen(false)}>Cancel</Button>
                        <Button onClick={() => executeSave(nameInput)} disabled={saving}>
                            {saving ? "Saving..." : "Save"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </main>
    )
}

export default function ModularPage() {
    return (
        <Suspense fallback={<div className="flex h-screen items-center justify-center">Loading...</div>}>
            <ModularEditorPageContent />
        </Suspense>
    )
}
</file>

<file path="components/editor/asset-picker-modal.tsx">
"use client"

import type React from "react"
import { useState, useCallback, useEffect } from "react"
import { X, Upload, ImageIcon, Loader2, Trash2 } from "lucide-react"
import { cn } from "@/lib/utils"
import { createClient } from "@/lib/supabase/client"
import { deleteAsset } from "@/app/actions/assets"

interface Asset {
    id: string
    name: string
    url: string
}

interface AssetPickerModalProps {
    isOpen: boolean
    onClose: () => void
    onSelect: (url: string) => void
}

export function AssetPickerModal({ isOpen, onClose, onSelect }: AssetPickerModalProps) {
    const [assets, setAssets] = useState<Asset[]>([])
    const [loading, setLoading] = useState(false)
    const [uploading, setUploading] = useState(false)
    const [selectedAsset, setSelectedAsset] = useState<Asset | null>(null)
    const [isDragOver, setIsDragOver] = useState(false)
    const [deleting, setDeleting] = useState<string | null>(null)
    const supabase = createClient()

    const fetchAssets = useCallback(async () => {
        setLoading(true)
        const { data, error } = await supabase.storage.from("email-assets").list()

        if (error) {
            console.error("Error fetching assets:", error)
        } else if (data) {
            const projectId = process.env.NEXT_PUBLIC_SUPABASE_URL?.split(".")[0].split("//")[1]
            const loadedAssets: Asset[] = data.map((file) => ({
                id: file.id,
                name: file.name,
                url: `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/email-assets/${encodeURIComponent(file.name)}`,
            }))
            setAssets(loadedAssets)
        }
        setLoading(false)
    }, [supabase])

    useEffect(() => {
        if (isOpen) {
            fetchAssets()
        }
    }, [isOpen, fetchAssets])

    // Helper: Compress Image using Canvas
    const compressImage = async (file: File): Promise<File> => {
        return new Promise((resolve, reject) => {
            const img = new Image()
            const reader = new FileReader()

            reader.onload = (e) => {
                img.src = e.target?.result as string
            }
            reader.onerror = reject

            img.onload = () => {
                const canvas = document.createElement("canvas")
                const ctx = canvas.getContext("2d")
                if (!ctx) return reject(new Error("Canvas context failed"))

                // Max dimensions
                const MAX_WIDTH = 1200
                const MAX_HEIGHT = 1200
                let width = img.width
                let height = img.height

                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width
                        width = MAX_WIDTH
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height
                        height = MAX_HEIGHT
                    }
                }

                canvas.width = width
                canvas.height = height
                ctx.drawImage(img, 0, 0, width, height)

                canvas.toBlob(
                    (blob) => {
                        if (!blob) return reject(new Error("Compression failed"))
                        // Create new file with same name but likely smaller size
                        const compressedFile = new File([blob], file.name, {
                            type: "image/jpeg",
                            lastModified: Date.now(),
                        })
                        resolve(compressedFile)
                    },
                    "image/jpeg",
                    0.8, // 80% Quality
                )
            }

            reader.readAsDataURL(file)
        })
    }

    const handleFileUpload = async (file: File) => {
        console.log("Starting upload...", { name: file.name, type: file.type, size: file.size })
        setUploading(true)

        try {
            // Compress if image
            let fileToUpload = file
            if (file.type.startsWith("image/")) {
                console.log("Compressing image...")
                fileToUpload = await compressImage(file)
                console.log("Compressed size:", fileToUpload.size)
            }

            const fileName = `${Date.now()}-${fileToUpload.name}`
            const { data, error } = await supabase.storage.from("email-assets").upload(fileName, fileToUpload)

            if (error) {
                console.error("Error uploading file:", error)
            } else {
                console.log("Upload successful:", data)
                await fetchAssets()
            }
        } catch (e) {
            console.error("Upload process failed:", e)
        }
        setUploading(false)
    }

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault()
        setIsDragOver(true)
    }, [])

    const handleDragLeave = useCallback((e: React.DragEvent) => {
        e.preventDefault()
        setIsDragOver(false)
    }, [])

    const handleDrop = useCallback(
        (e: React.DragEvent) => {
            e.preventDefault()
            setIsDragOver(false)
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleFileUpload(e.dataTransfer.files[0])
            }
        },
        [fetchAssets],
    )

    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            handleFileUpload(e.target.files[0])
        }
    }

    const handleSelect = () => {
        if (selectedAsset) {
            onSelect(selectedAsset.url)
            onClose()
        }
    }

    const handleDelete = async (e: React.MouseEvent, asset: Asset) => {
        e.stopPropagation() // Prevent selecting the asset
        if (!confirm(`Delete "${asset.name}"? This cannot be undone.`)) return

        setDeleting(asset.id)
        const result = await deleteAsset(asset.name)

        if (!result.success) {
            console.error("Error deleting asset:", result.error)
        } else {
            // Clear selection if deleted asset was selected
            if (selectedAsset?.id === asset.id) {
                setSelectedAsset(null)
            }
            await fetchAssets()
        }
        setDeleting(null)
    }

    if (!isOpen) return null

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
            <div className="w-full max-w-2xl mx-4 rounded-lg bg-[#111111] border border-neutral-800 shadow-2xl">
                {/* Header */}
                <div className="flex items-center justify-between px-6 py-4 border-b border-neutral-800">
                    <h3 className="text-lg font-medium text-neutral-100">Select Image Asset</h3>
                    <button
                        onClick={onClose}
                        className="p-1.5 rounded-md text-neutral-400 hover:text-neutral-100 hover:bg-neutral-800 transition-colors"
                    >
                        <X className="w-5 h-5" />
                    </button>
                </div>

                {/* Main Content */}
                <div className="p-6 space-y-6">
                    {/* Upload Zone */}
                    <div
                        onDragOver={handleDragOver}
                        onDragLeave={handleDragLeave}
                        onDrop={handleDrop}
                        onClick={() => document.getElementById("file-upload")?.click()}
                        className={cn(
                            "flex flex-col items-center justify-center gap-3 py-10 rounded-lg border-2 border-dashed transition-colors cursor-pointer relative",
                            isDragOver
                                ? "border-amber-500 bg-amber-500/5"
                                : "border-neutral-700 hover:border-amber-500 hover:bg-amber-500/5",
                        )}
                    >
                        <input
                            id="file-upload"
                            type="file"
                            accept="image/*"
                            className="hidden"
                            onChange={handleFileSelect}
                        />
                        {uploading ? (
                            <Loader2 className="w-10 h-10 text-amber-500 animate-spin" />
                        ) : (
                            <Upload className={cn("w-10 h-10", isDragOver ? "text-amber-500" : "text-neutral-500")} />
                        )}
                        <p className="text-sm text-neutral-400">
                            {uploading ? (
                                "Uploading..."
                            ) : (
                                <>
                                    Drag & drop or <span className="text-amber-500 font-medium">click to upload</span>
                                </>
                            )}
                        </p>
                    </div>

                    {/* Asset Grid */}
                    <div className="max-h-[400px] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-neutral-700 scrollbar-track-transparent">
                        {loading ? (
                            <div className="flex justify-center py-12">
                                <Loader2 className="w-8 h-8 text-neutral-500 animate-spin" />
                            </div>
                        ) : assets.length === 0 ? (
                            <div className="flex flex-col items-center justify-center py-16 text-center">
                                <ImageIcon className="w-12 h-12 text-neutral-600 mb-3" />
                                <p className="text-neutral-500">No assets found. Upload one to get started.</p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                                {assets.map((asset) => (
                                    <button
                                        key={asset.id}
                                        onClick={() => setSelectedAsset(asset)}
                                        className={cn(
                                            "group relative aspect-square rounded-md overflow-hidden bg-neutral-900 border-2 transition-all",
                                            selectedAsset?.id === asset.id
                                                ? "border-amber-500 ring-2 ring-amber-500/30"
                                                : "border-transparent hover:border-neutral-600",
                                        )}
                                    >
                                        <img
                                            src={asset.url || "/placeholder.svg"}
                                            alt={asset.name}
                                            className="w-full h-full object-cover"
                                        />
                                        <div className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/80 to-transparent px-2 py-2">
                                            <p className="text-xs text-neutral-300 truncate">{asset.name}</p>
                                        </div>
                                        {/* Delete Button */}
                                        <button
                                            onClick={(e) => handleDelete(e, asset)}
                                            disabled={deleting === asset.id}
                                            className="absolute top-2 left-2 w-6 h-6 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-50"
                                            title="Delete asset"
                                        >
                                            {deleting === asset.id ? (
                                                <Loader2 className="w-3 h-3 text-white animate-spin" />
                                            ) : (
                                                <Trash2 className="w-3 h-3 text-white" />
                                            )}
                                        </button>
                                        {selectedAsset?.id === asset.id && (
                                            <div className="absolute top-2 right-2 w-5 h-5 rounded-full bg-amber-500 flex items-center justify-center">
                                                <svg
                                                    className="w-3 h-3 text-black"
                                                    fill="none"
                                                    viewBox="0 0 24 24"
                                                    stroke="currentColor"
                                                >
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                                                </svg>
                                            </div>
                                        )}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                </div>

                {/* Footer */}
                <div className="flex items-center justify-between px-6 py-4 border-t border-neutral-800">
                    <p className="text-sm text-neutral-500">Showing {assets.length} assets</p>
                    <div className="flex items-center gap-3">
                        <button
                            onClick={onClose}
                            className="px-4 py-2 text-sm font-medium text-neutral-300 hover:text-neutral-100 hover:bg-neutral-800 rounded-md transition-colors"
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleSelect}
                            disabled={!selectedAsset}
                            className={cn(
                                "px-4 py-2 text-sm font-medium rounded-md transition-colors",
                                selectedAsset
                                    ? "bg-amber-500 text-black hover:bg-amber-400"
                                    : "bg-neutral-700 text-neutral-500 cursor-not-allowed",
                            )}
                        >
                            Select Asset
                        </button>
                    </div>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="package.json">
{
  "name": "musical-basics-engine",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "build": "next build",
    "dev": "next dev",
    "lint": "eslint .",
    "start": "next start"
  },
  "dependencies": {
    "@anthropic-ai/sdk": "^0.71.2",
    "@google/generative-ai": "^0.24.1",
    "@hookform/resolvers": "^3.10.0",
    "@radix-ui/react-accordion": "1.2.2",
    "@radix-ui/react-alert-dialog": "1.1.4",
    "@radix-ui/react-aspect-ratio": "1.1.1",
    "@radix-ui/react-avatar": "1.1.2",
    "@radix-ui/react-checkbox": "1.1.3",
    "@radix-ui/react-collapsible": "1.1.2",
    "@radix-ui/react-context-menu": "2.2.4",
    "@radix-ui/react-dialog": "1.1.4",
    "@radix-ui/react-dropdown-menu": "2.1.4",
    "@radix-ui/react-hover-card": "1.1.4",
    "@radix-ui/react-label": "2.1.1",
    "@radix-ui/react-menubar": "1.1.4",
    "@radix-ui/react-navigation-menu": "1.2.3",
    "@radix-ui/react-popover": "1.1.4",
    "@radix-ui/react-progress": "1.1.1",
    "@radix-ui/react-radio-group": "1.2.2",
    "@radix-ui/react-scroll-area": "1.2.2",
    "@radix-ui/react-select": "2.1.4",
    "@radix-ui/react-separator": "1.1.1",
    "@radix-ui/react-slider": "1.2.2",
    "@radix-ui/react-slot": "1.1.1",
    "@radix-ui/react-switch": "1.1.2",
    "@radix-ui/react-tabs": "1.1.2",
    "@radix-ui/react-toast": "1.2.4",
    "@radix-ui/react-toggle": "1.1.1",
    "@radix-ui/react-toggle-group": "1.1.1",
    "@radix-ui/react-tooltip": "1.1.6",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.87.1",
    "@vercel/analytics": "1.3.1",
    "autoprefixer": "^10.4.20",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "1.0.4",
    "date-fns": "4.1.0",
    "embla-carousel-react": "8.5.1",
    "input-otp": "1.4.1",
    "lucide-react": "^0.454.0",
    "next": "16.0.10",
    "next-themes": "^0.4.6",
    "react": "19.2.0",
    "react-day-picker": "9.8.0",
    "react-dom": "19.2.0",
    "react-hook-form": "^7.60.0",
    "react-resizable-panels": "^2.1.7",
    "recharts": "2.15.4",
    "resend": "^6.6.0",
    "sonner": "^1.7.4",
    "tailwind-merge": "^3.3.1",
    "tailwindcss-animate": "^1.0.7",
    "vaul": "^1.1.2",
    "zod": "3.25.76"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4.1.9",
    "@types/node": "^22",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "postcss": "^8.5",
    "tailwindcss": "^4.1.9",
    "tw-animate-css": "1.3.3",
    "typescript": "^5"
  }
}
</file>

<file path="components/editor/asset-loader.tsx">
"use client"

import { useState } from "react"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Button } from "@/components/ui/button"
import { Textarea } from "@/components/ui/textarea"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"
import Link from "next/link"
import { Upload, ImageIcon, ArrowLeft } from "lucide-react"
import { AssetPickerModal } from "./asset-picker-modal"

interface AssetLoaderProps {
    variables: string[]
    assets: Record<string, string>
    onUpdateAsset: (key: string, value: string) => void
    showBackButton?: boolean
}

export function AssetLoader({ variables, assets, onUpdateAsset, showBackButton = true }: AssetLoaderProps) {
    const [activeVariable, setActiveVariable] = useState<string | null>(null)

    const isImageVariable = (variable: string) => {
        const lower = variable.toLowerCase()
        if (lower.endsWith("_fit")) return false
        return lower.includes("image") || lower.includes("url") || lower.endsWith("_src")
    }

    const isTextAreaVariable = (variable: string) => {
        const lower = variable.toLowerCase()
        return lower.includes("text") || lower.includes("paragraph")
    }

    const isFitVariable = (variable: string) => {
        return variable.toLowerCase().endsWith("_fit")
    }

    const handleImageUpload = (variable: string) => {
        setActiveVariable(variable)
    }

    const handleAssetSelect = (url: string) => {
        if (activeVariable) {
            onUpdateAsset(activeVariable, url)
        }
    }

    return (
        <aside className="w-full h-full flex flex-col bg-card overflow-hidden">
            <div className="p-4 border-b border-border">
                {showBackButton && (
                    <Link href="/" className="mb-4 inline-flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors">
                        <ArrowLeft className="w-3 h-3" />
                        Back to Dashboard
                    </Link>
                )}
                <div className="flex items-center gap-2">
                    <ImageIcon className="w-4 h-4 text-primary" />
                    <h2 className="text-sm font-semibold text-foreground">
                        Asset Loader
                    </h2>
                </div>
                <p className="text-xs text-muted-foreground mt-1">Variables detected in your template</p>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-4">
                {variables.length === 0 ? (
                    <p className="text-sm text-muted-foreground">No variables found. Add {"{{variable_name}}"} to your code.</p>
                ) : (
                    variables.map((variable) => (
                        <div key={variable} className="space-y-2">
                            <Label htmlFor={variable} className="text-xs font-mono text-muted-foreground">
                                {`{{${variable}}}`}
                            </Label>
                            {isTextAreaVariable(variable) ? (
                                <Textarea
                                    id={variable}
                                    value={assets[variable] || ""}
                                    onChange={(e) => onUpdateAsset(variable, e.target.value)}
                                    placeholder={`Enter ${variable}`}
                                    className="text-sm bg-muted border-border font-mono min-h-[100px] resize-y"
                                    rows={4}
                                />
                            ) : isFitVariable(variable) ? (
                                <Select
                                    value={assets[variable] || "cover"}
                                    onValueChange={(value) => onUpdateAsset(variable, value)}
                                >
                                    <SelectTrigger className="w-full">
                                        <SelectValue placeholder="Select fit" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        <SelectItem value="cover">Cover</SelectItem>
                                        <SelectItem value="contain">Contain</SelectItem>
                                        <SelectItem value="fill">Fill</SelectItem>
                                        <SelectItem value="scale-down">Scale Down</SelectItem>
                                    </SelectContent>
                                </Select>
                            ) : (
                                <div className="flex gap-2">
                                    <Input
                                        id={variable}
                                        value={assets[variable] || ""}
                                        onChange={(e) => onUpdateAsset(variable, e.target.value)}
                                        placeholder={`Enter ${variable}`}
                                        className="flex-1 text-sm bg-muted border-border font-mono"
                                    />
                                    {isImageVariable(variable) && (
                                        <Button
                                            variant="outline"
                                            size="icon"
                                            onClick={() => handleImageUpload(variable)}
                                            title="Upload/Select Image"
                                            className="flex-shrink-0"
                                        >
                                            <Upload className="w-4 h-4" />
                                        </Button>
                                    )}
                                </div>
                            )}
                            {isImageVariable(variable) && assets[variable] && (
                                <div className="mt-2 rounded border border-border overflow-hidden">
                                    <img
                                        src={assets[variable] || "/placeholder.svg"}
                                        alt={variable}
                                        className="w-full h-20 object-fit-cover bg-muted"
                                        style={{ objectFit: (assets[`${variable}_fit`] as any) || "cover" }}
                                        onError={(e) => {
                                            e.currentTarget.style.display = "none"
                                        }}
                                    />
                                </div>
                            )}
                        </div>
                    ))
                )}
            </div>

            <AssetPickerModal
                isOpen={!!activeVariable}
                onClose={() => setActiveVariable(null)}
                onSelect={handleAssetSelect}
            />
        </aside>
    )
}
</file>

<file path="components/campaign/campaign-launch-checks.tsx">
"use client"

import { useState } from "react"
import { CampaignHeader } from "./campaign-header"
import { AudienceCard, Audience } from "./audience-card"
import { SenderIdentityCard } from "./sender-identity-card"
import { PreflightCheckCard } from "./preflight-check-card"
import { SendTestCard } from "./send-test-card"
import { LaunchpadCard } from "./launchpad-card"
import { EmailPreviewCard } from "./email-preview-card"
import { AnalyticsSection } from "./analytics-section"
import { BroadcastConfirmDialog } from "./broadcast-confirm-dialog"
import { Music, AlertCircle, CheckCircle2 } from "lucide-react"
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"
import { Campaign } from "@/lib/types"
import { useToast } from "@/hooks/use-toast"
import { useRouter } from "next/navigation"

import { Subscriber } from "@/lib/types"

interface CampaignLaunchChecksProps {
    campaign: Campaign
    audience: Audience
    targetSubscriber?: Subscriber | null
}

export function CampaignLaunchChecks({ campaign, audience, targetSubscriber }: CampaignLaunchChecksProps) {
    const [showConfirmDialog, setShowConfirmDialog] = useState(false)
    const [previewMode, setPreviewMode] = useState<"desktop" | "mobile">("desktop")
    // Default values since they are not in DB schema yet
    const [fromName, setFromName] = useState(campaign.variable_values?.from_name || "Lionel Yu")
    const [fromEmail, setFromEmail] = useState(campaign.variable_values?.from_email || "lionel@email.dreamplaypianos.com")
    const [broadcastStatus, setBroadcastStatus] = useState<"idle" | "success" | "error">("idle")
    const [broadcastMessage, setBroadcastMessage] = useState("")

    const { toast } = useToast()
    const router = useRouter()

    const handleLaunchClick = () => {
        setShowConfirmDialog(true)
    }

    const handleSendTest = async (email: string) => {
        const response = await fetch("/api/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                type: "test",
                email,
                campaignId: campaign.id,
                fromName,
                fromEmail
            })
        })

        const data = await response.json()

        if (!response.ok) {
            toast({
                title: "Error sending test email",
                description: data.error,
                variant: "destructive"
            })
            throw new Error(data.error)
        } else {
            toast({
                title: "Test email sent",
                description: `Sent to ${email}`
            })
        }
    }

    const handleConfirmBroadcast = async () => {
        setShowConfirmDialog(false)
        setBroadcastStatus("idle")
        setBroadcastMessage("")

        // Optimistic UI update or loading state could be added here
        toast({ title: "Initiating broadcast...", description: "This may take a moment." })

        const response = await fetch("/api/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                type: "broadcast",
                campaignId: campaign.id,
                fromName,
                fromEmail
            })
        })

        const data = await response.json()

        if (!response.ok) {
            setBroadcastStatus("error")
            setBroadcastMessage(data.message || data.error || "Broadcast failed")

            toast({
                title: "Error sending broadcast",
                description: data.message || data.error,
                variant: "destructive"
            })
        } else {
            setBroadcastStatus("success")
            setBroadcastMessage(data.message)

            toast({
                title: "Campaign Sent!",
                description: data.message
            })
            router.refresh()
        }
    }

    return (
        <div className="min-h-screen bg-background">
            <div className="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
                {/* Header */}
                <CampaignHeader campaign={campaign} />



                <div className="mt-6 grid gap-6 lg:grid-cols-5">
                    {/* Left Column - Controls */}
                    <div className="flex flex-col gap-6 lg:col-span-2">
                        <AudienceCard audience={audience} campaign={campaign} targetSubscriber={targetSubscriber} />
                        <SenderIdentityCard
                            fromName={fromName}
                            fromEmail={fromEmail}
                            onFromNameChange={setFromName}
                            onFromEmailChange={setFromEmail}
                            readOnly={campaign.status === "completed"}
                        />
                        <SendTestCard onSendTest={handleSendTest} />
                        <LaunchpadCard
                            subscriberCount={audience.active_subscribers}
                            onLaunch={handleLaunchClick}
                            isDisabled={campaign.status === "completed"}
                        />

                        {broadcastStatus === "error" && (
                            <Alert variant="destructive" className="animate-in fade-in slide-in-from-top-2">
                                <AlertCircle className="h-4 w-4" />
                                <AlertTitle>Broadcast Failed</AlertTitle>
                                <AlertDescription>
                                    {broadcastMessage}
                                </AlertDescription>
                            </Alert>
                        )}

                        {broadcastStatus === "success" && (
                            <Alert className="border-green-500/50 bg-green-500/10 text-green-600 animate-in fade-in slide-in-from-top-2">
                                <CheckCircle2 className="h-4 w-4 text-green-600" />
                                <AlertTitle>Success</AlertTitle>
                                <AlertDescription>
                                    {broadcastMessage}
                                </AlertDescription>
                            </Alert>
                        )}

                        <PreflightCheckCard
                            subjectLine={campaign.subject_line}
                            htmlContent={campaign.html_content}
                            variableValues={campaign.variable_values}
                        />
                    </div>

                    {/* Right Column - Preview */}
                    <div className="lg:col-span-3">
                        <EmailPreviewCard campaign={campaign} previewMode={previewMode} onPreviewModeChange={setPreviewMode} />
                    </div>
                </div>

                {/* Analytics Section */}
                <div className="mt-8">
                    <AnalyticsSection status={campaign.status} />
                </div>
            </div>

            {/* Confirmation Dialog */}
            <BroadcastConfirmDialog
                open={showConfirmDialog}
                onOpenChange={setShowConfirmDialog}
                subscriberCount={audience.active_subscribers}
                campaignName={campaign.name}
                subjectLine={campaign.subject_line}
                onConfirm={handleConfirmBroadcast}
            />
        </div>
    )
}
</file>

<file path="components/campaigns-table.tsx">
"use client"

import { useState } from "react"
import Link from "next/link"
import { Button } from "@/components/ui/button"
import { Badge } from "@/components/ui/badge"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Campaign } from "@/lib/types"
import { formatDistanceToNow } from "date-fns"
import { Pencil, Copy, ChevronDown, LayoutTemplate, PenLine, Trash2, Eye, MousePointer2, Clock, MoreHorizontal, ArrowRight } from "lucide-react"
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { createClient } from "@/lib/supabase/client"
import { duplicateCampaign, deleteCampaign } from "@/app/actions/campaigns"
import { useToast } from "@/hooks/use-toast"
import { useRouter } from "next/navigation"

const statusStyles: Record<string, string> = {
    active: "bg-green-500/20 text-green-400 border-green-500/30",
    completed: "bg-blue-500/20 text-blue-400 border-blue-500/30",
    draft: "bg-muted text-muted-foreground border-border",
}

const formatDuration = (seconds: number) => {
    if (!seconds) return "—"
    if (seconds < 60) return `${seconds}s`
    const m = Math.floor(seconds / 60)
    const s = seconds % 60
    return `${m}m ${s}s`
}

interface CampaignsTableProps {
    campaigns: Campaign[]
    loading: boolean
    onRefresh?: () => void
    title?: string
}

export function CampaignsTable({ campaigns = [], loading, onRefresh, title = "Recent Campaigns" }: CampaignsTableProps) {
    const [editingCampaign, setEditingCampaign] = useState<Campaign | null>(null)
    const [deletingId, setDeletingId] = useState<string | null>(null)
    const [newName, setNewName] = useState("")
    const [renaming, setRenaming] = useState(false)
    const [duplicatingId, setDuplicatingId] = useState<string | null>(null)

    const supabase = createClient()
    const { toast } = useToast()
    const router = useRouter()

    const handleEditClick = (campaign: Campaign) => {
        setEditingCampaign(campaign)
        setNewName(campaign.name)
    }

    const handleRename = async () => {
        if (!editingCampaign) return
        setRenaming(true)

        const { error } = await supabase
            .from("campaigns")
            .update({ name: newName })
            .eq("id", editingCampaign.id)

        if (!error) {
            setEditingCampaign(null)
            if (onRefresh) onRefresh()
            router.refresh()
        } else {
            console.error("Error renaming campaign:", error)
            toast({
                title: "Error renaming campaign",
                description: error.message,
                variant: "destructive",
            })
        }
        setRenaming(false)
    }

    const handleDuplicate = async (campaignId: string) => {
        setDuplicatingId(campaignId)
        try {
            const result = await duplicateCampaign(campaignId)

            if (result.error) {
                throw new Error(result.error)
            }

            toast({
                title: "Campaign duplicated",
                description: "A copy of the campaign has been created.",
            })

            if (onRefresh) onRefresh()
            router.refresh() // Refresh server components

        } catch (error: any) {
            console.error("Error duplicating campaign:", error)
            toast({
                title: "Error duplicating campaign",
                description: error.message || "Failed to duplicate",
                variant: "destructive",
            })
        } finally {
            setDuplicatingId(null)
        }
    }
    const handleDelete = async (campaignId: string) => {
        setDeletingId(campaignId)
        try {
            const result = await deleteCampaign(campaignId)

            if (result.error) {
                throw new Error(result.error)
            }

            toast({
                title: "Campaign deleted",
                description: "The campaign has been permanently removed.",
            })

            if (onRefresh) onRefresh()
            router.refresh()

        } catch (error: any) {
            console.error("Error deleting campaign:", error)
            toast({
                title: "Error deleting campaign",
                description: error.message || "Failed to delete",
                variant: "destructive",
            })
        } finally {
            setDeletingId(null)
        }
    }

    if (loading) {
        return <div className="text-center py-10 text-muted-foreground opacity-50">Loading metrics...</div>
    }

    return (
        <div className="rounded-lg border border-border bg-card">
            <div className="border-b border-border px-6 py-4 flex justify-between items-center">
                <h2 className="text-lg font-semibold text-card-foreground">{title}</h2>
            </div>
            <Table>
                <TableHeader>
                    <TableRow className="border-border hover:bg-transparent">
                        <TableHead className="text-muted-foreground w-[300px]">Campaign</TableHead>
                        <TableHead className="text-center w-[100px]">Status</TableHead>
                        {/* New Metrics Columns */}
                        <TableHead className="text-right">
                            <div className="flex items-center justify-end gap-1">
                                <Eye className="h-3.5 w-3.5 text-muted-foreground" />
                                Open Rate
                            </div>
                        </TableHead>
                        <TableHead className="text-right">
                            <div className="flex items-center justify-end gap-1">
                                <MousePointer2 className="h-3.5 w-3.5 text-muted-foreground" />
                                Click Rate
                            </div>
                        </TableHead>
                        <TableHead className="text-right">
                            <div className="flex items-center justify-end gap-1">
                                <Clock className="h-3.5 w-3.5 text-muted-foreground" />
                                Avg Time
                            </div>
                        </TableHead>
                        <TableHead className="text-right w-[50px]"></TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {campaigns.length === 0 ? (
                        <TableRow>
                            <TableCell colSpan={6} className="text-center py-8 text-muted-foreground">
                                No campaigns found. Create one to get started.
                            </TableCell>
                        </TableRow>
                    ) : (
                        campaigns.map((campaign) => {
                            const recipients = campaign.total_recipients || 0
                            const openRate = recipients > 0 ? Math.round((campaign.total_opens / recipients) * 100) : 0
                            const clickRate = recipients > 0 ? Math.round((campaign.total_clicks / recipients) * 100) : 0

                            return (
                                <TableRow key={campaign.id} className="border-border">
                                    {/* Name & Metadata */}
                                    <TableCell>
                                        <div className="flex flex-col group">
                                            <div className="flex items-center gap-2">
                                                <Link href={`/dashboard/${campaign.id}`} className="font-medium text-foreground hover:underline">
                                                    {campaign.name || "Untitled Campaign"}
                                                </Link>
                                                <button
                                                    onClick={(e) => {
                                                        e.preventDefault()
                                                        handleEditClick(campaign)
                                                    }}
                                                    className="opacity-0 group-hover:opacity-100 transition-opacity text-muted-foreground hover:text-foreground"
                                                    title="Rename"
                                                >
                                                    <Pencil className="w-3.5 h-3.5" />
                                                </button>
                                            </div>
                                            <span className="text-xs text-muted-foreground">
                                                Created {formatDistanceToNow(new Date(campaign.created_at), { addSuffix: true })}
                                            </span>
                                        </div>
                                    </TableCell>
                                    <TableCell className="text-center">
                                        <Badge variant="outline" className={`
                                            capitalize border-opacity-50
                                            ${campaign.status === 'completed' ? 'text-emerald-400 border-emerald-500/50 bg-emerald-500/10' : ''}
                                            ${campaign.status === 'draft' ? 'text-zinc-400 border-zinc-500/50 bg-zinc-500/10' : ''}
                                        `}>
                                            {campaign.status}
                                        </Badge>
                                    </TableCell>

                                    {/* METRICS */}
                                    <TableCell className="text-right font-mono">
                                        {recipients > 0 ? (
                                            <span className={openRate > 20 ? "text-emerald-400 font-bold" : "text-muted-foreground"}>
                                                {openRate}%
                                            </span>
                                        ) : "—"}
                                    </TableCell>

                                    <TableCell className="text-right font-mono">
                                        {recipients > 0 ? (
                                            <span className={clickRate > 2 ? "text-blue-400 font-bold" : "text-muted-foreground"}>
                                                {clickRate}%
                                            </span>
                                        ) : "—"}
                                    </TableCell>

                                    <TableCell className="text-right font-mono text-amber-400">
                                        {formatDuration(campaign.average_read_time)}
                                    </TableCell>

                                    {/* Actions */}
                                    <TableCell className="text-right">
                                        <div className="flex items-center justify-end gap-2">
                                            <Button
                                                variant="ghost"
                                                size="sm"
                                                onClick={() => handleDuplicate(campaign.id)}
                                                disabled={duplicatingId === campaign.id}
                                                className="text-muted-foreground hover:text-foreground hover:bg-secondary/50 hidden md:flex"
                                                title="Duplicate"
                                            >
                                                <Copy className="w-4 h-4" />
                                            </Button>

                                            <DropdownMenu>
                                                <DropdownMenuTrigger asChild>
                                                    <Button variant="ghost" size="icon" className="h-8 w-8">
                                                        <MoreHorizontal className="h-4 w-4" />
                                                    </Button>
                                                </DropdownMenuTrigger>
                                                <DropdownMenuContent align="end">
                                                    <DropdownMenuItem asChild>
                                                        <Link href={`/dashboard/${campaign.id}`} className="flex items-center gap-2">
                                                            <ArrowRight className="h-3 w-3" />
                                                            <span>Manage</span>
                                                        </Link>
                                                    </DropdownMenuItem>
                                                    <DropdownMenuItem asChild>
                                                        <Link href={`/editor?id=${campaign.id}`} className="flex items-center gap-2">
                                                            <PenLine className="h-3 w-3 text-muted-foreground" />
                                                            <span>Classic Editor</span>
                                                        </Link>
                                                    </DropdownMenuItem>
                                                    <DropdownMenuItem asChild>
                                                        <Link href={`/modular-editor?id=${campaign.id}`} className="flex items-center gap-2">
                                                            <LayoutTemplate className="h-3 w-3 text-muted-foreground" />
                                                            <span>Modular Editor</span>
                                                        </Link>
                                                    </DropdownMenuItem>
                                                    <DropdownMenuItem
                                                        onClick={() => handleDelete(campaign.id)}
                                                        disabled={deletingId === campaign.id}
                                                        className="text-red-500 focus:text-red-600 focus:bg-red-500/10 cursor-pointer"
                                                    >
                                                        <Trash2 className="h-3 w-3 mr-2" />
                                                        <span>Delete</span>
                                                    </DropdownMenuItem>
                                                </DropdownMenuContent>
                                            </DropdownMenu>
                                        </div>
                                    </TableCell>
                                </TableRow>
                            )
                        })
                    )}
                </TableBody>
            </Table>

            <Dialog open={!!editingCampaign} onOpenChange={(open) => !open && setEditingCampaign(null)}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>Rename Campaign</DialogTitle>
                    </DialogHeader>
                    <div className="grid gap-4 py-4">
                        <div className="grid gap-2">
                            <Label htmlFor="name">Campaign Name</Label>
                            <Input
                                id="name"
                                value={newName}
                                onChange={(e) => setNewName(e.target.value)}
                                placeholder="Enter campaign name"
                            />
                        </div>
                    </div>
                    <DialogFooter>
                        <Button variant="outline" onClick={() => setEditingCampaign(null)}>Cancel</Button>
                        <Button onClick={handleRename} disabled={renaming}>
                            {renaming ? "Saving..." : "Save"}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </div>
    )
}
</file>

<file path="lib/types.ts">
export type CampaignStatus = 'draft' | 'active' | 'completed'

export interface Campaign {
    id: string
    created_at: string
    updated_at: string
    name: string
    subject_line: string | null
    html_content: string | null
    variable_values: Record<string, any> | null
    status: CampaignStatus

    // Analytics
    total_recipients: number
    total_opens: number
    total_clicks: number
    average_read_time: number
}

export interface Subscriber {
    id: string
    email: string
    first_name: string
    last_name: string
    tags: string[] | null
    status: 'active' | 'unsubscribed' | 'bounced'
    created_at: string
}
</file>

<file path="components/editor/modular-email-editor.tsx">
"use client"

import { useState, useMemo, useCallback, useEffect } from "react"
import { AssetLoader } from "./asset-loader"
import { HistorySheet } from "./history-sheet"
import { CampaignPicker } from "./campaign-picker"
import { CodePane } from "./code-pane"
import { PreviewPane } from "./preview-pane"
import { CopilotPane } from "./copilot-pane"
import { BlockManager, Block } from "./block-manager"
import { renderTemplate } from "@/lib/render-template"
import { Monitor, Smartphone, Loader2, Check, ArrowLeft, Undo, Redo } from "lucide-react"
import { saveVersion } from "@/app/actions/versions"
import { useSearchParams } from "next/navigation"
import { cn } from "@/lib/utils"
import Link from "next/link"

interface ModularEmailEditorProps {
    html: string
    assets: Record<string, string>
    subjectLine: string
    fromName: string
    fromEmail: string
    onHtmlChange: (html: string) => void
    onAssetsChange: (assets: Record<string, string>) => void
    onSubjectChange: (value: string) => void
    onSenderChange: (field: "name" | "email", value: string) => void
    campaignName: string
    onNameChange: (name: string) => void
    onSave?: () => void
}

// --- HELPER: SMART SPLITTER ---
// This function tears apart a monolithic HTML file into logical blocks
const parseMonolithToBlocks = (fullHtml: string): Block[] => {
    const blocks: Block[] = []

    // 1. Extract HEAD (Global Styles)
    const headMatch = fullHtml.match(/(^[\s\S]*?<body[^>]*>)/i)
    const headContent = headMatch ? headMatch[1] : ""
    blocks.push({ id: "head", name: "Global Styles & Head", content: headContent })

    // 2. Extract FOOTER (Closing tags)
    const closeMatch = fullHtml.match(/(<\/body>[\s\S]*$)/i)
    const closeContent = closeMatch ? closeMatch[1] : ""

    // 3. Extract BODY CONTENT
    let bodyContent = fullHtml
    if (headContent) bodyContent = bodyContent.replace(headContent, "")
    if (closeContent) bodyContent = bodyContent.replace(closeContent, "")
    bodyContent = bodyContent.trim()

    // 4. MAGIC: Split Body into Logical Sections
    // We look for top-level HTML tags that look like containers.
    // Regex explanation: Find a tag that starts with <div, <table, <section and capture everything until it closes.
    // Note: Regex parsing HTML is fragile, but sufficient for top-level block splitting in emails.

    // Strategy: We split by "<!-- BLOCK: Name -->" comments if they exist.
    // If NOT, we try to split by standard container tags.

    const commentSplit = bodyContent.split(/<!-- BLOCK: (.*?) -->/i)

    if (commentSplit.length > 1) {
        // Option A: The user already has "BLOCK:" comments. Use them!
        // The split array looks like: [pre-text, "Block Name 1", "Content 1", "Block Name 2", "Content 2"...]
        for (let i = 1; i < commentSplit.length; i += 2) {
            const name = commentSplit[i].trim()
            const content = commentSplit[i + 1]?.trim() || ""
            blocks.push({ id: `block-${i}`, name: name, content: content })
        }
    } else {
        // Option B: The "Wild West". We assume every top-level <table> or <div> is a block.
        // We wrap them in comments so they persist next time.

        // This regex looks for high-level containers
        const tagRegex = /(<(table|div|section)[^>]*>[\s\S]*?<\/\2>)/gi
        let match
        let lastIndex = 0
        let count = 1

        while ((match = tagRegex.exec(bodyContent)) !== null) {
            // content BEFORE the tag (usually whitespace or stray text)
            const gap = bodyContent.slice(lastIndex, match.index).trim()
            if (gap) {
                blocks.push({ id: `gap-${count}`, name: `Text Section ${count}`, content: gap })
            }

            // The TAG itself
            const tagContent = match[0]
            // Try to guess a name based on content
            let name = `Section ${count}`
            if (tagContent.includes("img")) name = `Image Block ${count}`
            if (tagContent.includes("<h")) name = `Text/Header Block ${count}`
            if (tagContent.includes("button") || tagContent.includes("<a ")) name = `CTA Block ${count}`
            if (tagContent.includes("social")) name = "Social Links"

            blocks.push({ id: `auto-${count}`, name: name, content: tagContent })

            lastIndex = tagRegex.lastIndex
            count++
        }

        // Catch any trailing content
        const tail = bodyContent.slice(lastIndex).trim()
        if (tail) blocks.push({ id: "tail", name: "Footer Content", content: tail })
    }

    // 5. Add Footer
    blocks.push({ id: "footer", name: "Closing Tags", content: closeContent })

    return blocks
}


export function ModularEmailEditor({
    html: initialHtml,
    assets,
    subjectLine,
    fromName,
    fromEmail,
    onHtmlChange,
    onAssetsChange,
    onSubjectChange,
    onSenderChange,
    campaignName,
    onNameChange,
    onSave
}: ModularEmailEditorProps) {
    const [viewMode, setViewMode] = useState<'desktop' | 'mobile'>('desktop')
    const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'success'>('idle')

    // INITIALIZE BLOCKS using the new Smart Parser
    const [blocks, setBlocks] = useState<Block[]>(() => parseMonolithToBlocks(initialHtml))

    const [activeBlockId, setActiveBlockId] = useState<string>(blocks[1]?.id || blocks[0].id)

    // HISTORY & VERSIONING
    const searchParams = useSearchParams()
    const campaignId = searchParams.get("id")
    const [history, setHistory] = useState<string[]>([])
    const [historyIndex, setHistoryIndex] = useState(-1)

    // Init history with initial state
    useEffect(() => {
        if (history.length === 0 && initialHtml) {
            setHistory([initialHtml])
            setHistoryIndex(0)
        }
    }, [])

    // Reconstruct full HTML from blocks + Enforce Block Comments
    const fullHtml = useMemo(() => {
        return blocks.map(b => {
            // Don't wrap head/footer in comments to keep file clean
            if (b.id === 'head' || b.id === 'footer') return b.content

            // Wrap others in "Markers" so the parser finds them next time
            return `<!-- BLOCK: ${b.name} -->\n${b.content}`
        }).join('\n\n')
    }, [blocks])

    // Sync to parent
    useEffect(() => {
        onHtmlChange(fullHtml)
    }, [fullHtml, onHtmlChange])

    const activeBlock = useMemo(() => blocks.find(b => b.id === activeBlockId) || blocks[0], [blocks, activeBlockId])

    const handleBlockContentChange = (newContent: string) => {
        setBlocks(prev => prev.map(b => b.id === activeBlockId ? { ...b, content: newContent } : b))
    }

    const addNewBlock = () => {
        const newBlock: Block = {
            id: `block-${Date.now()}`,
            name: "New Section",
            content: "<div style='padding: 20px;'>New Content</div>"
        }
        const index = blocks.findIndex(b => b.id === activeBlockId)
        const newBlocks = [...blocks]
        newBlocks.splice(index + 1, 0, newBlock)
        setBlocks(newBlocks)
        setActiveBlockId(newBlock.id)
    }

    // --- STANDARD UTILS ---
    const extractedVariables = useMemo(() => {
        const regex = /\{\{(\w+)\}\}/g
        const matches: string[] = []
        let match
        while ((match = regex.exec(fullHtml)) !== null) {
            if (!matches.includes(match[1])) matches.push(match[1])
        }
        return matches
    }, [fullHtml])

    const updateAsset = useCallback((key: string, value: string) => {
        onAssetsChange({ ...assets, [key]: value })
    }, [assets, onAssetsChange])

    const previewHtml = useMemo(() => renderTemplate(fullHtml, assets), [fullHtml, assets])

    const handleSaveClick = async () => {
        if (!onSave) return
        setSaveStatus('saving')
        await Promise.resolve(onSave())
        setSaveStatus('success')
        setTimeout(() => setSaveStatus('idle'), 2000)
    }

    const handleCopilotUpdate = async (newHtml: string, prompt: string) => {
        // A. Save Version (Fire & Forget)
        if (campaignId) {
            saveVersion(campaignId, newHtml, prompt).catch(console.error)
        }

        // B. Update History
        const newHistory = history.slice(0, historyIndex + 1)
        newHistory.push(newHtml)
        setHistory(newHistory)
        setHistoryIndex(newHistory.length - 1)

        // C. Apply Logic
        if (newHtml.includes("<body") || newHtml.includes("<!DOCTYPE") || newHtml.includes("Global Styles")) {
            const newBlocks = parseMonolithToBlocks(newHtml)
            setBlocks(newBlocks)
            // Try to keep the active block if it still exists, otherwise default
            if (!newBlocks.some(b => b.id === activeBlockId)) {
                setActiveBlockId(newBlocks[1]?.id || newBlocks[0].id)
            }
        } else {
            handleBlockContentChange(newHtml)
        }
    }

    const handleUndo = () => {
        if (historyIndex > 0) {
            const prevHtml = history[historyIndex - 1]
            setHistoryIndex(historyIndex - 1)
            setBlocks(parseMonolithToBlocks(prevHtml))
        }
    }

    const handleRedo = () => {
        if (historyIndex < history.length - 1) {
            const nextHtml = history[historyIndex + 1]
            setHistoryIndex(historyIndex + 1)
            setBlocks(parseMonolithToBlocks(nextHtml))
        }
    }

    return (
        <div className="flex h-screen bg-background text-foreground overflow-hidden">
            {/* 1. UNIFIED SIDEBAR (Assets + Blocks) */}
            <div className="flex-shrink-0 w-[300px] border-r border-border h-full flex flex-col bg-card">
                {/* Header Link */}
                <div className="p-3 border-b border-border">
                    <Link href="/" className="inline-flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors">
                        <ArrowLeft className="w-3 h-3" />
                        Back to Dashboard
                    </Link>
                </div>

                <div className="p-4 border-b border-border bg-muted/20 space-y-4">
                    {/* Campaign Settings */}
                    <div className="space-y-3">
                        <div className="space-y-1">
                            <label className="text-[10px] uppercase font-semibold text-muted-foreground">Subject Line</label>
                            <input
                                type="text"
                                value={subjectLine}
                                onChange={(e) => onSubjectChange(e.target.value)}
                                className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                                placeholder="Enter subject line..."
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-semibold text-muted-foreground">From Name</label>
                                <input
                                    type="text"
                                    value={fromName}
                                    onChange={(e) => onSenderChange("name", e.target.value)}
                                    className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                                    placeholder="Lionel Yu"
                                />
                            </div>
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-semibold text-muted-foreground">From Email</label>
                                <input
                                    type="text"
                                    value={fromEmail}
                                    onChange={(e) => onSenderChange("email", e.target.value)}
                                    className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                                    placeholder="lionel@..."
                                />
                            </div>
                        </div>
                    </div>
                </div>
                {/* Top Half: Blocks */}
                <div className="flex-1 overflow-hidden border-b border-border">
                    <BlockManager
                        blocks={blocks}
                        activeBlockId={activeBlockId}
                        onSelectBlock={setActiveBlockId}
                        onUpdateBlocks={setBlocks}
                        onAddBlock={addNewBlock}
                    />
                </div>

                {/* Bottom Half: Assets */}
                <div className="h-[50%] overflow-hidden">
                    <AssetLoader variables={extractedVariables} assets={assets} onUpdateAsset={updateAsset} showBackButton={false} />
                </div>
            </div>

            {/* 2. CODE PANE (Edits Active Block Only) */}
            <div className="flex-[3] min-w-[350px] border-r border-border h-full flex flex-col">
                <div className="h-10 border-b border-border bg-muted/30 px-4 flex items-center justify-between text-xs">
                    <span className="text-muted-foreground">Editing: <span className="font-bold text-foreground">{activeBlock.name}</span></span>
                </div>
                <CodePane code={activeBlock.content} onChange={handleBlockContentChange} className="flex-1" />
            </div>

            {/* 3. PREVIEW PANE */}
            <div className="flex-[4] flex flex-col min-w-[500px] h-full overflow-hidden">
                <div className="h-14 border-b border-border flex items-center justify-between px-4 bg-card flex-shrink-0">
                    <h2 className="text-sm font-semibold">Preview</h2>

                    <div className="flex items-center gap-2">
                        {/* History */}
                        <HistorySheet
                            campaignId={campaignId}
                            onRestore={(html) => handleCopilotUpdate(html, "Restored from History")}
                        />

                        {/* Campaign Name Editing */}
                        <div className="flex items-center gap-2 border-l border-border pl-2 mr-2">
                            <input
                                type="text"
                                value={campaignName}
                                onChange={(e) => onNameChange(e.target.value)}
                                className="bg-transparent border-none text-sm font-medium focus:outline-none focus:ring-1 focus:ring-primary/30 rounded px-2 w-[180px] text-foreground placeholder:text-muted-foreground"
                                placeholder="Campaign Name"
                            />
                        </div>

                        {/* Open Campaign */}
                        <CampaignPicker currentId={campaignId} editorType="modular" />

                        {/* Undo/Redo */}
                        <div className="flex bg-muted p-1 rounded-lg">
                            <button
                                onClick={handleUndo}
                                disabled={historyIndex <= 0}
                                className="p-1.5 rounded-md hover:bg-background disabled:opacity-30 transition-colors"
                                title="Undo"
                            >
                                <Undo className="w-4 h-4" />
                            </button>
                            <button
                                onClick={handleRedo}
                                disabled={historyIndex >= history.length - 1}
                                className="p-1.5 rounded-md hover:bg-background disabled:opacity-30 transition-colors"
                                title="Redo"
                            >
                                <Redo className="w-4 h-4" />
                            </button>
                        </div>

                        <div className="flex bg-muted p-1 rounded-lg">
                            <button onClick={() => setViewMode('desktop')} className={cn("p-1.5 rounded-md", viewMode === 'desktop' && "bg-background shadow-sm")}><Monitor className="w-4 h-4" /></button>
                            <button onClick={() => setViewMode('mobile')} className={cn("p-1.5 rounded-md", viewMode === 'mobile' && "bg-background shadow-sm")}><Smartphone className="w-4 h-4" /></button>
                        </div>
                    </div>

                    {onSave && (
                        <button type="button" onClick={handleSaveClick} disabled={saveStatus === 'saving'} className={cn("px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2", saveStatus === 'success' ? "bg-green-600 text-white" : "bg-primary text-primary-foreground")}>
                            {saveStatus === 'saving' && <Loader2 className="w-4 h-4 animate-spin" />}
                            {saveStatus === 'success' && <Check className="w-4 h-4" />}
                            {saveStatus === 'idle' && "Save"}
                        </button>
                    )}
                </div>
                <div className="flex-1 overflow-y-auto bg-[#0f0f10] p-8">
                    <div className="h-fit min-h-[500px] mx-auto transition-all duration-300 bg-white shadow-lg my-8" style={{ maxWidth: viewMode === 'mobile' ? '375px' : '600px' }}>
                        <PreviewPane html={previewHtml} viewMode={viewMode} />
                    </div>
                </div>
            </div>

            {/* 5. COPILOT (Context Aware) */}
            <div className="w-[350px] flex-shrink-0 border-l border-border bg-card h-full overflow-hidden">
                <CopilotPane
                    html={fullHtml}
                    onHtmlChange={handleCopilotUpdate}
                />
            </div>
        </div>
    )
}
</file>

<file path="app/actions/campaigns.ts">
"use server"

import { createClient } from "@/lib/supabase/server"
import { revalidatePath } from "next/cache"
import { redirect } from "next/navigation"

export async function createCampaign(prevState: any, formData: FormData) {
    const supabase = await createClient()
    const name = formData.get("name") as string

    if (!name || name.trim() === "") {
        return { error: "Campaign name is required" }
    }

    const { data, error } = await supabase
        .from("campaigns")
        .insert([
            {
                name: name.trim(),
                status: "draft",
                subject_line: "",
            },
        ])
        .select()
        .single()

    if (error) {
        console.error("Error creating campaign:", error)
        return { error: error.message }
    }

    revalidatePath("/campaigns")
    return { data }
}

export async function getCampaigns() {
    const supabase = await createClient()
    const { data, error } = await supabase
        .from("campaigns")
        .select("id, name, status, created_at, updated_at, total_recipients, total_opens, total_clicks, average_read_time")
        .order("created_at", { ascending: false })

    if (error) {
        console.error("Error fetching campaigns:", error)
        return []
    }

    return data || []
}

export async function getCampaignList() {
    const supabase = await createClient()
    const { data, error } = await supabase
        .from("campaigns")
        .select("id, name, status, created_at")
        .order("created_at", { ascending: false })

    if (error) {
        console.error("Error fetching campaign list:", error)
        return []
    }

    return data || []
}

export async function duplicateCampaign(campaignId: string) {
    const supabase = await createClient()

    // 1. Fetch original campaign
    const { data: original, error: fetchError } = await supabase
        .from("campaigns")
        .select("*")
        .eq("id", campaignId)
        .single()

    if (fetchError || !original) {
        console.error("Error fetching campaign to duplicate:", fetchError)
        return { error: "Failed to fetch original campaign" }
    }

    // 2. Create new campaign with copied data
    const { data, error: insertError } = await supabase
        .from("campaigns")
        .insert([
            {
                name: `Copy of ${original.name}`,
                status: "draft",
                subject_line: original.subject_line,
                html_content: original.html_content,
                variable_values: original.variable_values,
            },
        ])
        .select()
        .single()

    if (insertError) {
        console.error("Error duplicating campaign:", insertError)
        return { error: insertError.message }
    }

    revalidatePath("/campaigns")
    return { data }
}

export async function createCampaignForTag(tagName: string) {
    const supabase = await createClient()

    const { data, error } = await supabase
        .from("campaigns")
        .insert([
            {
                name: `Campaign for ${tagName}`,
                status: "draft",
                subject_line: `(Draft) Update for ${tagName}`,
                html_content: "",
            },
        ])
        .select()
        .single()

    if (error) {
        console.error("Error creating campaign for tag:", error)
        return { error: error.message }
    }

    revalidatePath("/campaigns")
    return { data }
}

export async function createCampaignForSubscriber(subscriberId: string, email: string, name: string) {
    const supabase = await createClient()

    const { data, error } = await supabase
        .from("campaigns")
        .insert([
            {
                name: `Campaign for ${name || email}`,
                status: "draft",
                subject_line: `(Draft) Message for ${name || email}`,
                html_content: "",
                variable_values: {
                    subscriber_id: subscriberId // Store this to lock targeting later if needed
                }
            },
        ])
        .select()
        .single()

    if (error) {
        console.error("Error creating campaign for subscriber:", error)
        return { error: error.message }
    }

    revalidatePath("/campaigns")
    return { data }
}

export async function duplicateCampaignForSubscriber(campaignId: string, subscriberId: string, subscriberEmail: string) {
    const supabase = await createClient()

    // 1. Fetch original campaign
    const { data: original, error: fetchError } = await supabase
        .from("campaigns")
        .select("*")
        .eq("id", campaignId)
        .single()

    if (fetchError || !original) {
        console.error("Error fetching campaign to duplicate:", fetchError)
        return { error: "Failed to fetch original campaign" }
    }

    // 2. Create new campaign copy with subscriber lock
    const { data, error: insertError } = await supabase
        .from("campaigns")
        .insert([
            {
                // Clean up the name to avoid stacking "Copy of Copy of... (for ...)"
                name: `${original.name.replace(/^(Copy of\s+)+/, "").replace(/\s+\(for\s+.*\)$/, "")} (for ${subscriberEmail})`,
                status: "draft",
                subject_line: original.subject_line,
                html_content: original.html_content,
                variable_values: {
                    ...original.variable_values,
                    subscriber_id: subscriberId
                },
            },
        ])
        .select()
        .single()

    if (insertError) {
        console.error("Error duplicating campaign for subscriber:", insertError)
        return { error: insertError.message }
    }

    revalidatePath("/campaigns")
    return { data }
}

export async function deleteCampaign(campaignId: string) {
    const supabase = await createClient()

    const { error } = await supabase
        .from("campaigns")
        .delete()
        .eq("id", campaignId)

    if (error) {
        console.error("Error deleting campaign:", error)
        return { error: error.message }
    }

    revalidatePath("/campaigns")
    return { success: true }
}
</file>

<file path="components/editor/email-editor.tsx">
"use client"

import { useState, useMemo, useCallback, useRef } from "react"
import { AssetLoader } from "./asset-loader"
import { CodePane } from "./code-pane"
import { PreviewPane } from "./preview-pane"
import { CopilotPane } from "./copilot-pane"
import { CampaignPicker } from "./campaign-picker"
import { renderTemplate } from "@/lib/render-template"
import { Monitor, Smartphone, Loader2, Check, PanelRightClose, PanelRightOpen, ArrowLeft } from "lucide-react"
import { cn } from "@/lib/utils"
import Link from "next/link"
import { useSearchParams } from "next/navigation"
import { Panel, PanelGroup, PanelResizeHandle, ImperativePanelHandle } from "react-resizable-panels"

interface EmailEditorProps {
    html: string
    assets: Record<string, string>
    subjectLine: string
    fromName: string
    fromEmail: string
    onHtmlChange: (html: string) => void
    onAssetsChange: (assets: Record<string, string>) => void
    onSubjectChange: (value: string) => void
    onSenderChange: (field: "name" | "email", value: string) => void
    campaignName: string
    onNameChange: (name: string) => void
    onSave?: () => void
}

export function EmailEditor({
    html,
    assets,
    subjectLine,
    fromName,
    fromEmail,
    onHtmlChange,
    onAssetsChange,
    onSubjectChange,
    onSenderChange,
    campaignName,
    onNameChange,
    onSave
}: EmailEditorProps) {
    const [viewMode, setViewMode] = useState<'desktop' | 'mobile'>('desktop')
    const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'success'>('idle')
    const [isCopilotOpen, setIsCopilotOpen] = useState(true)
    const copilotRef = useRef<ImperativePanelHandle>(null)
    const searchParams = useSearchParams()
    const currentId = searchParams.get("id")

    const extractedVariables = useMemo(() => {
        const regex = /\{\{(\w+)\}\}/g
        const matches: string[] = []
        let match
        while ((match = regex.exec(html)) !== null) {
            if (!matches.includes(match[1])) matches.push(match[1])
        }
        return matches
    }, [html])

    const updateAsset = useCallback((key: string, value: string) => {
        onAssetsChange({ ...assets, [key]: value })
    }, [assets, onAssetsChange])

    const previewHtml = useMemo(() => {
        return renderTemplate(html, assets)
    }, [html, assets])

    const handleSaveClick = async () => {
        if (!onSave) return

        setSaveStatus('saving')

        // Execute the parent's save logic
        await Promise.resolve(onSave())

        // Show success for 2 seconds
        setSaveStatus('success')
        setTimeout(() => setSaveStatus('idle'), 2000)
    }

    const toggleCopilot = () => {
        const panel = copilotRef.current
        if (panel) {
            if (isCopilotOpen) {
                panel.collapse()
            } else {
                panel.expand()
            }
        }
    }

    return (
        <div className="h-screen bg-background text-foreground overflow-hidden">
            <PanelGroup direction="horizontal">
                {/* Left Sidebar - Asset Loader */}
                <Panel defaultSize={15} minSize={12} maxSize={25} className="bg-background border-r border-border">
                    <div className="h-full flex flex-col">
                        {/* Header Link */}
                        <div className="p-3 border-b border-border">
                            <Link href="/" className="inline-flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors">
                                <ArrowLeft className="w-3 h-3" />
                                Back to Dashboard
                            </Link>
                        </div>

                        {/* Campaign Settings */}
                        <div className="p-4 border-b border-border bg-muted/20 space-y-3">
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-semibold text-muted-foreground">Subject Line</label>
                                <input
                                    type="text"
                                    value={subjectLine}
                                    onChange={(e) => onSubjectChange(e.target.value)}
                                    className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                                    placeholder="Enter subject line..."
                                />
                            </div>
                            <div className="grid grid-cols-1 gap-2">
                                <div className="space-y-1">
                                    <label className="text-[10px] uppercase font-semibold text-muted-foreground">From Name</label>
                                    <input
                                        type="text"
                                        value={fromName}
                                        onChange={(e) => onSenderChange("name", e.target.value)}
                                        className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                                        placeholder="Lionel Yu"
                                    />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-[10px] uppercase font-semibold text-muted-foreground">From Email</label>
                                    <input
                                        type="text"
                                        value={fromEmail}
                                        onChange={(e) => onSenderChange("email", e.target.value)}
                                        className="w-full bg-background border border-border rounded px-2 py-1 text-xs focus:outline-none focus:border-primary"
                                        placeholder="lionel@..."
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto">
                            <AssetLoader variables={extractedVariables} assets={assets} onUpdateAsset={updateAsset} showBackButton={false} />
                        </div>
                    </div>
                </Panel>

                <PanelResizeHandle className="w-1 bg-border hover:bg-primary/20 transition-colors" />

                {/* Center Left - Code Pane */}
                <Panel defaultSize={30} minSize={20} className="bg-background border-r border-border">
                    <div className="h-full overflow-hidden">
                        <CodePane code={html} onChange={onHtmlChange} className="h-full" />
                    </div>
                </Panel>

                <PanelResizeHandle className="w-1 bg-border hover:bg-primary/20 transition-colors" />

                {/* Center Right - Preview Pane */}
                <Panel defaultSize={35} minSize={25} className="bg-background flex flex-col">
                    <div className="h-full flex flex-col overflow-hidden">
                        <div className="h-14 border-b border-border flex items-center justify-between px-4 bg-card flex-shrink-0">
                            <h2 className="text-sm font-semibold">Preview</h2>

                            <div className="flex items-center gap-2">
                                {/* View Toggle */}
                                <div className="flex bg-muted p-1 rounded-lg">
                                    <button
                                        onClick={() => setViewMode('desktop')}
                                        className={cn(
                                            "p-1.5 rounded-md transition-all",
                                            viewMode === 'desktop' ? "bg-background shadow-sm text-foreground" : "text-muted-foreground hover:text-foreground"
                                        )}
                                        title="Desktop View"
                                    >
                                        <Monitor className="w-4 h-4" />
                                    </button>
                                    <button
                                        onClick={() => setViewMode('mobile')}
                                        className={cn(
                                            "p-1.5 rounded-md transition-all",
                                            viewMode === 'mobile' ? "bg-background shadow-sm text-foreground" : "text-muted-foreground hover:text-foreground"
                                        )}
                                        title="Mobile View"
                                    >
                                        <Smartphone className="w-4 h-4" />
                                    </button>
                                </div>

                                {/* Campaign Name Editing */}
                                <div className="flex items-center gap-2 border-l border-border pl-2 mr-2">
                                    <input
                                        type="text"
                                        value={campaignName}
                                        onChange={(e) => onNameChange(e.target.value)}
                                        className="bg-transparent border-none text-sm font-medium focus:outline-none focus:ring-1 focus:ring-primary/30 rounded px-2 w-[180px] text-foreground placeholder:text-muted-foreground"
                                        placeholder="Campaign Name"
                                    />
                                </div>

                                {/* Open Campaign */}
                                <CampaignPicker currentId={currentId} editorType="classic" />

                                {/* Save Button */}
                                {onSave && (
                                    <button
                                        type="button"
                                        onClick={handleSaveClick}
                                        disabled={saveStatus === 'saving'}
                                        className={cn(
                                            "px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-2",
                                            saveStatus === 'success'
                                                ? "bg-green-600 text-white hover:bg-green-700"
                                                : "bg-primary text-primary-foreground hover:bg-primary/90"
                                        )}
                                    >
                                        {saveStatus === 'saving' && <Loader2 className="w-4 h-4 animate-spin" />}
                                        {saveStatus === 'success' && <Check className="w-4 h-4" />}

                                        {saveStatus === 'idle' && "Save Campaign"}
                                        {saveStatus === 'saving' && "Saving..."}
                                        {saveStatus === 'success' && "Saved!"}
                                    </button>
                                )}

                                {/* Copilot Toggle */}
                                <button
                                    onClick={toggleCopilot}
                                    className={cn(
                                        "p-2 rounded-md transition-all text-sm font-medium border ml-2",
                                        isCopilotOpen
                                            ? "bg-muted text-muted-foreground hover:text-foreground border-transparent"
                                            : "bg-primary/10 text-primary border-primary/20 hover:bg-primary/20"
                                    )}
                                    title={isCopilotOpen ? "Hide Copilot" : "Show Copilot"}
                                >
                                    {isCopilotOpen ? <PanelRightClose className="w-4 h-4" /> : <PanelRightOpen className="w-4 h-4" />}
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto bg-[#0f0f10] p-8">
                            <div className="h-fit min-h-[500px] mx-auto transition-all duration-300 bg-white shadow-lg my-8" style={{ maxWidth: viewMode === 'mobile' ? '375px' : '600px' }}>
                                <PreviewPane html={previewHtml} viewMode={viewMode} />
                            </div>
                        </div>
                    </div>
                </Panel>

                <PanelResizeHandle className={cn("w-1 bg-border hover:bg-primary/20 transition-colors", !isCopilotOpen && "hidden")} />

                {/* Right Sidebar - Copilot */}
                <Panel
                    ref={copilotRef}
                    defaultSize={20}
                    minSize={15}
                    maxSize={30}
                    collapsible={true}
                    collapsedSize={0}
                    onCollapse={() => setIsCopilotOpen(false)}
                    onExpand={() => setIsCopilotOpen(true)}
                    className={cn(
                        "bg-card border-l border-border transition-all duration-300 ease-in-out",
                        !isCopilotOpen && "border-none"
                    )}
                >
                    <div className="h-full overflow-hidden">
                        <CopilotPane html={html} onHtmlChange={onHtmlChange} />
                    </div>
                </Panel>
            </PanelGroup>
        </div>
    )
}
</file>

<file path="app/(dashboard)/audience/page.tsx">
"use client"

import { useState, useMemo, useEffect } from "react"
import {
    Users,
    Search,
    Filter,
    Download,
    Upload,
    Plus,
    MoreHorizontal,
    Pencil,
    Trash2,
    X,
    UserCheck,
    UserX,
    LayoutGrid,
    List,
    Check,
    ChevronsUpDown,
    Send,
    Copy,
    Loader2,
} from "lucide-react"
import { cn } from "@/lib/utils"
import { Avatar, AvatarFallback } from "@/components/ui/avatar"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { Card, CardContent } from "@/components/ui/card"
import { Checkbox } from "@/components/ui/checkbox"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { TagGroupView } from "@/components/audience/tag-group-view"
import {
    DropdownMenu,
    DropdownMenuCheckboxItem,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
} from "@/components/ui/dialog"
import { ScrollArea } from "@/components/ui/scroll-area"
import {
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog"
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
} from "@/components/ui/alert-dialog"
import {
    Command,
    CommandEmpty,
    CommandGroup,
    CommandInput,
    CommandItem,
    CommandList,
    CommandSeparator,
} from "@/components/ui/command"
import {
    Popover,
    PopoverContent,
    PopoverTrigger,
} from "@/components/ui/popover"
import { Sheet, SheetContent, SheetDescription, SheetHeader, SheetTitle } from "@/components/ui/sheet"
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table"
import { createClient } from "@/lib/supabase/client"
import { createCampaignForSubscriber, getCampaignList, duplicateCampaignForSubscriber } from "@/app/actions/campaigns"
import { useRouter } from "next/navigation"
import { Subscriber, Campaign } from "@/lib/types"
import { useToast } from "@/hooks/use-toast"

const allTags = ["Admin", "Piano", "Student", "Theory", "VIP", "Beginner", "Advanced"]

const tagColors: Record<string, string> = {
    Admin: "bg-red-500/20 text-red-400 border-red-500/30",
    Piano: "bg-blue-500/20 text-blue-400 border-blue-500/30",
    Student: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30",
    Theory: "bg-purple-500/20 text-purple-400 border-purple-500/30",
    VIP: "bg-amber-500/20 text-amber-400 border-amber-500/30",
    Beginner: "bg-cyan-500/20 text-cyan-400 border-cyan-500/30",
    Advanced: "bg-orange-500/20 text-orange-400 border-orange-500/30",
}

const statusStyles: Record<string, string> = {
    active: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30",
    bounced: "bg-red-500/20 text-red-400 border-red-500/30",
    unsubscribed: "bg-zinc-500/20 text-zinc-400 border-zinc-500/30",
}

function getInitials(firstName: string, lastName: string): string {
    return `${(firstName || "").charAt(0)}${(lastName || "").charAt(0)}`.toUpperCase()
}

function formatDate(dateString: string): string {
    if (!dateString) return ""
    return new Date(dateString).toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
    })
}

export default function AudienceManagerPage() {
    const [subscribers, setSubscribers] = useState<Subscriber[]>([])
    const [loading, setLoading] = useState(true)
    const [searchQuery, setSearchQuery] = useState("")
    const [selectedTags, setSelectedTags] = useState<string[]>([])
    const [selectedIds, setSelectedIds] = useState<string[]>([])
    const [isDrawerOpen, setIsDrawerOpen] = useState(false)
    const [isNewSubscriber, setIsNewSubscriber] = useState(false)
    const [isDeleteAlertOpen, setIsDeleteAlertOpen] = useState(false)
    const [subscriberToDelete, setSubscriberToDelete] = useState<string | null>(null)
    const [viewMode, setViewMode] = useState<"list" | "tags">("list")
    const [tagComboboxOpen, setTagComboboxOpen] = useState(false)

    // Send Existing Campaign State
    const [isSelectCampaignOpen, setIsSelectCampaignOpen] = useState(false)
    const [targetSubscriber, setTargetSubscriber] = useState<Subscriber | null>(null)
    const [existingCampaigns, setExistingCampaigns] = useState<Campaign[]>([])
    const [loadingCampaigns, setLoadingCampaigns] = useState(false)
    const [duplicating, setDuplicating] = useState(false)

    // Form State
    const [formData, setFormData] = useState<Partial<Subscriber>>({
        email: "",
        first_name: "",
        last_name: "",
        tags: [],
        status: "active",
    })
    const [newTag, setNewTag] = useState("")
    const [saving, setSaving] = useState(false)

    const supabase = createClient()
    const { toast } = useToast()
    const router = useRouter()

    // Fetch Subscribers
    const fetchSubscribers = async () => {
        setLoading(true)
        const { data, error } = await supabase
            .from("subscribers")
            .select("id, email, first_name, last_name, tags, status, created_at")
            .order("created_at", { ascending: false })

        if (data) {
            setSubscribers(data as Subscriber[])
        } else if (error) {
            console.error("Error fetching subscribers:", error)
            toast({
                title: "Error fetching subscribers",
                description: error.message,
                variant: "destructive",
            })
        }
        setLoading(false)
    }

    useEffect(() => {
        fetchSubscribers()
    }, [])

    // Stats
    const stats = useMemo(() => {
        const total = subscribers.length
        const active = subscribers.filter((s) => s.status === "active").length
        const unsubscribed = subscribers.filter((s) => s.status === "unsubscribed").length
        return { total, active, unsubscribed }
    }, [subscribers])

    // Filtered subscribers
    const filteredSubscribers = useMemo(() => {
        return subscribers.filter((subscriber) => {
            const matchesSearch =
                subscriber.email.toLowerCase().includes(searchQuery.toLowerCase()) ||
                (subscriber.first_name || "").toLowerCase().includes(searchQuery.toLowerCase()) ||
                (subscriber.last_name || "").toLowerCase().includes(searchQuery.toLowerCase())

            const subscriberTags = subscriber.tags || []
            const matchesTags = selectedTags.length === 0 || selectedTags.some((tag) => subscriberTags.includes(tag))

            return matchesSearch && matchesTags
        })
    }, [subscribers, searchQuery, selectedTags])

    // Derived unique tags for the dropdown
    const availableTags = useMemo(() => {
        const subscriberTags = new Set<string>()
        subscribers.forEach(sub => sub.tags?.forEach(t => subscriberTags.add(t)))
        // Add defaults
        allTags.forEach(t => subscriberTags.add(t))
        return Array.from(subscriberTags).sort()
    }, [subscribers])

    const handleTagToggle = (tag: string) => {
        setSelectedTags((prev) => (prev.includes(tag) ? prev.filter((t) => t !== tag) : [...prev, tag]))
    }

    const handleSelectAll = () => {
        if (selectedIds.length === filteredSubscribers.length) {
            setSelectedIds([])
        } else {
            setSelectedIds(filteredSubscribers.map((s) => s.id))
        }
    }

    const handleSelectOne = (id: string) => {
        setSelectedIds((prev) => (prev.includes(id) ? prev.filter((i) => i !== id) : [...prev, id]))
    }

    const handleEdit = (subscriber: Subscriber) => {
        setFormData(subscriber)
        setIsNewSubscriber(false)
        setIsDrawerOpen(true)
    }

    const handleAddSubscriber = () => {
        setFormData({
            email: "",
            first_name: "",
            last_name: "",
            tags: [],
            status: "active",
        })
        setIsNewSubscriber(true)
        setIsDrawerOpen(true)
    }

    const handleSave = async () => {
        setSaving(true)
        const payload = {
            email: formData.email,
            first_name: formData.first_name,
            last_name: formData.last_name,
            tags: formData.tags || [],
            status: formData.status,
        }

        let error

        if (isNewSubscriber) {
            const { error: insertError } = await supabase
                .from("subscribers")
                .insert([payload])
            error = insertError
        } else if (formData.id) {
            const { error: updateError } = await supabase
                .from("subscribers")
                .update(payload)
                .eq("id", formData.id)
            error = updateError
        }

        if (error) {
            toast({
                title: "Error saving subscriber",
                description: error.message,
                variant: "destructive",
            })
        } else {
            toast({
                title: isNewSubscriber ? "Subscriber added" : "Subscriber updated",
                description: "The changes have been saved successfully.",
            })
            setIsDrawerOpen(false)
            fetchSubscribers()
        }
        setSaving(false)
    }

    const handleDelete = async (id: string) => {
        const { error } = await supabase.from("subscribers").delete().eq("id", id)

        if (error) {
            toast({
                title: "Error deleting subscriber",
                description: error.message,
                variant: "destructive",
            })
        } else {
            toast({
                title: "Subscriber deleted",
                description: "The subscriber has been removed.",
            })
            // Optimistic update or refresh
            setSubscribers((prev) => prev.filter((s) => s.id !== id))
            setSelectedIds((prev) => prev.filter((i) => i !== id))
        }
    }

    const handleBulkDelete = async () => {
        if (selectedIds.length === 0) return

        const { error } = await supabase
            .from("subscribers")
            .delete()
            .in("id", selectedIds)

        if (error) {
            toast({
                title: "Error deleting subscribers",
                description: error.message,
                variant: "destructive",
            })
        } else {
            toast({
                title: "Subscribers deleted",
                description: `${selectedIds.length} subscribers have been removed.`,
            })
            setSubscribers((prev) => prev.filter((s) => !selectedIds.includes(s.id)))
            setSelectedIds([])
        }
        setIsDeleteAlertOpen(false)
    }

    const confirmDelete = (id: string) => {
        setSubscriberToDelete(id)
        setIsDeleteAlertOpen(true)
    }

    const handleConfirmDelete = () => {
        if (subscriberToDelete) {
            handleDelete(subscriberToDelete)
            setSubscriberToDelete(null)
            setIsDeleteAlertOpen(false)
        } else {
            handleBulkDelete()
        }
    }

    const handleAddTag = (tagToAdd: string) => {
        const tag = tagToAdd.trim()
        const currentTags = formData.tags || []
        if (tag && !currentTags.includes(tag)) {
            setFormData({ ...formData, tags: [...currentTags, tag] })
            setNewTag("")
            setTagComboboxOpen(false)
        }
    }

    const handleRemoveTag = (tagToRemove: string) => {
        const currentTags = formData.tags || []
        setFormData({ ...formData, tags: currentTags.filter((tag) => tag !== tagToRemove) })
    }

    const handleSendToSubscriber = async (subscriber: Subscriber) => {
        try {
            const name = subscriber.first_name
                ? `${subscriber.first_name} ${subscriber.last_name || ''}`.trim()
                : ''

            const result = await createCampaignForSubscriber(subscriber.id, subscriber.email, name)

            if (result.error) {
                throw new Error(result.error)
            }

            toast({
                title: "Personal Campaign Created",
                description: `Draft for ${subscriber.email} created. Redirecting...`,
            })

            if (result.data?.id) {
                router.push(`/editor?id=${result.data.id}`)
            }
        } catch (error: any) {
            toast({
                title: "Error creating campaign",
                description: error.message,
                variant: "destructive",
            })
        }
    }

    const handleOpenSelectCampaign = async (subscriber: Subscriber) => {
        setTargetSubscriber(subscriber)
        setIsSelectCampaignOpen(true)
        setLoadingCampaigns(true)

        try {
            const campaigns = await getCampaignList()
            setExistingCampaigns(campaigns as Campaign[])
        } catch (error) {
            console.error("Failed to load campaigns", error)
            toast({ title: "Error loading campaigns", variant: "destructive" })
        } finally {
            setLoadingCampaigns(false)
        }
    }

    const handleSelectCampaign = async (campaign: Campaign) => {
        if (!targetSubscriber) return

        setDuplicating(true)
        try {
            const name = targetSubscriber.first_name
                ? `${targetSubscriber.first_name} ${targetSubscriber.last_name || ''}`.trim()
                : targetSubscriber.email

            const result = await duplicateCampaignForSubscriber(campaign.id, targetSubscriber.id, name)

            if (result.error) {
                throw new Error(result.error)
            }

            toast({
                title: "Campaign Duplicated",
                description: `Created copy of "${campaign.name}" for ${targetSubscriber.email}. Redirecting...`,
            })

            if (result.data?.id) {
                router.push(`/dashboard/${result.data.id}`)
            }
            setIsSelectCampaignOpen(false)
        } catch (error: any) {
            toast({
                title: "Error duplicating campaign",
                description: error.message,
                variant: "destructive",
            })
        } finally {
            setDuplicating(false)
        }
    }

    const allSelected = filteredSubscribers.length > 0 && selectedIds.length === filteredSubscribers.length
    const someSelected = selectedIds.length > 0 && selectedIds.length < filteredSubscribers.length

    return (
        <div className="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
            {/* Header */}
            <div className="mb-8">
                <div className="flex items-center gap-3 mb-2">
                    <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-500/10">
                        <Users className="h-5 w-5 text-amber-500" />
                    </div>
                    <h1 className="text-2xl font-bold text-foreground">Audience Manager</h1>
                </div>
                <p className="text-muted-foreground">
                    Manage your subscribers, tags, and segmentation for your email campaigns.
                </p>
            </div>

            {/* Stats */}
            <div className="grid gap-4 md:grid-cols-3 mb-8">
                <Card className="bg-card border-border">
                    <CardContent className="flex items-center gap-4 p-6">
                        <div className="flex h-12 w-12 items-center justify-center rounded-full bg-amber-500/10">
                            <Users className="h-6 w-6 text-amber-500" />
                        </div>
                        <div>
                            <p className="text-sm text-muted-foreground">Total Subscribers</p>
                            <p className="text-3xl font-bold text-foreground">{stats.total.toLocaleString()}</p>
                        </div>
                    </CardContent>
                </Card>

                <Card className="bg-card border-border">
                    <CardContent className="flex items-center gap-4 p-6">
                        <div className="flex h-12 w-12 items-center justify-center rounded-full bg-emerald-500/10">
                            <UserCheck className="h-6 w-6 text-emerald-500" />
                        </div>
                        <div>
                            <p className="text-sm text-muted-foreground">Active</p>
                            <p className="text-3xl font-bold text-foreground">{stats.active.toLocaleString()}</p>
                        </div>
                    </CardContent>
                </Card>

                <Card className="bg-card border-border">
                    <CardContent className="flex items-center gap-4 p-6">
                        <div className="flex h-12 w-12 items-center justify-center rounded-full bg-zinc-500/10">
                            <UserX className="h-6 w-6 text-zinc-500" />
                        </div>
                        <div>
                            <p className="text-sm text-muted-foreground">Unsubscribed</p>
                            <p className="text-3xl font-bold text-foreground">{stats.unsubscribed.toLocaleString()}</p>
                        </div>
                    </CardContent>
                </Card>
            </div>

            {/* Toolbar */}
            <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-6">
                <div className="flex flex-1 items-center gap-3">
                    <div className="relative flex-1 max-w-sm">
                        <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
                        <Input
                            placeholder="Search by email or name..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="pl-9 bg-card border-border"
                        />
                    </div>

                    <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                            <Button variant="outline" className="gap-2 border-border bg-transparent">
                                <Filter className="h-4 w-4" />
                                Filter by Tag
                                {selectedTags.length > 0 && (
                                    <span className="ml-1 rounded-full bg-amber-500 px-2 py-0.5 text-xs text-zinc-900">
                                        {selectedTags.length}
                                    </span>
                                )}
                            </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="start" className="w-48">
                            {allTags.map((tag) => (
                                <DropdownMenuCheckboxItem
                                    key={tag}
                                    checked={selectedTags.includes(tag)}
                                    onCheckedChange={() => handleTagToggle(tag)}
                                >
                                    {tag}
                                </DropdownMenuCheckboxItem>
                            ))}
                        </DropdownMenuContent>
                    </DropdownMenu>

                    <div className="h-8 w-px bg-border mx-2 hidden sm:block" />

                    <Tabs value={viewMode} onValueChange={(v) => setViewMode(v as "list" | "tags")} className="w-[180px]">
                        <TabsList className="grid w-full grid-cols-2">
                            <TabsTrigger value="list" className="gap-2">
                                <List className="h-4 w-4" />
                                <span className="sr-only sm:not-sr-only">List</span>
                            </TabsTrigger>
                            <TabsTrigger value="tags" className="gap-2">
                                <LayoutGrid className="h-4 w-4" />
                                <span className="sr-only sm:not-sr-only">Tags</span>
                            </TabsTrigger>
                        </TabsList>
                    </Tabs>
                </div>

                <div className="flex items-center gap-2">
                    {selectedIds.length > 0 ? (
                        <>
                            <Button variant="ghost" onClick={() => setSelectedIds([])}>
                                Cancel ({selectedIds.length})
                            </Button>
                            <Button variant="destructive" onClick={() => setIsDeleteAlertOpen(true)} className="gap-2">
                                <Trash2 className="h-4 w-4" />
                                Delete Selected
                            </Button>
                        </>
                    ) : (
                        <>
                            <Button variant="ghost" className="gap-2">
                                <Download className="h-4 w-4" />
                                Export
                            </Button>
                            <Button variant="secondary" className="gap-2">
                                <Upload className="h-4 w-4" />
                                Import CSV
                            </Button>
                            <Button onClick={handleAddSubscriber} className="gap-2 bg-amber-500 text-zinc-900 hover:bg-amber-400">
                                <Plus className="h-4 w-4" />
                                Add Subscriber
                            </Button>
                        </>
                    )}
                </div>
            </div>

            {/* Content */}
            {viewMode === "list" && (
                <div className="rounded-lg border border-border bg-card">
                    <Table>
                        <TableHeader>
                            <TableRow className="border-border hover:bg-transparent">
                                <TableHead className="w-12">
                                    <Checkbox
                                        checked={allSelected}
                                        ref={(el) => {
                                            if (el) {
                                                const element = el as HTMLButtonElement & { indeterminate: boolean }
                                                element.indeterminate = someSelected
                                            }
                                        }}
                                        onCheckedChange={handleSelectAll}
                                    />
                                </TableHead>
                                <TableHead>Profile</TableHead>
                                <TableHead className="w-[100px]"></TableHead>
                                <TableHead>Tags</TableHead>
                                <TableHead>Status</TableHead>
                                <TableHead>Added</TableHead>
                                <TableHead className="w-12">Actions</TableHead>
                            </TableRow>
                        </TableHeader>
                        <TableBody>
                            {loading ? (
                                <TableRow>
                                    <TableCell colSpan={6} className="text-center py-10 text-muted-foreground">
                                        Loading subscribers...
                                    </TableCell>
                                </TableRow>
                            ) : filteredSubscribers.length === 0 ? (
                                <TableRow>
                                    <TableCell colSpan={6} className="text-center py-10 text-muted-foreground">
                                        No subscribers found.
                                    </TableCell>
                                </TableRow>
                            ) : (
                                filteredSubscribers.map((subscriber) => (
                                    <TableRow
                                        key={subscriber.id}
                                        className="border-border cursor-pointer hover:bg-muted/50"
                                        onClick={() => router.push(`/audience/${subscriber.id}`)}
                                    >
                                        <TableCell onClick={(e) => e.stopPropagation()}>
                                            <Checkbox
                                                checked={selectedIds.includes(subscriber.id)}
                                                onCheckedChange={() => handleSelectOne(subscriber.id)}
                                            />
                                        </TableCell>
                                        <TableCell>
                                            <div className="flex items-center gap-3">
                                                <Avatar className="h-9 w-9 border border-border">
                                                    <AvatarFallback className="bg-muted text-muted-foreground text-sm">
                                                        {getInitials(subscriber.first_name, subscriber.last_name)}
                                                    </AvatarFallback>
                                                </Avatar>
                                                <div>
                                                    <p className="font-medium text-foreground">{subscriber.email}</p>
                                                    <p className="text-sm text-muted-foreground">
                                                        {subscriber.first_name} {subscriber.last_name}
                                                    </p>
                                                </div>
                                            </div>
                                        </TableCell>
                                        <TableCell onClick={(e) => e.stopPropagation()}>
                                            <div className="flex items-center gap-1">
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    className="h-8 w-8 text-muted-foreground hover:text-foreground"
                                                    onClick={(e) => {
                                                        e.stopPropagation()
                                                        handleEdit(subscriber)
                                                    }}
                                                >
                                                    <Pencil className="h-4 w-4" />
                                                    <span className="sr-only">Edit</span>
                                                </Button>
                                                <Button
                                                    variant="ghost"
                                                    size="icon"
                                                    className="h-8 w-8 text-muted-foreground hover:text-red-400"
                                                    onClick={(e) => {
                                                        e.stopPropagation()
                                                        confirmDelete(subscriber.id)
                                                    }}
                                                >
                                                    <Trash2 className="h-4 w-4" />
                                                    <span className="sr-only">Delete</span>
                                                </Button>
                                            </div>
                                        </TableCell>
                                        <TableCell>
                                            <div className="flex flex-wrap gap-1.5">
                                                {(subscriber.tags || []).length > 0 ? (
                                                    (subscriber.tags || []).map((tag) => (
                                                        <Badge
                                                            key={tag}
                                                            variant="outline"
                                                            className={tagColors[tag] || "bg-muted text-muted-foreground"}
                                                        >
                                                            {tag}
                                                        </Badge>
                                                    ))
                                                ) : (
                                                    <span className="text-xs text-muted-foreground">-</span>
                                                )}
                                            </div>
                                        </TableCell>
                                        <TableCell>
                                            <Badge variant="outline" className={statusStyles[subscriber.status] || "bg-muted"}>
                                                {subscriber.status.charAt(0).toUpperCase() + subscriber.status.slice(1)}
                                            </Badge>
                                        </TableCell>
                                        <TableCell className="text-muted-foreground">{formatDate(subscriber.created_at)}</TableCell>
                                        <TableCell onClick={(e) => e.stopPropagation()}>
                                            <div className="flex items-center justify-end gap-2">
                                                <DropdownMenu>
                                                    <DropdownMenuTrigger asChild>
                                                        <Button
                                                            variant="ghost"
                                                            size="icon"
                                                            className="h-8 w-8 text-muted-foreground hover:text-amber-500 hover:bg-amber-500/10"
                                                        >
                                                            <Send className="h-4 w-4" />
                                                        </Button>
                                                    </DropdownMenuTrigger>
                                                    <DropdownMenuContent align="end">
                                                        <DropdownMenuItem onClick={(e) => {
                                                            e.stopPropagation()
                                                            handleSendToSubscriber(subscriber)
                                                        }}>
                                                            <Pencil className="mr-2 h-4 w-4" />
                                                            Draft New Campaign
                                                        </DropdownMenuItem>
                                                        <DropdownMenuItem onClick={(e) => {
                                                            e.stopPropagation()
                                                            handleOpenSelectCampaign(subscriber)
                                                        }}>
                                                            <Copy className="mr-2 h-4 w-4" />
                                                            Send Existing Campaign
                                                        </DropdownMenuItem>
                                                    </DropdownMenuContent>
                                                </DropdownMenu>
                                            </div>
                                        </TableCell>
                                    </TableRow>
                                ))
                            )}
                        </TableBody>
                    </Table>
                </div>
            )
            }

            {
                viewMode === "tags" && (
                    <TagGroupView subscribers={filteredSubscribers} />
                )
            }

            {/* Edit Drawer */}
            <Sheet open={isDrawerOpen} onOpenChange={setIsDrawerOpen}>
                <SheetContent className="w-full sm:max-w-lg overflow-y-auto">
                    <SheetHeader>
                        <SheetTitle>{isNewSubscriber ? "Add Subscriber" : "Edit Subscriber"}</SheetTitle>
                        <SheetDescription>
                            {isNewSubscriber ? "Add a new subscriber to your audience." : "Update subscriber details."}
                        </SheetDescription>
                    </SheetHeader>

                    <div className="mt-6 space-y-6">
                        {/* Personal Details */}
                        <div className="space-y-4">
                            <h3 className="text-sm font-medium text-foreground">Personal Details</h3>

                            <div className="space-y-2">
                                <Label htmlFor="email">Email</Label>
                                <Input
                                    id="email"
                                    type="email"
                                    value={formData.email}
                                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                    placeholder="subscriber@example.com"
                                    className="bg-card"
                                />
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <Label htmlFor="firstName">First Name</Label>
                                    <Input
                                        id="firstName"
                                        value={formData.first_name}
                                        onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                                        placeholder="John"
                                        className="bg-card"
                                    />
                                </div>
                                <div className="space-y-2">
                                    <Label htmlFor="lastName">Last Name</Label>
                                    <Input
                                        id="lastName"
                                        value={formData.last_name}
                                        onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                                        placeholder="Doe"
                                        className="bg-card"
                                    />
                                </div>
                            </div>

                            <div className="space-y-2">
                                <Label htmlFor="status">Status</Label>
                                <div className="flex gap-2">
                                    {['active', 'unsubscribed', 'bounced'].map((s) => (
                                        <Button
                                            key={s}
                                            type="button"
                                            variant={formData.status === s ? "default" : "outline"}
                                            size="sm"
                                            onClick={() => setFormData({ ...formData, status: s as any })}
                                            className="capitalize"
                                        >
                                            {s}
                                        </Button>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Tag Manager */}
                        <div className="space-y-4">
                            <h3 className="text-sm font-medium text-foreground">Tag Manager</h3>

                            <div className="flex gap-2 items-start">
                                <Popover open={tagComboboxOpen} onOpenChange={setTagComboboxOpen}>
                                    <PopoverTrigger asChild>
                                        <Button
                                            variant="outline"
                                            role="combobox"
                                            aria-expanded={tagComboboxOpen}
                                            className="justify-between w-full bg-card"
                                        >
                                            Add a tag...
                                            <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                                        </Button>
                                    </PopoverTrigger>
                                    <PopoverContent className="p-0" align="start">
                                        <Command>
                                            <CommandInput
                                                placeholder="Search tags..."
                                                value={newTag}
                                                onValueChange={setNewTag}
                                                onKeyDown={(e) => {
                                                    if (e.key === "Enter" && newTag.trim()) {
                                                        e.preventDefault()
                                                        handleAddTag(newTag)
                                                    }
                                                }}
                                            />
                                            <CommandList>
                                                <CommandEmpty>
                                                    <button
                                                        className="flex w-full items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-accent hover:text-accent-foreground cursor-pointer"
                                                        onClick={() => handleAddTag(newTag)}
                                                    >
                                                        <Plus className="h-4 w-4" />
                                                        Create "{newTag}"
                                                    </button>
                                                </CommandEmpty>
                                                <CommandGroup heading="Existing Tags">
                                                    {availableTags.map((tag) => (
                                                        <CommandItem
                                                            key={tag}
                                                            value={tag}
                                                            onSelect={(currentValue) => {
                                                                handleAddTag(currentValue)
                                                            }}
                                                            className="cursor-pointer"
                                                        >
                                                            <Check
                                                                className={cn(
                                                                    "mr-2 h-4 w-4",
                                                                    (formData.tags || []).includes(tag) ? "opacity-100" : "opacity-0"
                                                                )}
                                                            />
                                                            {tag}
                                                        </CommandItem>
                                                    ))}
                                                </CommandGroup>
                                            </CommandList>
                                        </Command>
                                    </PopoverContent>
                                </Popover>
                            </div>

                            <div className="flex flex-wrap gap-2">
                                {(formData.tags || []).length > 0 ? (
                                    (formData.tags || []).map((tag) => (
                                        <Badge
                                            key={tag}
                                            variant="outline"
                                            className={`${tagColors[tag] || "bg-muted text-muted-foreground"} pr-1`}
                                        >
                                            {tag}
                                            <button
                                                onClick={() => handleRemoveTag(tag)}
                                                className="ml-1 rounded-full p-0.5 hover:bg-foreground/10"
                                            >
                                                <X className="h-3 w-3" />
                                                <span className="sr-only">Remove {tag} tag</span>
                                            </button>
                                        </Badge>
                                    ))
                                ) : (
                                    <p className="text-sm text-muted-foreground">No tags added yet</p>
                                )}
                            </div>
                        </div>

                        {/* Actions */}
                        <div className="flex gap-3 pt-4">
                            <Button variant="outline" onClick={() => setIsDrawerOpen(false)} className="flex-1 bg-transparent">
                                Cancel
                            </Button>
                            <Button onClick={handleSave} disabled={saving} className="flex-1 bg-amber-500 text-zinc-900 hover:bg-amber-400">
                                {saving ? "Saving..." : (isNewSubscriber ? "Add Subscriber" : "Save Changes")}
                            </Button>
                        </div>
                    </div>
                </SheetContent>
            </Sheet>

            <AlertDialog open={isDeleteAlertOpen} onOpenChange={setIsDeleteAlertOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>Are you absolutely sure?</AlertDialogTitle>
                        <AlertDialogDescription>
                            This action cannot be undone. This will permanently delete {subscriberToDelete
                                ? "this subscriber"
                                : `${selectedIds.length} subscriber${selectedIds.length === 1 ? '' : 's'}`
                            }.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel onClick={() => setSubscriberToDelete(null)}>Cancel</AlertDialogCancel>
                        <AlertDialogAction onClick={handleConfirmDelete} className="bg-red-600 hover:bg-red-700">
                            Delete
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>

            {/* Select Campaign Dialog */}
            <Dialog open={isSelectCampaignOpen} onOpenChange={setIsSelectCampaignOpen}>
                <DialogContent className="sm:max-w-md">
                    <DialogHeader>
                        <DialogTitle>Send Existing Campaign</DialogTitle>
                        <DialogDescription>
                            Select a campaign to duplicate and send to {targetSubscriber?.email}.
                        </DialogDescription>
                    </DialogHeader>

                    <div className="py-4">
                        {loadingCampaigns ? (
                            <div className="flex justify-center py-8">
                                <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                            </div>
                        ) : existingCampaigns.length === 0 ? (
                            <p className="text-center text-muted-foreground py-8">No campaigns found.</p>
                        ) : (
                            <ScrollArea className="h-[300px] pr-4">
                                <div className="space-y-2">
                                    {existingCampaigns.map(campaign => (
                                        <div
                                            key={campaign.id}
                                            onClick={() => !duplicating && handleSelectCampaign(campaign)}
                                            className={cn(
                                                "p-3 rounded-lg border border-border cursor-pointer hover:bg-accent transition-colors",
                                                duplicating && "opacity-50 pointer-events-none"
                                            )}
                                        >
                                            <div className="space-y-2">
                                                <h4 className="font-medium text-sm text-foreground line-clamp-2 break-words">{campaign.name}</h4>
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    {campaign.subject_line && (
                                                        <Badge variant="secondary" className="text-xs max-w-[200px] truncate font-normal">
                                                            {campaign.subject_line}
                                                        </Badge>
                                                    )}
                                                    <Badge
                                                        variant="outline"
                                                        className={cn(
                                                            "text-xs shrink-0",
                                                            campaign.status === 'draft' && "bg-zinc-500/10 text-zinc-400 border-zinc-500/30",
                                                            campaign.status === 'active' && "bg-blue-500/10 text-blue-400 border-blue-500/30",
                                                            campaign.status === 'completed' && "bg-emerald-500/10 text-emerald-400 border-emerald-500/30"
                                                        )}
                                                    >
                                                        {campaign.status}
                                                    </Badge>
                                                </div>
                                            </div>
                                            <p className="text-[10px] text-muted-foreground mt-2">
                                                Created: {formatDate(campaign.created_at)}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </ScrollArea>
                        )}
                    </div>
                </DialogContent>
            </Dialog>
        </div >
    )
}
</file>

<file path="app/api/copilot/route.ts">
import { createClient } from "@supabase/supabase-js";
import { GoogleGenerativeAI } from "@google/generative-ai";
import Anthropic from "@anthropic-ai/sdk";
import { NextResponse } from "next/server";

// Initialize Admin Client (Service Key) to bypass RLS if needed
const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
);

// Keep existing helper
function cleanJson(text: string) {
    return text.replace(/```json/g, "").replace(/```/g, "").trim();
}

// Helper: Download image from URL and convert to Base64
async function urlToBase64(url: string) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to fetch image: ${response.statusText}`);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = Buffer.from(arrayBuffer);
        const base64 = buffer.toString('base64');
        const mediaType = response.headers.get('content-type') || 'image/jpeg';
        return { base64, mediaType };
    } catch (e) {
        console.error("Image fetch failed", e);
        return null;
    }
}

export async function POST(req: Request) {
    try {
        const { currentHtml, messages, model } = await req.json();

        // 1. FETCH CONTEXT FROM DB ⚡️
        const { data: setting } = await supabase
            .from('app_settings')
            .select('value')
            .eq('key', 'company_context')
            .single();

        // Fallback if DB is empty
        const dynamicContext = setting?.value || "Product: DreamPlay One. Feature: Narrow Keys.";

        // 2. Process History: Convert ALL image URLs to Base64
        // We do this server-side so we don't hit the 4MB payload limit from the client.
        // We only keep the last 3 messages' images to save tokens/money, but we keep ALL text.
        const processedMessages = await Promise.all(messages.map(async (msg: any, index: number) => {
            const isRecent = index >= messages.length - 3; // Only keep images from last 3 messages

            let processedImages: any[] = [];

            if (isRecent && msg.imageUrls && msg.imageUrls.length > 0) {
                // Parallel download
                const downloads = await Promise.all(msg.imageUrls.map((url: string) => urlToBase64(url)));
                processedImages = downloads.filter(img => img !== null);
            }

            return {
                role: msg.role,
                content: msg.content,
                images: processedImages // Now contains { base64, mediaType }
            };
        }));

        const systemInstruction = `
    You are an expert Email HTML Developer.
    The user will give you HTML and a request.
    
    ### 🛑 CRITICAL INTEGRITY RULES:
    1. **NEVER DELETE CONTENT:** Unless explicitly asked to remove something, you must PRESERVE all existing sections, text, and images.
    2. **ADDING SECTIONS = FULL HTML:** If the user asks to "add", "insert", or "create" a new section/row/block, you MUST return the **COMPLETE HTML DOCUMENT** (starting with <!DOCTYPE html>). Do not return just the snippet, or the system will overwrite the wrong block.
    3. **EDITING TEXT = SNIPPET:** Only if the user asks to typo-fix or rephrase *specific text inside the current block*, should you return just that HTML block. When in doubt, RETURN THE FULL HTML.
    
    ### CODING STANDARDS:
    1. **LAYOUT:** Use HTML <table>, <tr>, <td> for structure. No Flexbox/Grid.
    2. **WIDTHS:** Explicitly set width="100%" or specific pixels.
    3. **VARIABLES:** Preserve {{mustache_vars}}.
    
    ### RESPONSE FORMAT:
    { "explanation": "brief summary of changes", "updatedHtml": "<html>...</html>" }
    
    ### COMPANY CONTEXT:
    ${dynamicContext}
    `;

        let rawResponse = "";

        // --- A. CLAUDE (Anthropic) ---
        if (model.includes("claude")) {
            const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

            const anthropicMessages = processedMessages.map((msg: any) => {
                const role = (msg.role === 'result' ? 'assistant' : 'user') as "assistant" | "user";
                let content: any[] = [];

                // Add Images
                if (msg.images) {
                    msg.images.forEach((img: any) => {
                        content.push({
                            type: "image",
                            source: {
                                type: "base64",
                                media_type: img.mediaType,
                                data: img.base64
                            }
                        });
                    });
                }

                // Add Text
                if (msg.content) content.push({ type: "text", text: msg.content });

                return { role, content };
            });

            // Append Context to Last Message
            const lastMsg = anthropicMessages[anthropicMessages.length - 1];
            if (lastMsg.role === 'user') {
                lastMsg.content.push({ type: "text", text: `\n\n### CURRENT HTML:\n${currentHtml}` });
            }

            const msg = await anthropic.messages.create({
                model: model, // Use the model passed from frontend
                max_tokens: 8192,
                temperature: 0,
                system: systemInstruction,
                messages: anthropicMessages
            });

            const textBlock = msg.content[0];
            if (textBlock.type === 'text') rawResponse = textBlock.text;
        }

        // --- B. GEMINI (Google) ---
        else {
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
            const geminiModel = genAI.getGenerativeModel({
                model: "gemini-1.5-pro",
                generationConfig: { responseMimeType: "application/json" }
            });

            const geminiHistory = processedMessages.map((msg: any) => {
                const role = msg.role === 'result' ? 'model' : 'user';
                const parts = [];

                if (msg.images) {
                    msg.images.forEach((img: any) => {
                        parts.push({
                            inlineData: {
                                mimeType: img.mediaType,
                                data: img.base64
                            }
                        });
                    });
                }

                if (msg.content) parts.push({ text: msg.content });
                return { role, parts };
            });

            const lastMsg = geminiHistory[geminiHistory.length - 1];
            lastMsg.parts.push({ text: `\n\n### CURRENT HTML:\n${currentHtml}` });

            // Inject system instruction into first message
            if (geminiHistory.length > 0) {
                const firstPart = geminiHistory[0].parts[0];
                if (firstPart.text) {
                    firstPart.text = `${systemInstruction}\n\n${firstPart.text}`;
                } else {
                    geminiHistory[0].parts.unshift({ text: systemInstruction });
                }
            }

            const result = await geminiModel.generateContent({ contents: geminiHistory });
            rawResponse = result.response.text();
        }

        // --- PARSE ---
        try {
            const cleaned = cleanJson(rawResponse);
            return NextResponse.json(JSON.parse(cleaned));
        } catch (e) {
            return NextResponse.json({ updatedHtml: currentHtml, explanation: rawResponse });
        }

    } catch (error: any) {
        console.error("API Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="components/editor/copilot-pane.tsx">
"use client"

import { useState, useRef, useEffect } from "react"
import { Sparkles, Send, X, Zap, Brain, Bot, Paperclip, Loader2 } from "lucide-react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { cn } from "@/lib/utils"
import { createClient } from "@/lib/supabase/client" // Ensure you have this client helper

interface Message {
    role: "user" | "details" | "result"
    content: string
    // We now store URLs instead of base64 to save memory
    imageUrls?: string[]
}

interface CopilotPaneProps {
    html: string
    onHtmlChange: (html: string, prompt: string) => void
}

import { getAnthropicModels } from "@/app/actions/ai-models"

export function CopilotPane({ html, onHtmlChange }: CopilotPaneProps) {
    const [selectedModel, setSelectedModel] = useState("claude-3-5-sonnet-20240620")
    const [availableModels, setAvailableModels] = useState<string[]>([])

    useEffect(() => {
        getAnthropicModels().then(models => {
            if (models.length > 0) {
                setAvailableModels(models)
                // If current selection isn't in list, switch to the first available one (usually the newest)
                if (!models.includes(selectedModel) && !selectedModel.includes("gemini")) {
                    setSelectedModel(models[0])
                }
            }
        })
    }, [])

    // We keep a "real" history with full context for the API
    const [messages, setMessages] = useState<Message[]>([
        { role: "result", content: "I'm ready. Upload screenshots or reference images and I'll adapt the code." },
    ])

    const [input, setInput] = useState("")
    const [isUploading, setIsUploading] = useState(false)
    const [pendingAttachments, setPendingAttachments] = useState<string[]>([]) // URLs
    const [isLoading, setIsLoading] = useState(false)
    const scrollRef = useRef<HTMLDivElement>(null)
    const fileInputRef = useRef<HTMLInputElement>(null)
    const supabase = createClient()

    // Auto-scroll to bottom
    useEffect(() => {
        if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight
        }
    }, [messages, isLoading, pendingAttachments])

    const uploadFile = async (file: File) => {
        setIsUploading(true)
        try {
            // 1. Unique path: chat-uploads/{timestamp}-{filename}
            const path = `chat-uploads/${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '')}`

            // 2. Direct upload to Supabase Storage (Bypasses Vercel Limit)
            const { data, error } = await supabase.storage
                .from('chat-assets')
                .upload(path, file)

            if (error) throw error

            // 3. Get Public URL
            const { data: publicUrlData } = supabase.storage
                .from('chat-assets')
                .getPublicUrl(path)

            setPendingAttachments(prev => [...prev, publicUrlData.publicUrl])
        } catch (error) {
            console.error("Upload failed:", error)
            setMessages(prev => [...prev, { role: 'result', content: `❌ Failed to upload image: ${file.name}` }])
        } finally {
            setIsUploading(false)
        }
    }

    const handlePaste = (e: React.ClipboardEvent) => {
        const items = e.clipboardData.items
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf("image") !== -1) {
                e.preventDefault()
                const file = items[i].getAsFile()
                if (file) uploadFile(file)
            }
        }
    }

    const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files.length > 0) {
            Array.from(e.target.files).forEach(file => uploadFile(file))
        }
    }

    const handleSendMessage = async () => {
        if ((!input.trim() && pendingAttachments.length === 0) || isLoading || isUploading) return

        const userMessage = input.trim()
        const attachments = [...pendingAttachments]

        // Clear input immediately
        setInput("")
        setPendingAttachments([])

        // 1. Add to UI state
        const newMessage: Message = {
            role: "user",
            content: userMessage,
            imageUrls: attachments
        }

        // Append to local history
        const newHistory = [...messages, newMessage]
        setMessages(newHistory)
        setIsLoading(true)

        try {
            // 2. Send to API (Now lightweight because we only send URLs!)
            const response = await fetch("/api/copilot", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    currentHtml: html,
                    messages: newHistory, // We can safely send the whole history now!
                    model: selectedModel
                }),
            })

            const data = await response.json()

            if (!response.ok) throw new Error(data.error || "Failed to generate code")

            if (data.updatedHtml) {
                onHtmlChange(data.updatedHtml, userMessage)
            }

            setMessages(prev => [
                ...prev,
                { role: "result", content: data.explanation || "Done." }
            ])

        } catch (error: any) {
            console.error("Copilot Error:", error)
            setMessages(prev => [
                ...prev,
                { role: "result", content: `Error: ${error.message}` }
            ])
        } finally {
            setIsLoading(false)
        }
    }

    return (
        <div className="flex flex-col h-full border-l border-border bg-card text-card-foreground">
            {/* Header */}
            <div className="h-14 border-b border-border flex items-center px-4 gap-2 justify-between shrink-0 bg-background/50 backdrop-blur">
                <div className="flex items-center gap-2">
                    <Sparkles className="w-4 h-4 text-purple-400" />
                    <h2 className="text-sm font-semibold">Copilot Vision</h2>
                </div>
                <Select value={selectedModel} onValueChange={setSelectedModel}>
                    <SelectTrigger className="w-[180px] h-8 text-xs bg-muted/50 border-transparent hover:border-border">
                        <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                        {/* Dynamic Anthropic Models */}
                        {availableModels.map(model => (
                            <SelectItem key={model} value={model}>{model}</SelectItem>
                        ))}

                        {/* Fallback hardcoded if fetch failed */}
                        {availableModels.length === 0 && (
                            <SelectItem value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet (Legacy)</SelectItem>
                        )}

                        <SelectItem value="gemini-1.5-pro">Gemini 1.5 Pro</SelectItem>
                    </SelectContent>
                </Select>
            </div>

            {/* Messages */}
            <div className="flex-1 overflow-y-auto p-4 space-y-6" ref={scrollRef}>
                {messages.map((msg, index) => (
                    <div key={index} className={cn("flex flex-col gap-2 max-w-[90%]", msg.role === "user" ? "ml-auto items-end" : "mr-auto items-start")}>
                        {/* Render Images */}
                        {msg.imageUrls && msg.imageUrls.length > 0 && (
                            <div className="flex flex-wrap gap-2 mb-1 justify-end">
                                {msg.imageUrls.map((url, i) => (
                                    <div key={i} className="relative group overflow-hidden rounded-lg border border-border">
                                        <img src={url} alt="attachment" className="h-24 w-auto object-cover" />
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* Render Text */}
                        {msg.content && (
                            <div className={cn(
                                "p-3 rounded-2xl text-sm whitespace-pre-wrap leading-relaxed",
                                msg.role === "user"
                                    ? "bg-primary text-primary-foreground rounded-br-sm"
                                    : "bg-muted text-foreground rounded-bl-sm"
                            )}>
                                {msg.content}
                            </div>
                        )}
                    </div>
                ))}
                {isLoading && (
                    <div className="mr-auto flex items-center gap-2 text-muted-foreground text-sm p-2">
                        <Brain className="w-4 h-4 animate-pulse" />
                        Thinking...
                    </div>
                )}
            </div>

            {/* Input Area */}
            <div className="p-4 border-t border-border mt-auto shrink-0 bg-background/50 backdrop-blur">
                {/* Pending Uploads */}
                {(pendingAttachments.length > 0 || isUploading) && (
                    <div className="flex gap-2 overflow-x-auto pb-3">
                        {pendingAttachments.map((url, i) => (
                            <div key={i} className="relative group shrink-0">
                                <img src={url} className="h-14 w-14 rounded-md object-cover border border-border" />
                                <button
                                    onClick={() => setPendingAttachments(prev => prev.filter((_, idx) => idx !== i))}
                                    className="absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity"
                                >
                                    <X className="w-3 h-3" />
                                </button>
                            </div>
                        ))}
                        {isUploading && (
                            <div className="h-14 w-14 rounded-md border border-dashed border-muted-foreground/50 flex items-center justify-center bg-muted/20">
                                <Loader2 className="w-5 h-5 animate-spin text-muted-foreground" />
                            </div>
                        )}
                    </div>
                )}

                <div className="flex gap-2 items-end">
                    <input
                        type="file"
                        multiple
                        accept="image/*"
                        className="hidden"
                        ref={fileInputRef}
                        onChange={handleFileSelect}
                    />
                    <Button
                        variant="ghost"
                        size="icon"
                        className="shrink-0 text-muted-foreground hover:text-foreground"
                        onClick={() => fileInputRef.current?.click()}
                        disabled={isUploading || isLoading}
                    >
                        <Paperclip className="w-5 h-5" />
                    </Button>

                    <Input
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        onKeyDown={(e) => e.key === "Enter" && !e.shiftKey && handleSendMessage()}
                        onPaste={handlePaste}
                        placeholder="Type a message..."
                        className="flex-1 min-h-[40px]"
                        disabled={isLoading}
                        autoFocus
                    />

                    <Button
                        size="icon"
                        onClick={handleSendMessage}
                        disabled={isLoading || (!input.trim() && pendingAttachments.length === 0)}
                        className={cn(isLoading && "opacity-50")}
                    >
                        <Send className="w-4 h-4" />
                    </Button>
                </div>
            </div>
        </div>
    )
}
</file>

<file path="app/api/send/route.ts">
import { createClient } from "@supabase/supabase-js";
import { NextResponse } from "next/server";
import { Resend } from "resend";

const resend = new Resend(process.env.RESEND_API_KEY);

// ⚡️ CRITICAL CHANGE: We use the SERVICE_KEY (Admin) instead of the ANON_KEY.
// This allows the backend to read your Campaign data without needing the user's cookies.
const supabase = createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_KEY!
);

export async function POST(request: Request) {
    try {
        const body = await request.json();
        const { campaignId, type, email, fromName, fromEmail } = body;

        // 1. Fetch Campaign (Admin Access - No 404s!)
        const { data: campaign, error: campaignError } = await supabase
            .from("campaigns")
            .select("*")
            .eq("id", campaignId)
            .single();

        if (campaignError || !campaign) {
            console.error("Supabase Error:", campaignError);
            return NextResponse.json({ error: "Campaign not found" }, { status: 404 });
        }

        // 2. The Compiler: Replace {{variables}}
        let htmlContent = campaign.html_content || "";
        const variables = campaign.variable_values || {};

        // Replace standard variables
        Object.keys(variables).forEach((key) => {
            const regex = new RegExp(`{{${key}}}`, "g");
            htmlContent = htmlContent.replace(regex, variables[key]);
        });

        // 3. Send Logic
        if (type === "test") {
            if (!email) return NextResponse.json({ error: "Test email required" }, { status: 400 });

            // ⚡️ NEW: Fetch a "Simulated" Subscriber to populate merge tags
            // If the campaign is locked to a specific subscriber (your "CRM mode"), use them.
            // Otherwise, just grab the most recent active subscriber to use as a "dummy".
            let simulationSubscriber = null;
            const lockedSubscriberId = campaign.variable_values?.subscriber_id;

            if (lockedSubscriberId) {
                const { data } = await supabase
                    .from("subscribers")
                    .select("*")
                    .eq("id", lockedSubscriberId)
                    .single();
                simulationSubscriber = data;
            } else {
                // Just grab the latest person to test layout with real data length/formatting
                const { data } = await supabase
                    .from("subscribers")
                    .select("*")
                    .eq("status", "active")
                    .limit(1)
                    .single();
                simulationSubscriber = data;
            }

            // ⚡️ NEW: Run the EXACT same replacement logic as broadcast
            let finalHtml = htmlContent;
            if (simulationSubscriber) {
                finalHtml = finalHtml
                    .replace(/{{first_name}}/g, simulationSubscriber.first_name || "There")
                    .replace(/{{last_name}}/g, simulationSubscriber.last_name || "")
                    .replace(/{{email}}/g, simulationSubscriber.email);
            } else {
                // Fallback if your list is completely empty
                finalHtml = finalHtml
                    .replace(/{{first_name}}/g, "[Test Name]")
                    .replace(/{{email}}/g, "test@example.com");
            }

            console.log("🚀 Sending Test Email...");
            console.log("FROM:", `DreamPlay <hello@email.dreamplaypianos.com>`);
            console.log("TO:", email);

            const { data, error } = await resend.emails.send({
                from: "DreamPlay <hello@email.dreamplaypianos.com>",
                to: email,
                subject: `[TEST] ${campaign.subject_line}`,
                html: finalHtml,
            });

            if (error) {
                // 🛑 THIS PRINTS THE REAL ERROR TO YOUR TERMINAL
                console.error("❌ RESEND FAILED:", JSON.stringify(error, null, 2));

                // This ensures the frontend gets a 500 error instead of a fake 200 OK
                return NextResponse.json({ error: error.message }, { status: 500 });
            }

            console.log("✅ Email sent successfully!", data);
            return NextResponse.json({ success: true, data });
        }

        else if (type === "broadcast") {
            // 1. Check for a "Subscriber Lock" (The feature you built in actions/campaigns.ts)
            const lockedSubscriberId = campaign.variable_values?.subscriber_id;

            let query = supabase.from("subscribers").select("*").eq("status", "active");

            // 2. If locked, ONLY fetch that one subscriber. Otherwise fetch everyone.
            if (lockedSubscriberId) {
                query = query.eq("id", lockedSubscriberId);
            }

            const { data: recipients, error: subError } = await query;
            if (subError || !recipients) throw subError;

            // 3. Loop and Send (For small batches, a simple loop is fine. For >1000, use Resend Batch API)
            console.log(`🚀 Starting broadcast to ${recipients.length} subscribers...`);

            let successCount = 0;
            let failureCount = 0;
            let firstErrorMessage = "";
            const sentRecords: { campaign_id: string; subscriber_id: string; sent_at: string; variant_sent: string | null }[] = [];

            // Run the sending loop
            await Promise.all(recipients.map(async (sub) => {
                // Personalize
                const baseUrl = process.env.NEXT_PUBLIC_APP_URL || "https://email.dreamplaypianos.com"

                // Helper to wrap links for tracking
                const wrapLinks = (html: string, campaignId: string, subscriberId: string) => {
                    return html.replace(/href=(["'])([^"']+)\1/g, (match, quote, url) => {
                        // Don't wrap mailto, tel, or anchors
                        if (url.startsWith("mailto:") || url.startsWith("tel:") || url.startsWith("#")) {
                            return match
                        }

                        // Encode the target URL
                        const encodedUrl = encodeURIComponent(url)
                        const trackingUrl = `${baseUrl}/api/track/click?u=${encodedUrl}&c=${campaignId}&s=${subscriberId}`

                        return `href=${quote}${trackingUrl}${quote}`
                    })
                }

                let personalHtml = htmlContent
                    .replace(/{{first_name}}/g, sub.first_name || "")
                    .replace(/{{email}}/g, sub.email)

                // 2. Wrap Links for Click Tracking
                personalHtml = wrapLinks(personalHtml, campaignId, sub.id)

                // 3. Inject Open Tracking Pixel at the bottom
                const trackingPixel = `<img src="${baseUrl}/api/track/open?c=${campaignId}&s=${sub.id}" width="1" height="1" style="display:none;" alt="" />`
                if (personalHtml.includes("</body>")) {
                    personalHtml = personalHtml.replace("</body>", `${trackingPixel}</body>`)
                } else {
                    personalHtml += trackingPixel
                }

                const { error } = await resend.emails.send({
                    from: typeof fromName === 'string' && typeof fromEmail === 'string'
                        ? `${fromName} <${fromEmail}>`
                        : process.env.RESEND_FROM_EMAIL || "onboarding@resend.dev",
                    to: sub.email,
                    subject: campaign.subject_line,
                    html: personalHtml,
                    replyTo: fromEmail,
                });

                if (error) {
                    console.error(`❌ Failed: ${sub.email}`, error);
                    failureCount++;
                    if (!firstErrorMessage) firstErrorMessage = error.message; // Capture the first reason
                } else {
                    successCount++;
                    // Track successful send for sent_history
                    sentRecords.push({
                        campaign_id: campaignId,
                        subscriber_id: sub.id,
                        sent_at: new Date().toISOString(),
                        variant_sent: campaign.subject_line || null
                    });
                }
            }));

            // 4. Insert sent_history records (batch insert for performance)
            if (sentRecords.length > 0) {
                const { error: historyError } = await supabase
                    .from("sent_history")
                    .insert(sentRecords);

                if (historyError) {
                    console.error("❌ Failed to insert sent_history:", historyError);
                } else {
                    console.log(`📊 Logged ${sentRecords.length} sends to sent_history`);
                }
            }

            // 5. Update Campaign Status
            const { error: updateError } = await supabase.from("campaigns").update({
                status: "completed",
                total_audience_size: recipients.length
            }).eq("id", campaignId);

            if (updateError) {
                console.error("❌ Failed to update campaign status:", updateError);
            } else {
                console.log(`✅ Campaign status updated to 'completed'`);
            }

            // ⚡️ NEW: Return the actual score card
            if (failureCount > 0) {
                return NextResponse.json({
                    success: false,
                    message: `Sent ${successCount}, Failed ${failureCount}. Reason: ${firstErrorMessage}`
                }, { status: 500 }); // Return 500 so the UI knows it failed
            }

            return NextResponse.json({
                success: true,
                message: `Successfully sent to ${successCount} subscribers`
            });
        }

        return NextResponse.json({ error: "Invalid Type" }, { status: 400 });

    } catch (error: any) {
        console.error("Server Error:", error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

</files>
